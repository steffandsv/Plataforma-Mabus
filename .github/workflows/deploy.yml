name: Deploy Plataforma Mabus

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 2222 
          script: |
            TARGET_DIR="/opt/plataforma-mabus"
            echo "${{ secrets.PASSWORD }}" | sudo -S mkdir -p $TARGET_DIR
            echo "${{ secrets.PASSWORD }}" | sudo -S chown -R $USER:$USER $TARGET_DIR
            cd $TARGET_DIR
            
            REPO_URL="https://steffandsv:${{ secrets.GH_PAT }}@github.com/steffandsv/plataforma-mabus.git"
            
            if [ ! -d ".git" ]; then
              git clone $REPO_URL .
            else
              git remote set-url origin $REPO_URL
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            fi
            
            # --- CORREÇÃO DO ERRO "IS A DIRECTORY" ---
            # Remove se for diretório (criado errado pelo Docker) e cria arquivo vazio
            if [ -d "cookies.json" ]; then rm -rf cookies.json; fi
            if [ ! -f "cookies.json" ]; then touch cookies.json; fi
            
            if [ -d "proxies.txt" ]; then rm -rf proxies.txt; fi
            if [ ! -f "proxies.txt" ]; then touch proxies.txt; fi
            
            # --- CRIAÇÃO DO .ENV ---
            echo "DB_HOST=${{ secrets.DB_HOST }}" > .env
            echo "DB_DB=${{ secrets.DB_DB }}" >> .env
            echo "DB_USER=${{ secrets.DB_USER }}" >> .env
            echo "DB_PASS=${{ secrets.DB_PASS }}" >> .env
            echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
            echo "GOOGLE_SEARCH_API_KEY=${{ secrets.GOOGLE_SEARCH_API_KEY }}" >> .env
            echo "GOOGLE_SEARCH_CX=${{ secrets.GOOGLE_SEARCH_CX }}" >> .env
            echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" >> .env
            echo "PERPLEXITY_API_KEY=${{ secrets.PERPLEXITY_API_KEY }}" >> .env
            echo "COOKIES_B64=${{ secrets.COOKIES_B64 }}" >> .env
            echo "PORT=3000" >> .env
            
            echo "${{ secrets.PASSWORD }}" | sudo -S docker compose down
            echo "${{ secrets.PASSWORD }}" | sudo -S docker compose --env-file .env up -d --build --remove-orphans
            echo "${{ secrets.PASSWORD }}" | sudo -S docker image prune -f
