<%- include('partials/head') %>
    <%- include('partials/header') %>

        <div class="container mx-auto px-4 py-8">
            <!-- Header with View Switcher -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <h1
                    class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-primary via-secondary to-accent bg-clip-text text-transparent">
                    üèõÔ∏è <%= savedMode ? 'Licita√ß√µes Salvas' : 'Licita√ß√µes Personalizadas' %>
                </h1>

                <div class="flex flex-wrap gap-2 items-center">
                    <!-- View Mode Toggle -->
                    <div class="btn-group">
                        <button
                            class="btn btn-sm <%= viewMode === 'story' ? 'btn-active btn-primary' : 'btn-outline' %>"
                            onclick="switchView('story')">
                            <i class="fas fa-mobile-alt"></i>
                            <span class="hidden sm:inline ml-1">Story</span>
                        </button>
                        <button class="btn btn-sm <%= viewMode === 'grid' ? 'btn-active btn-primary' : 'btn-outline' %>"
                            onclick="switchView('grid')">
                            <i class="fas fa-th"></i>
                            <span class="hidden sm:inline ml-1">Grid</span>
                        </button>
                    </div>

                    <% if (!savedMode) { %>
                        <a href="/licitacoes/saved" class="btn btn-sm btn-ghost gap-1">
                            <i class="fas fa-heart"></i>
                            <span class="hidden sm:inline">Salvos</span>
                        </a>
                        <% } %>

                            <a href="/profile/preferences" class="btn btn-sm btn-outline gap-1">
                                <i class="fas fa-cog"></i>
                                <span class="hidden sm:inline">Prefer√™ncias</span>
                            </a>

                            <% if (user && user.role==='admin' ) { %>
                                <a href="/admin/licitacoes/import" class="btn btn-sm btn-secondary gap-1">
                                    <i class="fas fa-download"></i>
                                    <span class="hidden sm:inline">Importar</span>
                                </a>
                                <% } %>
                </div>
            </div>

            <!-- Filtros (Collapse in mobile) -->
            <% if (!savedMode) { %>
                <div class="collapse collapse-arrow bg-base-200 mb-6">
                    <input type="checkbox" id="filter-toggle" />
                    <div class="collapse-title font-medium flex items-center gap-2">
                        <i class="fas fa-filter"></i>
                        Filtros Avan√ßados
                        <% if (filters.search || filters.cnpj_orgao || filters.modalidade) { %>
                            <span class="badge badge-primary badge-sm">Ativos</span>
                            <% } %>
                    </div>
                    <div class="collapse-content">
                        <form method="GET" class="pt-2">
                            <input type="hidden" name="view" value="<%= viewMode %>">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text">Buscar no objeto</span></label>
                                    <input type="text" name="search" placeholder="Ex: computadores, notebooks..."
                                        value="<%= filters.search || '' %>" class="input input-bordered input-sm">
                                </div>
                                <div class="form-control">
                                    <label class="label"><span class="label-text">CNPJ do √ìrg√£o</span></label>
                                    <input type="text" name="cnpj" placeholder="00.000.000/0000-00..."
                                        value="<%= filters.cnpj_orgao || '' %>" class="input input-bordered input-sm">
                                </div>
                                <div class="form-control">
                                    <label class="label"><span class="label-text">Modalidade</span></label>
                                    <select name="modalidade" class="select select-bordered select-sm">
                                        <option value="">Todas as Modalidades</option>
                                        <option value="Preg√£o" <%=filters.modalidade==='Preg√£o' ? 'selected' : '' %>
                                            >Preg√£o</option>
                                        <option value="Concorr√™ncia" <%=filters.modalidade==='Concorr√™ncia' ? 'selected'
                                            : '' %>>Concorr√™ncia</option>
                                        <option value="Dispensa" <%=filters.modalidade==='Dispensa' ? 'selected' : '' %>
                                            >Dispensa</option>
                                        <option value="Inexigibilidade" <%=filters.modalidade==='Inexigibilidade'
                                            ? 'selected' : '' %>>Inexigibilidade</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-search"></i> Filtrar
                                </button>
                                <a href="/licitacoes?view=<%= viewMode %>" class="btn btn-ghost btn-sm">Limpar</a>
                            </div>
                        </form>
                    </div>
                </div>
                <% } %>

                    <!-- Story Mode Container -->
                    <div id="story-mode" class="<%= viewMode === 'story' ? '' : 'hidden' %>">
                        <%- include('partials/story_feed', { licitacoes }) %>
                    </div>

                    <!-- Grid Mode Container -->
                    <div id="grid-mode" class="<%= viewMode === 'grid' ? '' : 'hidden' %>">
                        <%- include('partials/grid_view', { licitacoes, preferences }) %>
                    </div>

                    <!-- Pagina√ß√£o -->
                    <% if (licitacoes && licitacoes.length> 0) { %>
                        <div class="flex justify-center gap-2 mt-6">
                            <% const buildUrl=(p)=> {
                                let url = savedMode ? '/licitacoes/saved' : '/licitacoes';
                                url += `?page=${p}&view=${viewMode}`;
                                if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;
                                if (filters.cnpj_orgao) url += `&cnpj=${encodeURIComponent(filters.cnpj_orgao)}`;
                                if (filters.modalidade) url += `&modalidade=${encodeURIComponent(filters.modalidade)}`;
                                return url;
                                } %>

                                <% if (page> 1) { %>
                                    <a href="<%= buildUrl(page - 1) %>" class="btn btn-outline">
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </a>
                                    <% } %>

                                        <span class="btn btn-disabled">P√°gina <%= page %></span>

                                        <% if (hasNext) { %>
                                            <a href="<%= buildUrl(page + 1) %>" class="btn btn-outline">
                                                Pr√≥xima <i class="fas fa-chevron-right"></i>
                                            </a>
                                            <% } %>
                        </div>
                        <% } %>
        </div>

        <script>
            // View Switcher
            function switchView(mode) {
                const url = new URL(window.location);
                url.searchParams.set('view', mode);
                window.location.href = url.toString();
            }

            // Global Save/Unsave Functions
            function saveOpportunity(id) {
                fetch(`/api/licitacoes/${id}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(res => res.json())
                    .then(data => {
                        showToast(data.message || 'üíæ Oportunidade salva!', 'success');
                    })
                    .catch(err => {
                        showToast('‚ùå Erro ao salvar', 'error');
                        console.error(err);
                    });
            }

            function showToast(message, type) {
                const toast = document.createElement('div');
                toast.className = `alert alert-${type} fixed bottom-4 right-4 w-auto max-w-md z-50 shadow-lg animate-bounce`;
                toast.innerHTML = `<span>${message}</span>`;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        </script>

        <%- include('partials/footer') %>