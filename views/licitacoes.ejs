<%- include('partials/head') %>
    <%- include('partials/header') %>

        <!-- Full Screen Feed Layout - THE VOID EDITION -->
        <main class="h-[calc(100vh-6rem)] w-full overflow-hidden relative">

            <!-- Context Header (Top Layer) - Floating Pill -->
            <div class="absolute top-4 left-4 z-50 pointer-events-none">
                <div class="glass-pill">
                    <div class="text-xl">
                        <%= savedMode ? 'üíñ' : 'üèõÔ∏è' %>
                    </div>
                    <div>
                        <h1 class="text-sm font-bold leading-none text-white">
                            <%= savedMode ? 'Salvos' : 'Feed' %>
                        </h1>
                    </div>
                </div>
            </div>

            <!-- Controls (Top Right) - Floating Actions -->
            <div class="absolute top-4 right-4 z-50 flex gap-2 pointer-events-auto">
                <% if (!savedMode) { %>
                    <a href="/licitacoes/saved"
                        class="action-btn w-10 h-10 rounded-full !border-0 bg-white/5 hover:bg-white/10 flex items-center justify-center text-white"
                        title="Ver Salvos">
                        <i class="fas fa-heart text-error"></i>
                    </a>
                    <% } %>
                        <a href="/profile/preferences"
                            class="action-btn w-10 h-10 rounded-full !border-0 bg-white/5 hover:bg-white/10 flex items-center justify-center text-white"
                            title="Prefer√™ncias">
                            <i class="fas fa-cog text-primary"></i>
                        </a>
            </div>

            <!-- Story Mode Container - The Physics Stage -->
            <div id="story-mode" class="h-full w-full">
                <%- include('partials/story_feed', { licitacoes }) %>
            </div>

        </main>

        <script>
            // Global Save/Unsave Functions - Integrated with Toast
            function saveOpportunity(id) {
                fetch(`/api/licitacoes/${id}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(res => res.json())
                    .then(data => {
                        showToast(data.message || 'üíæ Oportunidade salva!', 'success');
                    })
                    .catch(err => {
                        showToast('‚ùå Erro ao salvar', 'error');
                        console.error(err);
                    });
            }

            function showToast(message, type) {
                const toast = document.createElement('div');
                toast.className = `alert alert-${type} fixed bottom-8 left-1/2 -translate-x-1/2 w-auto min-w-[300px] z-[100] shadow-lg animate-bounce rounded-2xl border-0 bg-opacity-90 backdrop-blur text-white font-bold`;
                toast.innerHTML = `<span class="flex items-center gap-2">${message}</span>`;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        </script>

        <!-- Footer Hidden for Immersion -->