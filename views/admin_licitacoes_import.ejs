<%- include('partials/head') %>
    <%- include('partials/header') %>

        <div class="container mx-auto px-4 py-8">
            <div class="mb-6 flex justify-between items-center">
                <a href="/admin/dashboard" class="btn btn-ghost btn-sm">‚Üê Voltar para Admin</a>
                <div class="text-xs text-gray-500 font-mono">Server Time: <%= new Date().toLocaleTimeString() %>
                </div>
            </div>

            <h1 class="text-3xl font-bold mb-6 flex items-center gap-2">
                <span>‚öôÔ∏è</span>
                Importar Licita√ß√µes do PNCP
                <span class="badge badge-primary badge-outline text-xs">Multi-Thread (6x)</span>
            </h1>

            <!-- BATCH MONITOR CONTAINER -->
            <div id="batch-monitor" class="hidden">
                <div class="alert alert-info mb-6 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        class="stroke-current shrink-0 w-6 h-6 animate-pulse">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold text-lg">Importa√ß√£o em Lote Iniciada!</h3>
                        <div class="text-xs font-mono opacity-80" id="batch-id-display">ID: ...</div>
                    </div>
                </div>

                <!-- AGGREGATED STATS -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="stats shadow bg-base-100">
                        <div class="stat">
                            <div class="stat-title text-xs uppercase tracking-wider">Jobs (Dias)</div>
                            <div class="stat-value text-primary" id="stat-jobs">0/0</div>
                            <div class="stat-desc" id="stat-jobs-desc">Carregando...</div>
                        </div>
                    </div>

                    <div class="stats shadow bg-base-100">
                        <div class="stat">
                            <div class="stat-title text-xs uppercase tracking-wider">Total Importado</div>
                            <div class="stat-value text-success" id="stat-imported">0</div>
                            <div class="stat-desc">Novas licita√ß√µes</div>
                        </div>
                    </div>

                    <div class="stats shadow bg-base-100">
                        <div class="stat">
                            <div class="stat-title text-xs uppercase tracking-wider">Atualizadas</div>
                            <div class="stat-value text-warning" id="stat-duplicates">0</div>
                            <div class="stat-desc">Registros atualizados</div>
                        </div>
                    </div>

                    <div class="stats shadow bg-base-100">
                        <div class="stat">
                            <div class="stat-title text-xs uppercase tracking-wider">Erros</div>
                            <div class="stat-value text-error" id="stat-errors">0</div>
                            <div class="stat-desc">Falhas na API</div>
                        </div>
                    </div>
                </div>

                <!-- WORKER THREADS LIST -->
                <div class="card bg-base-100 shadow-xl mb-6">
                    <div class="card-body p-4">
                        <h3 class="card-title text-sm mb-4">Threads de Execu√ß√£o (Dias)</h3>
                        <div class="overflow-x-auto">
                            <table class="table table-xs w-full">
                                <thead>
                                    <tr>
                                        <th>Dia</th>
                                        <th>Status</th>
                                        <th>Progresso</th>
                                        <th>Importados</th>
                                        <th>Atualizados</th>
                                    </tr>
                                </thead>
                                <tbody id="workers-list-body">
                                    <!-- Rows injected mainly by JS -->
                                    <tr>
                                        <td colspan="5" class="text-center text-gray-400 py-4">Iniciando workers...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FORM CONTAINER (Hidden if monitoring) -->
            <div id="import-form-container" class="<%= (activeSync && activeSync.batch_id) ? 'hidden' : '' %>">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card bg-base-100 shadow-xl border border-base-200">
                        <div class="card-body">
                            <h2 class="card-title text-2xl mb-4">Nova Importa√ß√£o</h2>

                            <form id="start-import-form">
                                <div class="form-control mb-4">
                                    <label class="label"><span class="label-text font-semibold">Data
                                            Inicial</span></label>
                                    <input type="date" name="dataInicial" required
                                        class="input input-bordered input-primary">
                                </div>

                                <div class="form-control mb-6">
                                    <label class="label"><span class="label-text font-semibold">Data
                                            Final</span></label>
                                    <input type="date" name="dataFinal" required
                                        class="input input-bordered input-primary">
                                </div>

                                <div class="alert alert-warning mb-6 text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6"
                                        fill="none" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                    <div>
                                        <span class="font-bold">Aten√ß√£o:</span> O sistema usar√° <span
                                            class="badge badge-sm badge-neutral">6 Workers</span> simult√¢neos.
                                        Isso consumir√° CPU e Mem√≥ria significativamente.
                                    </div>
                                </div>

                                <button type="submit"
                                    class="btn btn-primary w-full shadow-lg hover:shadow-xl transition-all normal-case text-lg gap-2"
                                    id="btn-submit">
                                    <span>üöÄ</span> Iniciar Importa√ß√£o em Lote
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- LAST SYNC INFO (Legacy/Reference) -->
                    <% if (latestSync && !latestSync.batch_id) { %>
                        <div class="card bg-base-100 shadow-xl opacity-75">
                            <div class="card-body">
                                <h3 class="card-title text-sm opacity-50">√öltima Importa√ß√£o (Legacy)</h3>
                                <div class="text-xs font-mono">
                                    <%= new Date(latestSync.started_at).toLocaleString() %> <br>
                                        Status: <%= latestSync.status %>
                                </div>
                            </div>
                        </div>
                        <% } %>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>
            const formContainer = document.getElementById('import-form-container');
            const batchMonitor = document.getElementById('batch-monitor');
            const form = document.getElementById('start-import-form');
            let pollInterval = null;

    // Initialize if active batch exists
    <% if (activeSync && (activeSync.batch_id || activeSync.status === 'running')) { %>
        const initialBatchId = "<%= activeSync.batch_id %>";
                if (initialBatchId && initialBatchId !== 'null') {
                    startMonitoring(initialBatchId);
                } else {
                    // Probably legacy job running or batch_id missing
                    console.log("Legacy active sync found, no batch ID.");
                }
    <% } %>

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('btn-submit');
                    btn.disabled = true;
                    btn.innerHTML = '<span class="loading loading-spinner"></span> Iniciando...';

                    try {
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());

                        // Explicitly ask for JSON
                        const response = await axios.post('/admin/licitacoes/import', data, {
                            headers: { 'Accept': 'application/json' }
                        });

                        if (response.data.success && response.data.batchId) {
                            startMonitoring(response.data.batchId);
                        } else {
                            alert('Erro: ' + (response.data.message || 'Resposta inv√°lida do servidor'));
                            btn.disabled = false;
                            btn.innerHTML = '<span>üöÄ</span> Iniciar Importa√ß√£o em Lote';
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Falha na requisi√ß√£o: ' + (err.response?.data?.message || err.message));
                        btn.disabled = false;
                        btn.innerHTML = '<span>üöÄ</span> Iniciar Importa√ß√£o em Lote';
                    }
                });

            function startMonitoring(batchId) {
                formContainer.classList.add('hidden');
                batchMonitor.classList.remove('hidden');
                document.getElementById('batch-id-display').textContent = 'ID: ' + batchId;

                // Poll every 2 seconds
                pollBatch(batchId);
                pollInterval = setInterval(() => pollBatch(batchId), 2000);
            }

            async function pollBatch(batchId) {
                try {
                    const res = await axios.get(`/api/licitacoes/batch-status/${batchId}`);
                    if (res.data.success) {
                        updateUI(res.data.data);
                    }
                } catch (e) {
                    console.error("Polling error", e);
                }
            }

            function updateUI(data) {
                // Update Top Stats
                const completed = parseInt(data.completed_jobs) || 0;
                const total = parseInt(data.total_jobs) || 0;
                const running = parseInt(data.running_jobs) || 0;

                document.getElementById('stat-jobs').innerText = `${completed} / ${total}`;
                document.getElementById('stat-jobs-desc').innerText = `${running} rodando`;

                document.getElementById('stat-imported').innerText = data.total_imported || 0;
                document.getElementById('stat-duplicates').innerText = data.total_duplicates || 0;
                document.getElementById('stat-errors').innerText = data.total_errors || 0;

                // Update Workers Table
                const tbody = document.getElementById('workers-list-body');
                tbody.innerHTML = ''; // Clear

                if (data.jobs && data.jobs.length > 0) {
                    data.jobs.forEach(job => {
                        const tr = document.createElement('tr');

                        // Status Badge
                        let badgeClass = 'badge-ghost';
                        if (job.status === 'running') badgeClass = 'badge-info animate-pulse';
                        if (job.status === 'completed') badgeClass = 'badge-success';
                        if (job.status === 'failed') badgeClass = 'badge-error';

                        const percent = job.total_pages > 0 ? Math.round((job.current_page / job.total_pages) * 100) : 0;

                        tr.innerHTML = `
                    <td class="font-mono text-xs font-bold">${job.data_inicial}</td>
                    <td><span class="badge badge-xs ${badgeClass}">${job.status}</span></td>
                    <td>
                        <div class="flex items-center gap-2">
                            <progress class="progress progress-primary w-20" value="${job.current_page}" max="${job.total_pages || 100}"></progress>
                            <span class="text-xs opacity-70">${job.current_page}/${job.total_pages}</span>
                        </div>
                    </td>
                    <td class="font-mono text-success">+${job.total_imported}</td>
                    <td class="font-mono text-warning">~${job.total_duplicates || '-'}</td>
                `;
                        tbody.appendChild(tr);
                    });
                }
            }
        </script>

        <%- include('partials/footer') %>