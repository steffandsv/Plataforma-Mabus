<%- include('partials/head') %>
<%- include('partials/header') %>

<div class="container mx-auto px-4 max-w-5xl py-12">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-4">
        <div>
            <h2 class="text-4xl font-black text-white tracking-tight mb-2">NEURAL CORE CONFIG</h2>
            <p class="text-starlight/60 font-mono text-xs tracking-[0.2em] border-l-2 border-neon-blue pl-3">ARTIFICIAL INTELLIGENCE PARAMETERS</p>
        </div>
        <button type="submit" form="aiConfigForm" class="btn btn-primary rounded-full px-8 shadow-[0_0_20px_rgba(0,240,255,0.4)] text-black font-bold hover:scale-105 transition-transform">
            <i class="fas fa-save mr-2"></i> SAVE CONFIGURATION
        </button>
    </div>

    <form action="/admin/ai-config/save" method="POST" id="aiConfigForm" class="space-y-8">

        <!-- ORACLE (ANALYZER) -->
        <div class="glass-card p-8 rounded-3xl border border-white/10 relative overflow-hidden group hover:border-neon-blue/30 transition-colors">
            <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-30 transition-opacity">
                <i class="fas fa-brain text-6xl text-neon-blue"></i>
            </div>
            
            <h3 class="text-neon-blue font-bold tracking-widest text-sm mb-6 flex items-center gap-2">
                <i class="fas fa-search"></i> ANALYZER MODULE (ORACLE)
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Provider -->
                <div>
                    <label class="text-[10px] font-bold text-starlight/50 uppercase mb-2 block ml-2">Provider</label>
                    <select class="select w-full bg-black/40 border-white/5 focus:border-neon-blue focus:bg-black/60 text-white rounded-xl provider-select" name="oracle_provider" data-target="oracle_model" id="oracle_provider">
                        <option value="">Select...</option>
                        <option value="deepseek" <%= settings.oracle_provider === 'deepseek' ? 'selected' : '' %>>DeepSeek</option>
                        <option value="qwen" <%= settings.oracle_provider === 'qwen' ? 'selected' : '' %>>Qwen (Alibaba)</option>
                        <option value="gemini" <%= settings.oracle_provider === 'gemini' ? 'selected' : '' %>>Google Gemini</option>
                        <option value="perplexity" <%= settings.oracle_provider === 'perplexity' ? 'selected' : '' %>>Perplexity</option>
                    </select>
                </div>
                <!-- API Key -->
                <div>
                    <label class="text-[10px] font-bold text-starlight/50 uppercase mb-2 block ml-2">API Key</label>
                    <input type="password" class="input w-full bg-black/40 border-white/5 focus:border-neon-blue focus:bg-black/60 text-white rounded-xl" name="oracle_api_key" id="oracle_api_key" value="<%= settings.oracle_api_key || '' %>" placeholder="Empty for ENV">
                </div>
                <!-- Model -->
                <div>
                    <label class="text-[10px] font-bold text-starlight/50 uppercase mb-2 block ml-2">Model ID</label>
                    <div class="join w-full">
                        <select class="select join-item w-full bg-black/40 border-white/5 focus:border-neon-blue text-white" name="oracle_model" id="oracle_model">
                            <option value="<%= settings.oracle_model %>"><%= settings.oracle_model %></option>
                        </select>
                        <button type="button" class="btn join-item border-white/5 bg-white/5 hover:bg-white/10 text-white refresh-models" data-provider="oracle_provider" data-key="oracle_api_key" data-target="oracle_model">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SNIPER (QUOTER) -->
        <div class="glass-card p-8 rounded-3xl border border-white/10 relative overflow-hidden group hover:border-warning/30 transition-colors">
            <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-30 transition-opacity">
                <i class="fas fa-crosshairs text-6xl text-warning"></i>
            </div>

            <h3 class="text-warning font-bold tracking-widest text-sm mb-6 flex items-center gap-2">
                <i class="fas fa-shopping-cart"></i> SNIPER MODULE (QUOTER)
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Provider -->
                <div>
                    <label class="text-[10px] font-bold text-starlight/50 uppercase mb-2 block ml-2">Provider</label>
                    <select class="select w-full bg-black/40 border-white/5 focus:border-warning focus:bg-black/60 text-white rounded-xl provider-select" name="sniper_provider" data-target="sniper_model" id="sniper_provider">
                        <option value="">Select...</option>
                        <option value="gemini" <%= settings.sniper_provider === 'gemini' ? 'selected' : '' %>>Google Gemini (Recommended)</option>
                        <option value="qwen" <%= settings.sniper_provider === 'qwen' ? 'selected' : '' %>>Qwen (Alibaba)</option>
                        <option value="deepseek" <%= settings.sniper_provider === 'deepseek' ? 'selected' : '' %>>DeepSeek</option>
                    </select>
                </div>
                <!-- API Key -->
                <div>
                    <label class="text-[10px] font-bold text-starlight/50 uppercase mb-2 block ml-2">API Key</label>
                    <input type="password" class="input w-full bg-black/40 border-white/5 focus:border-warning focus:bg-black/60 text-white rounded-xl" name="sniper_api_key" id="sniper_api_key" value="<%= settings.sniper_api_key || '' %>" placeholder="Empty for ENV">
                </div>
                <!-- Model -->
                <div>
                    <label class="text-[10px] font-bold text-starlight/50 uppercase mb-2 block ml-2">Model ID</label>
                    <div class="join w-full">
                        <select class="select join-item w-full bg-black/40 border-white/5 focus:border-warning text-white" name="sniper_model" id="sniper_model">
                            <option value="<%= settings.sniper_model %>"><%= settings.sniper_model %></option>
                        </select>
                        <button type="button" class="btn join-item border-white/5 bg-white/5 hover:bg-white/10 text-white refresh-models" data-provider="sniper_provider" data-key="sniper_api_key" data-target="sniper_model">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PARSER (PDF) -->
        <div class="glass-card p-8 rounded-3xl border border-white/10 relative overflow-hidden group hover:border-success/30 transition-colors">
            <h3 class="text-success font-bold tracking-widest text-sm mb-6 flex items-center gap-2">
                <i class="fas fa-file-pdf"></i> PARSER MODULE (FAILOVER SYSTEM)
            </h3>
            
            <p class="text-xs text-starlight/50 mb-6 font-mono">Define the AI cascade for PDF extraction. If Primary fails, Backup 1 engages, and so on.</p>

            <%
               const parser_primary = settings.parser_primary || { provider: 'gemini', model: 'gemini-2.0-flash-lite-preview-02-05' };
               const parser_backup1 = settings.parser_backup1 || { provider: 'gemini', model: 'gemini-2.0-flash' };
               const parser_backup2 = settings.parser_backup2 || { provider: 'deepseek', model: 'deepseek-chat' };
               const parser_backup3 = settings.parser_backup3 || { provider: '', model: '' };
            %>

            <!-- PRIORITY 1 -->
            <div class="bg-black/20 p-4 rounded-2xl mb-4 border border-white/5">
                <h4 class="text-xs font-bold text-white mb-3 uppercase opacity-70">Priority 1 (Primary)</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                        <select class="select w-full select-sm bg-black/40 border-white/10 text-white" name="parser_provider_0" id="parser_provider_0">
                            <option value="">Select...</option>
                            <option value="gemini" <%= parser_primary.provider === 'gemini' ? 'selected' : '' %>>Google Gemini</option>
                            <option value="qwen" <%= parser_primary.provider === 'qwen' ? 'selected' : '' %>>Qwen</option>
                            <option value="deepseek" <%= parser_primary.provider === 'deepseek' ? 'selected' : '' %>>DeepSeek</option>
                        </select>
                    </div>
                    <div>
                         <input type="password" class="input input-sm w-full bg-black/40 border-white/10 text-white" name="parser_key_0" id="parser_key_0" value="<%= parser_primary.key || '' %>" placeholder="System Key (Default)">
                    </div>
                    <div>
                        <div class="join w-full">
                            <input type="text" class="input input-sm join-item w-full bg-black/40 border-white/10 text-white" name="parser_model_0" id="parser_model_0" value="<%= parser_primary.model || '' %>" placeholder="Model ID">
                             <button type="button" class="btn btn-sm join-item border-white/10 bg-white/5 text-starlight refresh-models" data-provider="parser_provider_0" data-key="parser_key_0" data-target="parser_model_0_select">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <select class="hidden" id="parser_model_0_select"></select>
                    </div>
                </div>
            </div>

            <!-- BACKUPS -->
            <% [parser_backup1, parser_backup2, parser_backup3].forEach((backup, idx) => { %>
                <div class="bg-black/10 p-4 rounded-2xl mb-2 border border-white/5 opacity-70 hover:opacity-100 transition-opacity">
                    <h4 class="text-[10px] font-bold text-starlight mb-2 uppercase tracking-wide">Backup <%= idx + 1 %></h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <select class="select select-xs w-full bg-black/40 border-white/5 text-starlight" name="parser_provider_<%= idx + 1 %>">
                            <option value="">(Disabled)</option>
                            <option value="gemini" <%= backup.provider === 'gemini' ? 'selected' : '' %>>Google Gemini</option>
                            <option value="qwen" <%= backup.provider === 'qwen' ? 'selected' : '' %>>Qwen</option>
                            <option value="deepseek" <%= backup.provider === 'deepseek' ? 'selected' : '' %>>DeepSeek</option>
                        </select>
                        <input type="password" class="input input-xs w-full bg-black/40 border-white/5 text-starlight" name="parser_key_<%= idx + 1 %>" value="<%= backup.key || '' %>" placeholder="API Key">
                        <input type="text" class="input input-xs w-full bg-black/40 border-white/5 text-starlight" name="parser_model_<%= idx + 1 %>" value="<%= backup.model || '' %>" placeholder="Model ID">
                    </div>
                </div>
            <% }); %>

        </div>

    </form>
</div>

<%- include('partials/footer') %>

<script>
    document.querySelectorAll('.refresh-models').forEach(btn => {
        btn.addEventListener('click', async () => {
             const providerSelect = document.getElementById(btn.dataset.provider);
            const keyInput = document.getElementById(btn.dataset.key);
            const targetId = btn.dataset.target;
            const isHiddenSelect = targetId.includes('_select');
            
            // Logic to find correct target
            const targetSelect = document.getElementById(targetId);
            // If hidden select is used (for text inputs), get the text input as target
            const targetInput = isHiddenSelect ? document.getElementById(targetId.replace('_select', '')) : document.getElementById(targetId);

            const provider = providerSelect.value;
            const apiKey = keyInput.value;

            if(!provider) return alert('Select a provider first.');

            // Animation
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/fetch-models', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, apiKey })
                });

                if(!res.ok) throw new Error(await res.text());
                const models = await res.json();

                if(isHiddenSelect) {
                    // For simpler text inputs, we just show a prompt or populate a hidden select to copy from
                    // For now, let's just create a simple prompt selection for the "Parser" inputs which are text fields
                    let optionsString = models.map(m => m.id).join('\n');
                     let selected = prompt('Available Models (Copy ID):\\n' + optionsString, models[0].id);
                     if(selected) targetInput.value = selected;
                } else {
                    targetSelect.innerHTML = '';
                    models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.textContent = m.name || m.id;
                        targetSelect.appendChild(opt);
                    });
                    // Flash success
                    targetSelect.classList.add('ring-2', 'ring-success');
                    setTimeout(() => targetSelect.classList.remove('ring-2', 'ring-success'), 1000);
                }
            } catch(e) {
                alert('Fetch failed: ' + e.message);
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        });
    });
</script>
