<%- include('partials/head') %>
<%- include('partials/header') %>

<!-- DETAIL HEADER -->
<div class="fixed top-20 left-0 right-0 z-30 pointer-events-none px-6">
    <div class="container mx-auto max-w-7xl flex justify-between items-end pb-4 pt-4 bg-gradient-to-b from-cosmic-void to-transparent pointer-events-auto">
        <div>
            <div class="flex items-center gap-3 mb-1">
                <span class="badge badge-outline text-xs font-mono text-starlight/50">ID: <%= task.id.substring(0,8) %></span>
                <% if (task.status === 'running') { %>
                    <span class="badge badge-info gap-2 animate-pulse"><span class="w-1.5 h-1.5 rounded-full bg-white"></span> RUNNING</span>
                <% } else if (task.status === 'completed') { %>
                    <span class="badge badge-success gap-2"><i class="fas fa-check"></i> COMPLETED</span>
                <% } else { %>
                    <span class="badge badge-ghost"><%= task.status %></span>
                <% } %>
            </div>
            <h1 class="text-3xl font-black text-white tracking-tight text-shadow-glow"><%= task.name %></h1>
             <div class="flex items-center gap-4 text-xs font-mono text-starlight/60 mt-2">
                <span><i class="fas fa-map-marker-alt text-neon-purple mr-1"></i> <%= task.cep %></span>
                <span><i class="far fa-calendar text-neon-blue mr-1"></i> <%= new Date(task.created_at).toLocaleString() %></span>
            </div>
        </div>
        
        <div class="flex gap-2">
            <% const anyUnlocked = taskItems.some(item => item.is_unlocked); %>
            <% if (anyUnlocked) { %>
                <a href="/download/<%= task.id %>" class="btn btn-success btn-sm font-bold shadow-[0_0_15px_rgba(34,197,94,0.4)] text-white gap-2">
                    <i class="fas fa-file-excel"></i> EXTRACT REPORT
                </a>
            <% } %>
            <a href="/dashboard" class="btn btn-ghost btn-sm text-starlight hover:bg-white/5">BACK</a>
        </div>
    </div>
</div>

<div class="container mx-auto px-4 max-w-7xl pt-32 pb-20">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- LEFT: ITEMS GRID -->
        <div class="lg:col-span-2 space-y-6">
            <div class="glass-card rounded-2xl overflow-hidden border border-white/5 shadow-2xl">
                <div class="bg-white/5 p-4 border-b border-white/10 flex justify-between items-center">
                    <h3 class="font-bold text-white text-sm flex items-center gap-2">
                        <i class="fas fa-list text-neon-blue"></i> OPERATION TARGETS
                    </h3>
                    <div class="text-xs font-mono text-starlight/50"><%= taskItems.length %> ITEMS</div>
                </div>

                <div class="overflow-x-auto min-h-[500px]">
                    <table class="table w-full">
                        <thead class="bg-black/40 text-starlight/40 uppercase text-[10px] tracking-wider font-mono">
                            <tr>
                                <th class="bg-black/40 pl-6">ITEM / SPECS</th>
                                <th class="bg-black/40 hidden md:table-cell">IDENTIFIED SOURCE</th>
                                <th class="bg-black/40 text-right">TARGET ($)</th>
                                <th class="bg-black/40 text-right">BEST ($)</th>
                                <th class="bg-black/40 text-center">MARGIN</th>
                                <th class="bg-black/40 text-center">LINK</th>
                                <th class="bg-black/40 text-right pr-6">INTEL</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <% taskItems.forEach(item => { 
                                const hasPrice = item.best_price > 0;
                                const profit = item.valor_venda - item.best_price;
                                const margin = (profit / item.valor_venda) * 100;
                                const isWin = hasPrice && profit >= 0;
                                const isUnlocked = item.is_unlocked;
                            %>
                            <tr class="hover:bg-white/5 transition-colors group">
                                <td class="pl-6 py-4">
                                    <div class="font-bold text-white text-sm line-clamp-2 w-full max-w-xs" title="<%= item.description %>"><%= item.description %></div>
                                    <div class="text-[10px] font-mono text-starlight/40 mt-1">QTY: <%= item.quantidade %></div>
                                </td>
                                <td class="hidden md:table-cell">
                                    <% if (isUnlocked && item.winner) { %>
                                        <div class="text-xs font-bold text-white"><%= item.winner.brand_model || 'Unknown Brand' %></div>
                                        <div class="text-[10px] opacity-50"><%= item.winner.title ? item.winner.title.substring(0,30) + '...' : '' %></div>
                                    <% } else { %>
                                        <div class="text-xs opacity-20 font-mono select-none">CLASSIFIED</div>
                                    <% } %>
                                </td>
                                <td class="text-right font-mono text-starlight/70 text-sm">
                                    <%= item.valor_venda.toFixed(2) %>
                                </td>
                                <td class="text-right font-mono text-sm">
                                    <% if (hasPrice) { %>
                                        <% if (isUnlocked) { %>
                                            <span class="<%= isWin ? 'text-success font-bold text-shadow-sm' : 'text-error font-bold' %>">
                                                <%= item.best_price.toFixed(2) %>
                                            </span>
                                        <% } else { %>
                                            <span class="blur-sm opacity-50 select-none text-white">000.00</span>
                                        <% } %>
                                    <% } else { %>
                                        <span class="opacity-20">-</span>
                                    <% } %>
                                </td>
                                <td class="text-center">
                                    <% if (isWin && isUnlocked) { %>
                                        <div class="badge badge-success badge-xs gap-1 font-bold">+<%= margin.toFixed(0) %> %</div>
                                    <% } else if (hasPrice && isUnlocked) { %>
                                        <div class="badge badge-error badge-xs font-bold"><i class="fas fa-arrow-down"></i></div>
                                    <% } else if (!hasPrice && task.status === 'running') { %>
                                        <span class="loading loading-spinner loading-xs text-neon-blue"></span>
                                    <% } else { %>
                                        <span class="opacity-20 text-[10px]">--</span>
                                    <% } %>
                                </td>
                                <td class="text-center">
                                    <% if (isUnlocked && item.winner && item.winner.link) { %>
                                        <a href="<%= item.winner.link %>" target="_blank" class="btn btn-xs btn-circle btn-ghost text-neon-blue"><i class="fas fa-external-link-alt"></i></a>
                                    <% } else { %>
                                        <button class="btn btn-xs btn-circle btn-ghost opacity-10 cursor-not-allowed"><i class="fas fa-link"></i></button>
                                    <% } %>
                                </td>
                                <td class="text-right pr-6">
                                     <% if (hasPrice) { %>
                                        <% if (isUnlocked) { %>
                                            <span class="text-success text-xs"><i class="fas fa-lock-open"></i></span>
                                        <% } else { %>
                                            <button onclick="unlockItem('<%= item.db_id || item.id %>')" class="btn btn-xs btn-outline border-warning text-warning hover:bg-warning hover:text-black hover:border-warning font-mono transition-all">
                                                <i class="fas fa-bolt mr-1"></i> 150
                                            </button>
                                        <% } %>
                                    <% } %>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RIGHT: INTEL PANEL -->
        <div class="space-y-6">
            
            <!-- TOTAL PROFIT METRIC -->
            <div class="glass-card p-6 flex flex-col items-center justify-center relative overflow-hidden group">
                 <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent z-0"></div>
                 <%
                    let totalProfit = 0;
                    let lockedCount = 0;
                    taskItems.forEach(i => {
                        if (i.best_price > 0 && i.best_price < i.valor_venda) {
                            totalProfit += (i.valor_venda - i.best_price) * i.quantidade;
                        }
                        if (!i.is_unlocked && i.best_price > 0) lockedCount++;
                    });
                    const unlockAllCost = lockedCount * 75; // 50% discount
                 %>
                 
                 <div class="relative z-10 text-center">
                     <div class="text-xs font-bold text-starlight/50 tracking-widest uppercase mb-2">PROJECTED PROFIT</div>
                     <div class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-tr from-white to-starlight drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                         R$ <span class="<%= lockedCount > 0 ? 'blur-sm select-none' : '' %>"><%= totalProfit.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                     </div>
                 </div>

                 <% if (lockedCount > 0) { %>
                 <div class="mt-8 relative z-10 w-full">
                     <button onclick="unlockAll()" class="btn btn-lg w-full bg-warning border-0 text-black font-black hover:scale-105 transition-transform shadow-[0_0_20px_rgba(255,149,0,0.4)]">
                         <div class="flex flex-col items-center">
                             <div class="flex items-center gap-2"><i class="fas fa-bolt"></i> UNLOCK ALL (<%= unlockAllCost %> W)</div>
                             <div class="text-[10px] font-normal opacity-80">INCLUDES 50% BUNDLE DISCOUNT</div>
                         </div>
                     </button>
                 </div>
                 <% } %>
            </div>

            <!-- LIVE LOGS -->
            <div class="glass-card rounded-2xl overflow-hidden border border-white/5 flex flex-col h-[400px]">
                <div class="p-3 bg-black/40 border-b border-white/5 flex items-center justify-between">
                    <span class="text-[10px] font-bold text-starlight/50 uppercase tracking-widest"><i class="fas fa-terminal mr-2"></i> SYSTEM LOGS</span>
                    <div class="flex gap-1">
                        <div class="w-2 h-2 rounded-full bg-red-500/50"></div>
                        <div class="w-2 h-2 rounded-full bg-yellow-500/50"></div>
                        <div class="w-2 h-2 rounded-full bg-green-500/50"></div>
                    </div>
                </div>
                <div class="flex-1 bg-black/60 p-4 overflow-y-auto scrollbar-thin font-mono text-xs text-starlight/70 space-y-1" id="logs">
                    <div class="opacity-30">> Initializing connection...</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const taskId = '<%= task.id %>';
    
    // Auto Scroll Logs
    const logBox = document.getElementById('logs');
    setInterval(() => {
        fetch('/api/logs/' + taskId)
            .then(r => r.text())
            .then(text => {
                const current = logBox.innerText;
                if (current.length !== text.length) {
                    logBox.innerText = text;
                    logBox.scrollTop = logBox.scrollHeight;
                }
            });
    }, 2000);

    async function unlockItem(itemDbId) {
        if (!confirm('Unlock intelligence for this item (150 W)?')) return;
        try {
            const res = await fetch('/api/unlock-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ itemId: itemDbId })
            });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert('Access Denied: ' + (data.error || 'Insufficient Watts'));
            }
        } catch(e) {}
    }

    async function unlockAll() {
        if (!confirm('Unlock FULL intelligence report (50% OFF)?')) return;
        try {
            const res = await fetch('/api/unlock-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId: taskId })
            });
            const data = await res.json();
            if (data.success) window.location.reload();
            else alert('Access Denied: ' + data.error);
        } catch(e) {}
    }

    // Refresh if running
    if ('<%= task.status %>' === 'running') {
        setTimeout(() => window.location.reload(), 8000);
    }
</script>

<%- include('partials/footer') %>
