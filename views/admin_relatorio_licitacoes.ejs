<%- include('partials/head') %>
<%- include('partials/header') %>

<div class="container mx-auto px-4 py-8">
    <!-- Admin Header -->
    <div class="mb-12">
        <h2 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
            <i class="fas fa-file-contract text-neon-blue text-4xl"></i>
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-white to-starlight">Relat√≥rio de Licita√ß√µes</span>
        </h2>
        <p class="text-starlight/50 font-mono text-sm tracking-widest pl-1">Itens em Andamento (Material) ‚Ä¢ Otimizado para I.A.</p>
    </div>

    <!-- Date Selection Card -->
    <div class="glass-card p-6 mb-8">
        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <i class="fas fa-calendar-alt text-neon-blue"></i> Selecionar Per√≠odo
        </h3>
        <form id="reportForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div class="form-control">
                <label class="label" for="dataInicio"><span class="label-text text-starlight/70">Data Inicial</span></label>
                <input type="date" id="dataInicio" name="dataInicio" 
                       class="input bg-black/20 border-white/10 focus:border-neon-blue text-white" required>
            </div>
            <div class="form-control">
                <label class="label" for="dataFim"><span class="label-text text-starlight/70">Data Final</span></label>
                <input type="date" id="dataFim" name="dataFim" 
                       class="input bg-black/20 border-white/10 focus:border-neon-blue text-white" required>
            </div>
            <div class="form-control">
                <button type="submit" id="btnGerar" class="btn btn-primary bg-neon-blue/20 border-neon-blue/50 text-neon-blue hover:bg-neon-blue/40 tracking-wider">
                    <i class="fas fa-cogs mr-2"></i>GERAR RELAT√ìRIO
                </button>
            </div>
            <div class="form-control">
                <button type="button" id="btnDownload" disabled class="btn btn-ghost border-white/20 text-starlight/50 hover:bg-white/10">
                    <i class="fas fa-download mr-2"></i>BAIXAR .MD
                </button>
            </div>
        </form>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden">
        <div class="glass-card p-12 text-center">
            <div class="loading loading-spinner loading-lg text-neon-blue mb-4"></div>
            <p class="text-starlight/70 font-mono">Processando licita√ß√µes...</p>
        </div>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="hidden">
        <!-- Stats Bar -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-neon-blue/20 flex items-center justify-center">
                    <i class="fas fa-building text-neon-blue text-xl"></i>
                </div>
                <div>
                    <p class="text-starlight/50 text-xs uppercase tracking-wider">Licita√ß√µes</p>
                    <p id="statLicitacoes" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-warning/20 flex items-center justify-center">
                    <i class="fas fa-list text-warning text-xl"></i>
                </div>
                <div>
                    <p class="text-starlight/50 text-xs uppercase tracking-wider">Itens</p>
                    <p id="statItens" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-success/20 flex items-center justify-center">
                    <i class="fas fa-file-alt text-success text-xl"></i>
                </div>
                <div>
                    <p class="text-starlight/50 text-xs uppercase tracking-wider">Tamanho</p>
                    <p id="statSize" class="text-lg font-bold text-white">0 KB</p>
                </div>
            </div>
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-info/20 flex items-center justify-center">
                    <i class="fas fa-robot text-info text-xl"></i>
                </div>
                <div>
                    <p class="text-starlight/50 text-xs uppercase tracking-wider">Formato</p>
                    <p class="text-lg font-bold text-white">Markdown</p>
                </div>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="glass-card p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-terminal text-starlight"></i> Debug Log
                </h3>
            </div>
            <div id="debugOutput" class="bg-black/40 rounded-lg p-4 font-mono text-xs text-starlight/70 max-h-[300px] overflow-y-auto border border-white/10">
                <!-- Debug info will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden">
        <div class="glass-card p-12 text-center">
            <i class="fas fa-inbox text-5xl text-starlight/30 mb-4"></i>
            <p class="text-starlight/50 font-mono">Nenhuma licita√ß√£o encontrada para o per√≠odo selecionado.</p>
            <p class="text-starlight/30 text-sm mt-2">Verifique se existem itens com status "Em andamento" e tipo "Material".</p>
            <!-- Debug info for empty results -->
            <div id="emptyDebugOutput" class="mt-6 bg-black/40 rounded-lg p-4 font-mono text-xs text-starlight/50 text-left max-w-2xl mx-auto"></div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Set default dates (last 30 days)
    const hoje = new Date();
    const mes_atras = new Date();
    mes_atras.setDate(mes_atras.getDate() - 30);
    
    document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
    document.getElementById('dataInicio').value = mes_atras.toISOString().split('T')[0];
    
    let lastResult = null;
    
    // Format debug output
    const formatDebug = (debug) => {
        let output = '';
        output += `üìÖ Data In√≠cio: ${debug.dataInicio}\n`;
        output += `üìÖ Data Fim: ${debug.dataFim}\n`;
        output += `‚è±Ô∏è Query Start: ${debug.queryStartTime}\n`;
        output += `‚è±Ô∏è Query End: ${debug.queryEndTime || 'N/A'}\n`;
        output += `\n--- ESTAT√çSTICAS ---\n`;
        output += `üìä Licita√ß√µes no per√≠odo: ${debug.totalLicitacoesInRange}\n`;
        output += `üìã Itens "Em andamento": ${debug.totalItensEmAndamento}\n`;
        output += `üì¶ Itens "Material": ${debug.totalItensMaterial}\n`;
        output += `‚úÖ Itens v√°lidos (ambos filtros): ${debug.totalItensValidos}\n`;
        output += `üìé Arquivos encontrados: ${debug.totalArquivos || 0}\n`;
        output += `üè¢ Licita√ß√µes agrupadas: ${debug.totalLicitacoesAgrupadas || 0}\n`;
        if (debug.errors && debug.errors.length > 0) {
            output += `\n--- ERROS ---\n`;
            debug.errors.forEach(e => { output += `‚ùå ${e}\n`; });
        }
        return output;
    };
    
    // Form submission
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        
        // Show loading
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('resultsContainer').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('btnGerar').disabled = true;
        document.getElementById('btnDownload').disabled = true;
        
        try {
            const response = await fetch('/api/admin/relatorio-licitacoes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dataInicio, dataFim })
            });
            
            const result = await response.json();
            lastResult = result;
            
            if (!response.ok) {
                throw new Error(result.error || 'Erro ao gerar relat√≥rio');
            }
            
            if (!result.hasData) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('emptyDebugOutput').textContent = formatDebug(result.debug);
            } else {
                document.getElementById('statLicitacoes').textContent = result.totalLicitacoes;
                document.getElementById('statItens').textContent = result.totalItens;
                document.getElementById('statSize').textContent = `${result.markdownSizeKB} KB`;
                document.getElementById('debugOutput').textContent = formatDebug(result.debug);
                document.getElementById('resultsContainer').classList.remove('hidden');
                document.getElementById('btnDownload').disabled = false;
            }
            
        } catch (error) {
            alert('Erro: ' + error.message);
        } finally {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('btnGerar').disabled = false;
        }
    });
    
    // Download button - triggers file download
    document.getElementById('btnDownload').addEventListener('click', async () => {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        
        document.getElementById('btnDownload').innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Gerando...';
        document.getElementById('btnDownload').disabled = true;
        
        try {
            const response = await fetch('/api/admin/relatorio-licitacoes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dataInicio, dataFim, downloadFile: true })
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Erro ao baixar');
            }
            
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_licitacoes_${dataInicio}_${dataFim}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
        } catch (error) {
            alert('Erro: ' + error.message);
        } finally {
            document.getElementById('btnDownload').innerHTML = '<i class="fas fa-download mr-2"></i>BAIXAR .MD';
            document.getElementById('btnDownload').disabled = false;
        }
    });
});
</script>
