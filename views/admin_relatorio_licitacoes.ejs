<%- include('partials/head') %>
<%- include('partials/header') %>

<div class="container mx-auto px-4 py-8">
    <!-- Admin Header -->
    <div class="mb-12">
        <h2 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
            <i class="fas fa-file-contract text-neon-blue text-4xl"></i>
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-white to-starlight">Relatório de Licitações</span>
        </h2>
        <p class="text-starlight/50 font-mono text-sm tracking-widest pl-1">Itens em Andamento (Material) • Otimizado para I.A.</p>
    </div>

    <!-- Alerts -->
    <% if (typeof success !== 'undefined' && success && success.length > 0) { %>
        <div class="alert alert-success bg-success/10 border-success/20 text-success mb-6 backdrop-blur-md">
            <i class="fas fa-check-circle"></i> <span><%= success %></span>
        </div>
    <% } %>
    <% if (typeof error !== 'undefined' && error && error.length > 0) { %>
        <div class="alert alert-error bg-error/10 border-error/20 text-error mb-6 backdrop-blur-md">
            <i class="fas fa-exclamation-circle"></i> <span><%= error %></span>
        </div>
    <% } %>

    <!-- Date Selection Card -->
    <div class="glass-card p-6 mb-8">
        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <i class="fas fa-calendar-alt text-neon-blue"></i> Selecionar Período
        </h3>
        <form id="reportForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div class="form-control">
                <label class="label"><span class="label-text text-starlight/70">Data Inicial</span></label>
                <input type="date" id="dataInicio" name="dataInicio" 
                       class="input input-bordered bg-black/20 border-white/10 focus:border-neon-blue text-white" required>
            </div>
            <div class="form-control">
                <label class="label"><span class="label-text text-starlight/70">Data Final</span></label>
                <input type="date" id="dataFim" name="dataFim" 
                       class="input input-bordered bg-black/20 border-white/10 focus:border-neon-blue text-white" required>
            </div>
            <div class="form-control">
                <button type="submit" id="btnGerar" class="btn btn-primary bg-neon-blue/20 border-neon-blue/50 text-neon-blue hover:bg-neon-blue/40 tracking-wider">
                    <i class="fas fa-cogs mr-2"></i>GERAR RELATÓRIO
                </button>
            </div>
            <div class="form-control">
                <button type="button" id="btnCopiar" disabled class="btn btn-ghost border-white/20 text-starlight/50 hover:bg-white/10">
                    <i class="fas fa-copy mr-2"></i>COPIAR MARKDOWN
                </button>
            </div>
        </form>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden">
        <div class="glass-card p-12 text-center">
            <div class="loading loading-spinner loading-lg text-neon-blue mb-4"></div>
            <p class="text-starlight/70 font-mono">Processando licitações...</p>
        </div>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="hidden">
        <!-- Stats Bar -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-neon-blue/20 flex items-center justify-center">
                    <i class="fas fa-building text-neon-blue text-xl"></i>
                </div>
                <div>
                    <p class="text-starlight/50 text-xs uppercase tracking-wider">Licitações</p>
                    <p id="statLicitacoes" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-warning/20 flex items-center justify-center">
                    <i class="fas fa-list text-warning text-xl"></i>
                </div>
                <div>
                    <p class="text-starlight/50 text-xs uppercase tracking-wider">Itens</p>
                    <p id="statItens" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-success/20 flex items-center justify-center">
                    <i class="fas fa-robot text-success text-xl"></i>
                </div>
                <div>
                    <p class="text-starlight/50 text-xs uppercase tracking-wider">Formato</p>
                    <p class="text-lg font-bold text-white">Markdown / I.A.</p>
                </div>
            </div>
        </div>

        <!-- Markdown Output -->
        <div class="glass-card p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-file-alt text-starlight"></i> Saída Otimizada para I.A.
                </h3>
                <div class="flex gap-2">
                    <button id="btnCopiar2" class="btn btn-sm btn-ghost border-white/20 text-starlight hover:bg-white/10">
                        <i class="fas fa-copy mr-1"></i> Copiar
                    </button>
                    <button id="btnDownload" class="btn btn-sm btn-ghost border-white/20 text-starlight hover:bg-white/10">
                        <i class="fas fa-download mr-1"></i> Download .md
                    </button>
                </div>
            </div>
            <div id="markdownOutput" class="bg-black/40 rounded-lg p-4 font-mono text-sm text-starlight/80 whitespace-pre-wrap max-h-[600px] overflow-y-auto border border-white/10">
                <!-- Markdown content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden">
        <div class="glass-card p-12 text-center">
            <i class="fas fa-inbox text-5xl text-starlight/30 mb-4"></i>
            <p class="text-starlight/50 font-mono">Nenhuma licitação encontrada para o período selecionado.</p>
            <p class="text-starlight/30 text-sm mt-2">Verifique se existem itens com status "Em andamento" e tipo "Material".</p>
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Set default dates (last 30 days)
    const hoje = new Date();
    const mes_atras = new Date();
    mes_atras.setDate(mes_atras.getDate() - 30);
    
    document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
    document.getElementById('dataInicio').value = mes_atras.toISOString().split('T')[0];
    
    let markdownContent = '';
    
    // Form submission
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        
        // Show loading
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('resultsContainer').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('btnGerar').disabled = true;
        
        try {
            const response = await fetch('/api/admin/relatorio-licitacoes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dataInicio, dataFim })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Erro ao gerar relatório');
            }
            
            markdownContent = result.markdown;
            
            if (result.data.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('statLicitacoes').textContent = result.totalLicitacoes;
                document.getElementById('statItens').textContent = result.totalItens;
                document.getElementById('markdownOutput').textContent = result.markdown;
                document.getElementById('resultsContainer').classList.remove('hidden');
                document.getElementById('btnCopiar').disabled = false;
            }
            
        } catch (error) {
            alert('Erro: ' + error.message);
        } finally {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('btnGerar').disabled = false;
        }
    });
    
    // Copy buttons
    const copyToClipboard = async () => {
        if (!markdownContent) return;
        
        try {
            await navigator.clipboard.writeText(markdownContent);
            // Show feedback
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check mr-1"></i> Copiado!';
            btn.classList.add('text-success');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('text-success');
            }, 2000);
        } catch (err) {
            alert('Erro ao copiar: ' + err.message);
        }
    };
    
    document.getElementById('btnCopiar').addEventListener('click', copyToClipboard);
    document.getElementById('btnCopiar2').addEventListener('click', copyToClipboard);
    
    // Download button
    document.getElementById('btnDownload').addEventListener('click', () => {
        if (!markdownContent) return;
        
        const blob = new Blob([markdownContent], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `relatorio_licitacoes_${document.getElementById('dataInicio').value}_${document.getElementById('dataFim').value}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
});
</script>
