<% /* DOPAMINE ENGINE v2 - THE VOID STREAM */ %>

    <div class="stream-container">
        <div class="stream-track">
            <% if (!licitacoes || licitacoes.length===0) { %>
                <div class="stream-card flex flex-col items-center justify-center text-center">
                    <div class="text-6xl mb-6 opacity-50">ðŸŒ‘</div>
                    <h3 class="text-2xl font-bold mb-2">O Vazio</h3>
                    <p class="text-base-content/70 mb-6">NÃ£o encontramos nada nesta frequÃªncia.</p>
                    <a href="/profile/preferences" class="btn btn-primary btn-outline rounded-full">
                        Ajustar Sensores
                    </a>
                </div>
                <% } else { %>
                    <% licitacoes.forEach((lic, index)=> { %>
                        <div class="stream-card" data-id="<%= lic.id %>" data-index="<%= index %>">

                            <!-- Floating Items Button (Right Side) -->
                            <button class="floating-items-btn" onclick="openItemsModal('<%= lic.id %>')"
                                title="Ver itens da licitaÃ§Ã£o">
                                <div class="btn-icon"><i class="fas fa-box-open"></i></div>
                                <span class="btn-label">Itens</span>
                            </button>

                            <!-- 1. Header: Avatar + Name + Location -->
                            <div class="card-header">
                                <div class="org-badge">
                                    <div class="org-avatar">
                                        <%= (lic.razao_social_orgao || 'X' ).charAt(0).toUpperCase() %>
                                    </div>
                                    <div class="flex flex-col overflow-hidden">
                                        <span class="org-name truncate max-w-[250px]">
                                            <%= lic.razao_social_orgao || 'Ã“rgÃ£o Desconhecido' %>
                                        </span>
                                        <span class="text-xs opacity-60 flex items-center gap-1">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <%= lic.municipio_nome || 'N/D' %> - <%= lic.uf_sigla || 'N/D' %>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Financial Spotlight: The Core Data -->
                            <% if (lic.is_valor_sigiloso) { %>
                                <div class="value-spotlight sigiloso">
                                    <i class="fas fa-lock text-3xl mb-2 opacity-50"></i>
                                    <span class="value-amount text-2xl">Valor Sigiloso</span>
                                    <span class="text-xs opacity-50 mt-2">Valores nÃ£o divulgados pelo Ã³rgÃ£o</span>
                                </div>
                                <% } else { %>
                                    <div class="financial-spotlight">
                                        <!-- Main Value -->
                                        <div class="main-value">
                                            <span class="value-label">Valor Estimado</span>
                                            <span class="value-amount">
                                                R$ <%= parseFloat(lic.valor_estimado_total || 0).toLocaleString('pt-BR',
                                                    {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                                            </span>
                                        </div>
                                        <!-- Insights Grid -->
                                        <div class="financial-grid">
                                            <div class="insight-box profit">
                                                <i class="fas fa-chart-line"></i>
                                                <div>
                                                    <span class="lbl">Lucro Est.</span>
                                                    <span class="val">R$ <%= (lic.lucro_esperado ||
                                                            0).toLocaleString('pt-BR', {maximumFractionDigits: 0}) %>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="insight-box capital">
                                                <i class="fas fa-piggy-bank"></i>
                                                <div>
                                                    <span class="lbl">Capital Nec.</span>
                                                    <span class="val">R$ <%= (lic.capital_necessario ||
                                                            0).toLocaleString('pt-BR', {maximumFractionDigits: 0}) %>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>

                                        <!-- 3. Deadline Banner: Urgency Logic -->
                                        <% if (lic.has_valid_deadline && lic.data_encerramento_proposta) { %>
                                            <div class="deadline-banner"
                                                data-deadline="<%= lic.data_encerramento_proposta %>">
                                                <div class="deadline-icon"><i class="fas fa-hourglass-half"></i></div>
                                                <div class="deadline-info">
                                                    <div class="lbl">Encerramento</div>
                                                    <div class="val deadline-countdown"
                                                        data-date="<%= lic.data_encerramento_proposta %>">Carregando...
                                                    </div>
                                                </div>
                                            </div>
                                            <% } else if (lic.prazo_previsto) { %>
                                                <div class="deadline-banner warning">
                                                    <div class="deadline-icon"><i class="fas fa-calculator"></i></div>
                                                    <div class="deadline-info">
                                                        <div class="lbl">Prazo Previsto</div>
                                                        <div class="val">
                                                            <%= new Date(lic.prazo_previsto).toLocaleDateString('pt-BR',
                                                                {day: '2-digit' , month: '2-digit' , year: 'numeric' })
                                                                %>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% } %>

                                                    <!-- 4. Object (Content) -->
                                                    <div class="card-body">
                                                        <div class="object-label"><i class="fas fa-file-alt"></i> Objeto
                                                        </div>
                                                        <div class="relative">
                                                            <p class="line-clamp-2 text-sm opacity-90"
                                                                id="desc-<%= lic.id %>">
                                                                <%= lic.objeto_compra || 'Objeto nÃ£o informado.' %>
                                                            </p>
                                                            <button onclick="openDescriptionModal('<%= lic.id %>')"
                                                                class="text-xs text-blue-400 hover:text-blue-300 mt-1 font-medium underline-offset-2 hover:underline">
                                                                Ver mais detalhes
                                                            </button>
                                                        </div>
                                                        <!-- Hidden full text for modal logic -->
                                                        <textarea id="full-desc-<%= lic.id %>"
                                                            class="hidden"><%= lic.objeto_compra || '' %></textarea>
                                                    </div>

                                                    <!-- 5. Tags & Meta (Deadlines moved here) -->
                                                    <div class="card-meta">
                                                        <!-- Existing Tags -->
                                                        <% if (lic.modalidade_licitacao) { %>
                                                            <span class="meta-pill"><i class="fas fa-gavel"></i>
                                                                <%= lic.modalidade_licitacao %>
                                                            </span>
                                                            <% } %>
                                                                <% if (lic.srp) { %>
                                                                    <span class="meta-pill srp"><i
                                                                            class="fas fa-box-open"></i> SRP</span>
                                                                    <% } %>

                                                                        <!-- New Deadline Tag -->
                                                                        <% if (lic.final_deadline) { %>
                                                                            <% const d=new Date(lic.final_deadline);
                                                                                const now=new Date(); const diffTime=d -
                                                                                now; const diffDays=Math.ceil(diffTime /
                                                                                (1000 * 60 * 60 * 24)); let
                                                                                colorClass='bg-emerald-500/10 text-emerald-400 border-emerald-500/20'
                                                                                ; if (diffDays <=3)
                                                                                colorClass='bg-red-500/10 text-red-400 border-red-500/20 animate-pulse'
                                                                                ; else if (diffDays <=7)
                                                                                colorClass='bg-amber-500/10 text-amber-400 border-amber-500/20'
                                                                                ; %>
                                                                                <span
                                                                                    class="meta-pill <%= colorClass %>"
                                                                                    style="border: 1px solid currentColor;">
                                                                                    <i class="fas fa-clock"></i>
                                                                                    <%= lic.show_prazo_previsto
                                                                                        ? 'Previsto:' : 'Fim:' %>
                                                                                        <%= d.toLocaleDateString('pt-BR')
                                                                                            %>
                                                                                            <% if(diffDays> 0) { %> (<%=
                                                                                                    diffDays %>d) <% }
                                                                                                        %>
                                                                                </span>
                                                                                <% } %>

                                                                                    <% if (lic.data_publicacao_pncp) {
                                                                                        %>
                                                                                        <span class="meta-pill"><i
                                                                                                class="fas fa-calendar"></i>
                                                                                            Pub:
                                                                                            <%= new
                                                                                                Date(lic.data_publicacao_pncp).toLocaleDateString('pt-BR')
                                                                                                %>
                                                                                        </span>
                                                                                        <% } %>
                                                    </div>

                                                    <!-- 6. Actions -->
                                                    <div class="card-actions">
                                                        <button class="action-btn btn-skip" onclick="skipCard()"
                                                            title="Pular (P)">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <a href="/licitacoes/<%= lic.id %>"
                                                            class="action-btn btn-details" title="Detalhes (D)">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <button class="action-btn btn-save"
                                                            onclick="saveOpportunity(<%= lic.id %>)" title="Salvar (S)">
                                                            <i class="fas fa-heart"></i>
                                                        </button>
                                                    </div>

                                                    <!-- Loader -->
                                                    <div class="infinite-loader"></div>
                        </div>
                        <% }) %>
                            <% } %>
        </div>
    </div>

    <!-- Modals (Global) -->
    <!-- Description Modal -->
    <dialog id="desc_modal" class="modal">
        <div class="modal-box glass-effect pl-8 pr-8 pt-8 pb-4 max-w-2xl text-left">
            <h3 class="font-bold text-lg mb-4 text-blue-400">Objeto Completo</h3>
            <p class="py-4 text-base opacity-90 leading-relaxed whitespace-pre-wrap" id="desc_modal_content"></p>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-ghost">Fechar</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Items Modal -->
    <dialog id="items_modal" class="modal">
        <div class="modal-box glass-effect w-11/12 max-w-4xl p-0 overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fas fa-boxes text-blue-400"></i> Itens da LicitaÃ§Ã£o
                </h3>
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost"><i class="fas fa-times"></i></button>
                </form>
            </div>

            <div class="p-0 overflow-y-auto flex-1 bg-base-100/50" id="items_modal_content">
                <div class="flex flex-col items-center justify-center h-40">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                </div>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <link rel="stylesheet" href="/css/dopamine.css">
    <script src="/js/story-feed.js" defer></script>