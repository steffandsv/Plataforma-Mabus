<% /* DOPAMINE ENGINE v2 - THE VOID STREAM */ %>

    <div class="stream-container">
        <div class="stream-track">
            <% if (!licitacoes || licitacoes.length===0) { %>
                <div class="stream-card flex flex-col items-center justify-center text-center">
                    <div class="text-6xl mb-6 opacity-50">ðŸŒ‘</div>
                    <h3 class="text-2xl font-bold mb-2">O Vazio</h3>
                    <p class="text-base-content/70 mb-6">NÃ£o encontramos nada nesta frequÃªncia.</p>
                    <a href="/profile/preferences" class="btn btn-primary btn-outline rounded-full">
                        Ajustar Sensores
                    </a>
                </div>
                <% } else { %>
                    <% licitacoes.forEach((lic, index)=> { %>
                        <div class="stream-card" data-id="<%= lic.id %>" data-index="<%= index %>">

                            <!-- Floating Items Button (Right Side) -->
                            <button class="floating-items-btn" onclick="openItemsModal('<%= lic.id %>')"
                                title="Ver itens da licitaÃ§Ã£o">
                                <div class="btn-icon"><i class="fas fa-box-open"></i></div>
                                <span class="btn-label">Itens</span>
                            </button>

                            <!-- 1. Header: Avatar + Name + Location -->
                            <div class="card-header">
                                <div class="org-badge">
                                    <div class="org-avatar">
                                        <%= (lic.razao_social_orgao || 'X' ).charAt(0).toUpperCase() %>
                                    </div>
                                    <div class="flex flex-col overflow-hidden">
                                        <span class="org-name truncate max-w-[250px]">
                                            <%= lic.razao_social_orgao || 'Ã“rgÃ£o Desconhecido' %>
                                        </span>
                                        <span class="text-xs opacity-60 flex items-center gap-1">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <%= lic.municipio_nome || 'N/D' %> - <%= lic.uf_sigla || 'N/D' %>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Financial Spotlight: The Core Data -->
                            <% if (lic.is_valor_sigiloso) { %>
                                <div class="value-spotlight sigiloso">
                                    <i class="fas fa-lock text-3xl mb-2 opacity-50"></i>
                                    <span class="value-amount text-2xl">Valor Sigiloso</span>
                                    <span class="text-xs opacity-50 mt-2">Valores nÃ£o divulgados pelo Ã³rgÃ£o</span>
                                </div>
                                <% } else { %>
                                    <div class="financial-spotlight">
                                        <!-- Main Value -->
                                        <div class="main-value">
                                            <span class="value-label">Valor Estimado</span>
                                            <span class="value-amount">
                                                R$ <%= parseFloat(lic.valor_estimado_total || 0).toLocaleString('pt-BR',
                                                    {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                                            </span>
                                        </div>
                                        <!-- Insights Grid -->
                                        <div class="financial-grid">
                                            <div class="insight-box profit">
                                                <i class="fas fa-chart-line"></i>
                                                <div>
                                                    <span class="lbl">Lucro Est.</span>
                                                    <span class="val">R$ <%= (lic.lucro_esperado ||
                                                            0).toLocaleString('pt-BR', {maximumFractionDigits: 0}) %>
                                                            </span>
                                                </div>
                                            </div>
                                            <div class="insight-box capital">
                                                <i class="fas fa-piggy-bank"></i>
                                                <div>
                                                    <span class="lbl">Capital Nec.</span>
                                                    <span class="val">R$ <%= (lic.capital_necessario ||
                                                            0).toLocaleString('pt-BR', {maximumFractionDigits: 0}) %>
                                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>

                                        <!-- 3. Deadline Banner: Urgency Logic -->
                                        <% if (lic.has_valid_deadline && lic.data_encerramento_proposta) { %>
                                            <div class="deadline-banner"
                                                data-deadline="<%= lic.data_encerramento_proposta %>">
                                                <div class="deadline-icon"><i class="fas fa-hourglass-half"></i></div>
                                                <div class="deadline-info">
                                                    <div class="lbl">Encerramento</div>
                                                    <div class="val deadline-countdown"
                                                        data-date="<%= lic.data_encerramento_proposta %>">Carregando...
                                                    </div>
                                                </div>
                                            </div>
                                            <% } else if (lic.prazo_previsto) { %>
                                                <div class="deadline-banner warning">
                                                    <div class="deadline-icon"><i class="fas fa-calculator"></i></div>
                                                    <div class="deadline-info">
                                                        <div class="lbl">Prazo Previsto</div>
                                                        <div class="val">
                                                            <%= new Date(lic.prazo_previsto).toLocaleDateString('pt-BR',
                                                                {day: '2-digit' , month: '2-digit' , year: 'numeric' })
                                                                %>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% } %>

                                                    <!-- 4. Object (Content) -->
                                                    <div class="card-body">
                                                        <div class="object-label"><i class="fas fa-file-alt"></i> Objeto
                                                        </div>
                                                        <p class="line-clamp-4">
                                                            <%= lic.objeto_compra || 'Objeto nÃ£o informado.' %>
                                                        </p>
                                                    </div>

                                                    <!-- 5. Tags & Meta -->
                                                    <div class="card-meta">
                                                        <% if (lic.modalidade_licitacao) { %>
                                                            <span class="meta-pill"><i class="fas fa-gavel"></i>
                                                                <%= lic.modalidade_licitacao %>
                                                            </span>
                                                            <% } %>
                                                                <% if (lic.srp) { %>
                                                                    <span class="meta-pill srp"><i
                                                                            class="fas fa-box-open"></i> SRP</span>
                                                                    <% } %>
                                                                        <% if (lic.data_publicacao_pncp) { %>
                                                                            <span class="meta-pill"><i
                                                                                    class="fas fa-calendar"></i> Pub:
                                                                                <%= new
                                                                                    Date(lic.data_publicacao_pncp).toLocaleDateString('pt-BR')
                                                                                    %></span>
                                                                            <% } %>
                                                    </div>

                                                    <!-- 6. Actions -->
                                                    <div class="card-actions">
                                                        <button class="action-btn btn-skip" onclick="skipCard()"
                                                            title="Pular (P)">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <a href="/licitacoes/<%= lic.id %>"
                                                            class="action-btn btn-details" title="Detalhes (D)">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <button class="action-btn btn-save"
                                                            onclick="saveOpportunity(<%= lic.id %>)" title="Salvar (S)">
                                                            <i class="fas fa-heart"></i>
                                                        </button>
                                                    </div>

                                                    <!-- Loader -->
                                                    <div class="infinite-loader"></div>
                        </div>
                        <% }) %>
                            <% } %>
        </div>
    </div>

    <link rel="stylesheet" href="/css/dopamine.css">
    <script src="/js/story-feed.js" defer></script>