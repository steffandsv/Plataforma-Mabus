<% /* Story Feed Component - Vertical Swipe Interface */ %>

    <div class="story-feed-container relative h-[80vh] bg-gradient-to-b from-base-100 to-base-300 rounded-2xl">
        <% if (!licitacoes || licitacoes.length===0) { %>
            <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="text-6xl mb-4">üéØ</div>
                <h3 class="text-2xl font-bold mb-2">Nenhuma licita√ß√£o encontrada</h3>
                <p class="text-base-content/70 mb-4">Ajuste suas prefer√™ncias para ver oportunidades relevantes</p>
                <a href="/profile/preferences" class="btn btn-primary">‚öôÔ∏è Configurar Prefer√™ncias</a>
            </div>
            <% } else { %>
                <div class="story-cards-wrapper h-full" id="story-wrapper">
                    <% licitacoes.forEach((lic, index)=> { %>
                        <div class="story-card <%= index === 0 ? 'active' : '' %>" data-index="<%= index %>"
                            data-id="<%= lic.id %>">

                            <!-- Relevance Score Badge (Outside inner wrapper to overlap) -->
                            <div class="score-badge-wrapper">
                                <% const score=lic.relevance_score || 0; %>
                                    <div
                                        class="score-badge <%= score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low' %>">
                                        <span class="score-number">
                                            <%= Math.round(score) %>%
                                        </span>
                                        <span class="score-label">Match</span>
                                    </div>
                            </div>

                            <!-- Inner Wrapper for Content (Calculated Height + Hidden Overflow) -->
                            <div class="story-content-inner flex flex-col h-full overflow-hidden">
                                <!-- Card Header - Compact -->
                                <div class="story-card-header flex-none">
                                    <div class="flex items-center gap-2 flex-1">
                                        <div class="org-avatar w-10 h-10 text-sm">
                                            <%= (lic.razao_social_orgao || 'X' ).charAt(0).toUpperCase() %>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-bold truncate pr-16">
                                                <%= lic.razao_social_orgao || '√ìrg√£o n√£o informado' %>
                                            </h3>
                                            <p class="opacity-70">
                                                <i class="fas fa-map-marker-alt text-xs"></i>
                                                <%= lic.municipio_nome || 'N/D' %> - <%= lic.uf_sigla || 'N/D' %>
                                            </p>
                                        </div>
                                    </div>
                                    <span class="badge badge-sm badge-primary pulse-animation text-xs">
                                        <%= lic.modalidade_licitacao || 'N/D' %>
                                    </span>
                                </div>

                                <!-- Value Spotlight - Compact -->
                                <% if (lic.valor_estimado_total && lic.valor_estimado_total> 0) { %>
                                    <div class="value-spotlight flex-none">
                                        <div class="value-label text-[10px]">Valor Estimado</div>
                                        <div class="value-amount animate-count-up">
                                            R$ <%= parseFloat(lic.valor_estimado_total).toLocaleString('pt-BR',
                                                {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                                        </div>
                                    </div>
                                    <% } %>

                                        <!-- Deadline Banner - Neuroci√™ncia da Urg√™ncia -->
                                        <% if (lic.data_encerramento_proposta) { %>
                                            <div class="deadline-banner flex-none"
                                                data-deadline="<%= lic.data_encerramento_proposta %>">
                                                <div class="deadline-icon">
                                                    <i class="fas fa-hourglass-half"></i>
                                                </div>
                                                <div class="deadline-content">
                                                    <div class="deadline-label">Participe at√©:</div>
                                                    <div class="deadline-time"
                                                        data-date="<%= lic.data_encerramento_proposta %>">
                                                        Carregando...
                                                    </div>
                                                </div>
                                            </div>
                                            <% } %>

                                                <!-- Loot Box de Itens - Gamifica√ß√£o Dopamin√©rgica -->
                                                <div class="loot-box-container flex-none">
                                                    <div class="loot-box closed" data-licitacao-id="<%= lic.id %>"
                                                        onclick="toggleLootBox(this)">
                                                        <div class="loot-box-closed-state">
                                                            <div class="treasure-icon">
                                                                <i class="fas fa-treasure-chest"></i>
                                                                <i class="fas fa-gift"></i>
                                                            </div>
                                                            <div class="loot-box-label">
                                                                <span class="shimmer">‚ú® Ver Itens da Licita√ß√£o</span>
                                                            </div>
                                                        </div>
                                                        <div class="loot-box-open-state" style="display: none;">
                                                            <div class="loot-box-header">
                                                                <i class="fas fa-box-open"></i>
                                                                <span>Itens da Licita√ß√£o</span>
                                                            </div>
                                                            <div class="loot-box-content">
                                                                <div class="loading-items">
                                                                    <i class="fas fa-spinner fa-spin"></i>
                                                                    Carregando itens...
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Object Description with Keyword Highlights -->
                                                <div
                                                    class="object-section flex-1 flex flex-col min-h-0 my-4 p-4 rounded-xl bg-base-200/50 border-l-4 border-primary">
                                                    <h4
                                                        class="font-semibold mb-2 flex-none flex items-center gap-2 text-primary">
                                                        <i class="fas fa-file-alt"></i>
                                                        Objeto
                                                    </h4>
                                                    <div class="object-content overflow-y-auto scrollbar-thin min-h-0">
                                                        <p class="text-base leading-relaxed"
                                                            data-keywords="<%= lic.matched_keywords || '' %>">
                                                            <%= lic.objeto_compra || 'N√£o informado' %>
                                                        </p>
                                                    </div>
                                                </div>

                                                <!-- Quick Info Pills - Mantidos para informa√ß√µes adicionais -->
                                                <% if (lic.srp || lic.data_publicacao_pncp) { %>
                                                    <div class="info-pills flex-none">
                                                        <% if (lic.data_publicacao_pncp) { %>
                                                            <div class="pill">
                                                                <i class="fas fa-calendar"></i>
                                                                Publicado: <%= new
                                                                    Date(lic.data_publicacao_pncp).toLocaleDateString('pt-BR')
                                                                    %>
                                                            </div>
                                                            <% } %>
                                                                <% if (lic.srp) { %>
                                                                    <div class="pill">
                                                                        <i class="fas fa-box-open"></i>
                                                                        Sistema de Registro de Pre√ßos
                                                                    </div>
                                                                    <% } %>
                                                    </div>
                                                    <% } %>
                            </div>

                            <!-- Action Buttons - EXTERNAL with Overlap Effect -->
                            <div class="story-actions-external">
                                <button class="action-btn-external skip-btn-external" onclick="skipCard()"
                                    title="Pular esta licita√ß√£o">
                                    <div class="btn-icon">
                                        <i class="fas fa-forward"></i>
                                    </div>
                                    <span class="btn-label">Pular</span>
                                </button>
                                <a href="/licitacoes/<%= lic.id %>" class="action-btn-external details-btn-external"
                                    title="Ver todos os detalhes">
                                    <div class="btn-icon">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <span class="btn-label">Detalhes</span>
                                </a>
                                <button class="action-btn-external save-btn-external"
                                    onclick="saveOpportunity(<%= lic.id %>)" title="Salvar para depois">
                                    <div class="btn-icon">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <span class="btn-label">Salvar</span>
                                </button>
                            </div>

                            <!-- Progress Indicator -->
                            <div class="progress-indicator">
                                <span class="font-bold">
                                    <%= index + 1 %>
                                </span> de <%= licitacoes.length %>
                            </div>
                        </div>
                        <% }) %>
                </div>

                <!-- Swipe Navigation Hints (aparecem na primeira visita) -->
                <div class="swipe-hints" id="swipe-hints">
                    <div class="hint-up">‚òùÔ∏è Deslize para cima ou ‚Üë</div>
                    <div class="hint-down">üëá Deslize para baixo ou ‚Üì</div>
                </div>
                <% } %>
    </div>

    <!-- Load Story Feed JS -->
    <link rel="stylesheet" href="/css/dopamine.css">
    <script src="/js/story-feed.js" defer></script>