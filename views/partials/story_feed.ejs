<% /* Story Feed Component - Vertical Swipe Interface */ %>

    <div class="story-feed-container relative h-full w-full">
        <% if (!licitacoes || licitacoes.length===0) { %>
            <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="text-6xl mb-4">üéØ</div>
                <h3 class="text-2xl font-bold mb-2">Nenhuma licita√ß√£o encontrada</h3>
                <p class="text-base-content/70 mb-4">Ajuste suas prefer√™ncias para ver oportunidades relevantes</p>
                <a href="/profile/preferences" class="btn btn-primary">‚öôÔ∏è Configurar Prefer√™ncias</a>
            </div>
            <% } else { %>
                <div class="story-cards-wrapper h-full" id="story-wrapper">
                    <% licitacoes.forEach((lic, index)=> { %>
                        <div class="story-card <%= index === 0 ? 'active' : '' %>" data-index="<%= index %>"
                            data-id="<%= lic.id %>">

                            <!-- Keyboard Shortcuts Hints (replaces score badge) -->
                            <div class="keyboard-hints">
                                <div class="key-hint"><kbd>S</kbd> Salvar</div>
                                <div class="key-hint"><kbd>P</kbd> Pular</div>
                                <div class="key-hint"><kbd>D</kbd> Detalhes</div>
                            </div>

                            <!-- Floating Items Button (Right Side) -->
                            <button class="floating-items-btn" onclick="openItemsModal('<%= lic.id %>')"
                                title="Ver itens da licita√ß√£o">
                                <div class="btn-icon">
                                    <i class="fas fa-box-open"></i>
                                </div>
                                <span class="btn-label">Itens</span>
                            </button>

                            <!-- Inner Wrapper for Content (Calculated Height + Hidden Overflow) -->
                            <div class="story-content-inner flex flex-col h-full overflow-hidden">
                                <!-- Card Header - Compact (sem badge de modalidade) -->
                                <div class="story-card-header flex-none">
                                    <div class="flex items-center gap-2 flex-1">
                                        <div class="org-avatar w-10 h-10 text-sm">
                                            <%= (lic.razao_social_orgao || 'X' ).charAt(0).toUpperCase() %>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-bold truncate pr-16">
                                                <%= lic.razao_social_orgao || '√ìrg√£o n√£o informado' %>
                                            </h3>
                                            <p class="opacity-70">
                                                <i class="fas fa-map-marker-alt text-xs"></i>
                                                <%= lic.municipio_nome || 'N/D' %> - <%= lic.uf_sigla || 'N/D' %>
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Financial Spotlight - Value + Profit + Capital -->
                                <% if (lic.is_valor_sigiloso) { %>
                                    <div class="value-sigiloso flex-none">
                                        <i class="fas fa-lock"></i>
                                        <span>Valor Sigiloso</span>
                                        <p class="hint text-xs opacity-60 mt-1">Este √≥rg√£o optou por n√£o divulgar os
                                            valores</p>
                                    </div>
                                    <% } else if (lic.valor_estimado_total && lic.valor_estimado_total> 0) { %>
                                        <div class="financial-spotlight flex-none">
                                            <div class="value-row value-total">
                                                <span class="value-label text-[10px]">Valor Estimado</span>
                                                <span class="value-amount animate-count-up">
                                                    R$ <%= parseFloat(lic.valor_estimado_total).toLocaleString('pt-BR',
                                                        {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                                                </span>
                                            </div>
                                            <div class="financial-insights">
                                                <div class="insight-card profit">
                                                    <i class="fas fa-chart-line"></i>
                                                    <span class="insight-label">Lucro Esperado</span>
                                                    <span class="insight-value">R$ <%= (lic.lucro_esperado ||
                                                            0).toLocaleString('pt-BR', {minimumFractionDigits: 0,
                                                            maximumFractionDigits: 0}) %></span>
                                                </div>
                                                <div class="insight-card capital">
                                                    <i class="fas fa-piggy-bank"></i>
                                                    <span class="insight-label">Capital Necess√°rio</span>
                                                    <span class="insight-value">R$ <%= (lic.capital_necessario ||
                                                            0).toLocaleString('pt-BR', {minimumFractionDigits: 0,
                                                            maximumFractionDigits: 0}) %></span>
                                                </div>
                                            </div>
                                        </div>
                                        <% } %>

                                            <!-- Object Description with Keyword Highlights - PRIORIDADE M√ÅXIMA -->
                                            <div
                                                class="object-section flex-none my-3 p-4 rounded-xl bg-base-200/50 border-l-4 border-primary">
                                                <h4
                                                    class="font-semibold mb-2 flex items-center gap-2 text-primary text-sm">
                                                    <i class="fas fa-file-alt"></i>
                                                    Objeto
                                                </h4>
                                                <div class="object-preview">
                                                    <% const objetoText=lic.objeto_compra || 'N√£o informado' ; %>
                                                        <p class="text-sm leading-relaxed"
                                                            id="objeto-preview-<%= index %>"
                                                            data-keywords="<%= lic.matched_keywords || '' %>"
                                                            data-full-text="<%= objetoText %>">
                                                            <%= objetoText %>
                                                        </p>
                                                </div>
                                            </div>

                                            <!-- Deadline Banner - Depois do Objeto -->
                                            <% if (lic.has_valid_deadline && lic.data_encerramento_proposta) { %>
                                                <div class="deadline-banner flex-none"
                                                    data-deadline="<%= lic.data_encerramento_proposta %>">
                                                    <div class="deadline-icon">
                                                        <i class="fas fa-hourglass-half"></i>
                                                    </div>
                                                    <div class="deadline-content">
                                                        <div class="deadline-label">Participe at√©:</div>
                                                        <div class="deadline-time"
                                                            data-date="<%= lic.data_encerramento_proposta %>">
                                                            Carregando...
                                                        </div>
                                                    </div>
                                                </div>
                                                <% } else if (lic.prazo_previsto) { %>
                                                    <div class="deadline-banner estimated flex-none"
                                                        data-urgency="warning">
                                                        <div class="deadline-icon">
                                                            <i class="fas fa-calculator"></i>
                                                        </div>
                                                        <div class="deadline-content">
                                                            <div class="deadline-label">
                                                                <i
                                                                    class="fas fa-exclamation-triangle text-warning text-xs"></i>
                                                                Prazo Previsto (√≥rg√£o n√£o informou)
                                                            </div>
                                                            <div class="deadline-time">
                                                                <%= new
                                                                    Date(lic.prazo_previsto).toLocaleDateString('pt-BR',
                                                                    { day: '2-digit' , month: '2-digit' ,
                                                                    year: 'numeric' }) %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% } %>

                                                        <!-- Tags de Categoria - Por √∫ltimo -->
                                                        <div class="category-tags flex-none">
                                                            <% if (lic.modalidade_licitacao) { %>
                                                                <span class="category-tag tag-primary">
                                                                    <i class="fas fa-gavel"></i>
                                                                    <%= lic.modalidade_licitacao %>
                                                                </span>
                                                                <% } %>
                                                                    <% if (lic.data_publicacao_pncp) { %>
                                                                        <span class="category-tag">
                                                                            <i class="fas fa-calendar"></i>
                                                                            Publicado: <%= new
                                                                                Date(lic.data_publicacao_pncp).toLocaleDateString('pt-BR')
                                                                                %>
                                                                        </span>
                                                                        <% } %>
                                                                            <% if (lic.srp) { %>
                                                                                <span class="category-tag tag-success">
                                                                                    <i class="fas fa-box-open"></i>
                                                                                    SRP
                                                                                </span>
                                                                                <% } %>
                                                        </div>
                            </div>

                            <!-- Action Buttons - EXTERNAL with Overlap Effect -->
                            <div class="story-actions-external">
                                <button class="action-btn-external skip-btn-external" onclick="skipCardWithAPI()"
                                    title="Pular esta licita√ß√£o (P)">
                                    <div class="btn-icon">
                                        <i class="fas fa-forward"></i>
                                    </div>
                                    <span class="btn-label">Pular</span>
                                </button>
                                <button class="action-btn-external details-btn-external"
                                    onclick="openDetailsModal(<%= lic.id %>)" title="Ver todos os detalhes (D)">
                                    <div class="btn-icon">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <span class="btn-label">Detalhes</span>
                                </button>
                                <button class="action-btn-external save-btn-external"
                                    onclick="saveOpportunity(<%= lic.id %>)" title="Salvar para depois (S)">
                                    <div class="btn-icon">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <span class="btn-label">Salvar</span>
                                </button>
                            </div>

                            <!-- Progress Indicator -->
                            <div class="progress-indicator">
                                <span class="font-bold">
                                    <%= index + 1 %>
                                </span> de <%= licitacoes.length %>
                            </div>
                        </div>
                        <% }) %>
                </div>
                <% } %>
    </div>

    <!-- Items Modal Overlay -->
    <div id="itemsModal" class="items-modal" style="display: none;">
        <div class="items-modal-backdrop" onclick="closeItemsModal()"></div>
        <div class="items-modal-container">
            <div class="items-modal-header">
                <h3>
                    <i class="fas fa-box-open"></i>
                    Itens da Licita√ß√£o
                </h3>
                <button class="modal-close-btn" onclick="closeItemsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="items-modal-body">
                <div class="loading-items">
                    <i class="fas fa-spinner fa-spin"></i>
                    Carregando itens...
                </div>
            </div>
        </div>
    </div>

    <!-- Objeto Modal Overlay -->
    <div id="objetoModal" class="items-modal" style="display: none;">
        <div class="items-modal-backdrop" onclick="closeObjetoModal()"></div>
        <div class="items-modal-container">
            <div class="items-modal-header">
                <h3>
                    <i class="fas fa-file-alt"></i>
                    Objeto Completo da Licita√ß√£o
                </h3>
                <button class="modal-close-btn" onclick="closeObjetoModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="items-modal-body">
                <div id="objetoFullText" class="objeto-full-text"></div>
            </div>
        </div>
    </div>

    <!-- Load Story Feed JS -->
    <link rel="stylesheet" href="/css/dopamine.css">
    <script src="/js/story-feed.js" defer></script>