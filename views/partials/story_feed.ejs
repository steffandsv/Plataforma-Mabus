<% /* Story Feed Component - Vertical Swipe Interface */ %>

    <div class="story-feed-container relative h-[80vh] bg-gradient-to-b from-base-100 to-base-300 rounded-2xl">
        <% if (!licitacoes || licitacoes.length===0) { %>
            <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="text-6xl mb-4">üéØ</div>
                <h3 class="text-2xl font-bold mb-2">Nenhuma licita√ß√£o encontrada</h3>
                <p class="text-base-content/70 mb-4">Ajuste suas prefer√™ncias para ver oportunidades relevantes</p>
                <a href="/profile/preferences" class="btn btn-primary">‚öôÔ∏è Configurar Prefer√™ncias</a>
            </div>
            <% } else { %>
                <div class="story-cards-wrapper h-full" id="story-wrapper">
                    <% licitacoes.forEach((lic, index)=> { %>
                        <div class="story-card <%= index === 0 ? 'active' : '' %>" data-index="<%= index %>"
                            data-id="<%= lic.id %>">

                            <!-- Relevance Score Badge (Outside inner wrapper to overlap) -->
                            <div class="score-badge-wrapper">
                                <% const score=lic.relevance_score || 0; %>
                                    <div
                                        class="score-badge <%= score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low' %>">
                                        <span class="score-number">
                                            <%= Math.round(score) %>%
                                        </span>
                                        <span class="score-label">Match</span>
                                    </div>
                            </div>

                            <!-- Floating Items Button (Right Side) -->
                            <button class="floating-items-btn" onclick="openItemsModal('<%= lic.id %>')"
                                title="Ver itens da licita√ß√£o">
                                <div class="btn-icon">
                                    <i class="fas fa-box-open"></i>
                                </div>
                                <span class="btn-label">Itens</span>
                            </button>

                            <!-- Inner Wrapper for Content (Calculated Height + Hidden Overflow) -->
                            <div class="story-content-inner flex flex-col h-full overflow-hidden">
                                <!-- Card Header - Compact (sem badge de modalidade) -->
                                <div class="story-card-header flex-none">
                                    <div class="flex items-center gap-2 flex-1">
                                        <div class="org-avatar w-10 h-10 text-sm">
                                            <%= (lic.razao_social_orgao || 'X' ).charAt(0).toUpperCase() %>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-bold truncate pr-16">
                                                <%= lic.razao_social_orgao || '√ìrg√£o n√£o informado' %>
                                            </h3>
                                            <p class="opacity-70">
                                                <i class="fas fa-map-marker-alt text-xs"></i>
                                                <%= lic.municipio_nome || 'N/D' %> - <%= lic.uf_sigla || 'N/D' %>
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Value Spotlight - Compact -->
                                <% if (lic.valor_estimado_total && lic.valor_estimado_total> 0) { %>
                                    <div class="value-spotlight flex-none">
                                        <div class="value-label text-[10px]">Valor Estimado</div>
                                        <div class="value-amount animate-count-up">
                                            R$ <%= parseFloat(lic.valor_estimado_total).toLocaleString('pt-BR',
                                                {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                                        </div>
                                    </div>
                                    <% } %>

                                        <!-- Object Description with Keyword Highlights - PRIORIDADE M√ÅXIMA -->
                                        <div
                                            class="object-section flex-none my-3 p-4 rounded-xl bg-base-200/50 border-l-4 border-primary">
                                            <h4 class="font-semibold mb-2 flex items-center gap-2 text-primary text-sm">
                                                <i class="fas fa-file-alt"></i>
                                                Objeto
                                            </h4>
                                            <div class="object-preview">
                                                <% const objetoText=lic.objeto_compra || 'N√£o informado' ; %>
                                                    <p class="text-sm leading-relaxed" id="objeto-preview-<%= index %>"
                                                        data-keywords="<%= lic.matched_keywords || '' %>"
                                                        data-full-text="<%= objetoText %>"><span class="line-clamp-2">
                                                            <%= objetoText.length> 120 ? objetoText.substring(0, 120) :
                                                                objetoText %>
                                                        </span>
                                                        <% if (objetoText.length> 120) { %>... <a href="#"
                                                                onclick="openObjetoModal('<%= index %>'); return false;"
                                                                class="text-primary hover:text-primary/80 font-medium hover:underline">Ver
                                                                mais</a>
                                                            <% } %>
                                                    </p>
                                            </div>
                                        </div>

                                        <!-- Deadline Banner - Depois do Objeto -->
                                        <% if (lic.data_encerramento_proposta) { %>
                                            <div class="deadline-banner flex-none"
                                                data-deadline="<%= lic.data_encerramento_proposta %>">
                                                <div class="deadline-icon">
                                                    <i class="fas fa-hourglass-half"></i>
                                                </div>
                                                <div class="deadline-content">
                                                    <div class="deadline-label">Participe at√©:</div>
                                                    <div class="deadline-time"
                                                        data-date="<%= lic.data_encerramento_proposta %>">
                                                        Carregando...
                                                    </div>
                                                </div>
                                            </div>
                                            <% } %>

                                                <!-- Tags de Categoria - Por √∫ltimo -->
                                                <div class="category-tags flex-none">
                                                    <% if (lic.modalidade_licitacao) { %>
                                                        <span class="category-tag tag-primary">
                                                            <i class="fas fa-gavel"></i>
                                                            <%= lic.modalidade_licitacao %>
                                                        </span>
                                                        <% } %>
                                                            <% if (lic.data_publicacao_pncp) { %>
                                                                <span class="category-tag">
                                                                    <i class="fas fa-calendar"></i>
                                                                    Publicado: <%= new
                                                                        Date(lic.data_publicacao_pncp).toLocaleDateString('pt-BR')
                                                                        %>
                                                                </span>
                                                                <% } %>
                                                                    <% if (lic.srp) { %>
                                                                        <span class="category-tag tag-success">
                                                                            <i class="fas fa-box-open"></i>
                                                                            SRP
                                                                        </span>
                                                                        <% } %>
                                                </div>
                            </div>

                            <!-- Action Buttons - EXTERNAL with Overlap Effect -->
                            <div class="story-actions-external">
                                <button class="action-btn-external skip-btn-external" onclick="skipCard()"
                                    title="Pular esta licita√ß√£o">
                                    <div class="btn-icon">
                                        <i class="fas fa-forward"></i>
                                    </div>
                                    <span class="btn-label">Pular</span>
                                </button>
                                <a href="/licitacoes/<%= lic.id %>" class="action-btn-external details-btn-external"
                                    title="Ver todos os detalhes">
                                    <div class="btn-icon">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <span class="btn-label">Detalhes</span>
                                </a>
                                <button class="action-btn-external save-btn-external"
                                    onclick="saveOpportunity(<%= lic.id %>)" title="Salvar para depois">
                                    <div class="btn-icon">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <span class="btn-label">Salvar</span>
                                </button>
                            </div>

                            <!-- Progress Indicator -->
                            <div class="progress-indicator">
                                <span class="font-bold">
                                    <%= index + 1 %>
                                </span> de <%= licitacoes.length %>
                            </div>
                        </div>
                        <% }) %>
                </div>
                <% } %>
    </div>

    <!-- Items Modal Overlay -->
    <div id="itemsModal" class="items-modal" style="display: none;">
        <div class="items-modal-backdrop" onclick="closeItemsModal()"></div>
        <div class="items-modal-container">
            <div class="items-modal-header">
                <h3>
                    <i class="fas fa-box-open"></i>
                    Itens da Licita√ß√£o
                </h3>
                <button class="modal-close-btn" onclick="closeItemsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="items-modal-body">
                <div class="loading-items">
                    <i class="fas fa-spinner fa-spin"></i>
                    Carregando itens...
                </div>
            </div>
        </div>
    </div>

    <!-- Objeto Modal Overlay -->
    <div id="objetoModal" class="items-modal" style="display: none;">
        <div class="items-modal-backdrop" onclick="closeObjetoModal()"></div>
        <div class="items-modal-container">
            <div class="items-modal-header">
                <h3>
                    <i class="fas fa-file-alt"></i>
                    Objeto Completo da Licita√ß√£o
                </h3>
                <button class="modal-close-btn" onclick="closeObjetoModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="items-modal-body">
                <div id="objetoFullText" class="objeto-full-text"></div>
            </div>
        </div>
    </div>

    <!-- Load Story Feed JS -->
    <link rel="stylesheet" href="/css/dopamine.css">
    <script src="/js/story-feed.js" defer></script>