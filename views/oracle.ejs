<%- include('partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/js/neural_network.js"></script>

<style>
    /* Custom Scrollbar */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.1); border-radius: 20px; }

    /* Module Locking Effects */
    .locked-blur { filter: blur(8px); pointer-events: none; user-select: none; }
    .lock-overlay { 
        position: absolute; inset: 0; 
        display: flex; flex-direction: column; justify-content: center; items-center;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        z-index: 10; transition: opacity 0.3s ease;
    }

    .cursor-blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }

    /* SVG Filter for Gooey Effect (Hidden but active) */
    .visually-hidden { position: absolute; width: 0; height: 0; overflow: hidden; }
</style>

<!-- SVG Filter Definition -->
<svg class="visually-hidden">
    <defs>
        <filter id="goo">
            <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
            <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 19 -9" result="goo" />
            <feComposite in="SourceGraphic" in2="goo" operator="atop"/>
        </filter>
    </defs>
</svg>

<div class="min-h-screen bg-base-100 flex flex-col items-center pb-20">

    <!-- TOP NAV / STATS (Floating) -->
    <div class="fixed top-24 right-6 z-50 bg-base-100/90 backdrop-blur shadow-xl rounded-full px-6 py-3 border border-warning flex items-center gap-3 animate-fade-in-down">
        <i class="fas fa-bolt text-warning animate-pulse text-xl"></i>
        <span class="font-black text-xl font-mono" id="userCredits"><%= user.current_credits %></span>
        <span class="text-xs uppercase tracking-widest opacity-60">Watts</span>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl">

        <!-- HEADER BUTTONS -->
        <div class="flex justify-between items-center mb-8">
            <button onclick="resetView()" class="btn btn-ghost hover:bg-base-200 gap-2 group">
                <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                VOLTAR AO INÍCIO
            </button>
            <div class="text-xs font-mono opacity-30">MABUS ORACLE PROTOCOL V6.0</div>
        </div>

        <!-- =========== VIEW: UPLOAD ============ -->
        <div id="uploadView" class="animate-fade-in-up transition-all duration-500">
            <div class="text-center mb-12">
                <h1 class="text-7xl font-black text-base-content tracking-tighter mb-4">ORÁCULO <span class="text-primary">V5</span></h1>
                <p class="text-xl text-base-content/60 font-light tracking-wide">Inteligência Estratégica & Decodificação </p>
            </div>

            <div id="uploadContainer" class="flex justify-center items-center">
                <form id="uploadForm" class="w-full max-w-2xl relative group">
                    <!-- Glow Effect -->
                    <div class="absolute -inset-1 bg-gradient-to-r from-primary to-accent rounded-3xl blur opacity-20 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
                    
                    <label for="pdfFiles" class="relative w-full h-80 border-2 border-dashed border-base-300 bg-base-100 rounded-3xl flex flex-col justify-center items-center cursor-pointer hover:border-primary transition-all shadow-2xl" id="dropZoneArea">
                        <div class="p-6 rounded-full bg-base-200 group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300 mb-6">
                            <i class="fas fa-microchip fa-4x text-primary"></i>
                        </div>
                        <div class="text-3xl font-bold text-base-content drop-zone-text">SOLTAR EDITAL</div>
                        <div class="text-base-content/50 mt-2 font-mono text-sm">PDF APENAS • MÁX 50MB</div>
                        <input type="file" id="pdfFiles" name="pdfFiles" accept=".pdf" multiple hidden required>
                    </label>
                </form>
            </div>

            <!-- NEURAL LOADER (MABUS CORE) -->
            <div id="loader" class="hidden text-center py-20 flex flex-col items-center min-h-[50vh] justify-center">
                
                <canvas id="neuralCanvas" class="mb-4" style="width: 100%; height: 400px;"></canvas>

                <div class="text-3xl font-black text-base-content mb-4 tracking-tighter" id="loaderTitle">
                    MABUS PROTOCOL V5
                </div>
                
                <div class="text-sm font-mono text-base-content/50 mb-8 h-6 relative">
                     <span id="loaderText" class="scramble-text">VARREDURA INICIAL EM ANDAMENTO...</span>
                </div>

                <!-- NOTIFICATION REQUEST -->
                <div id="notifyRequest" class="hidden animate-bounce-in">
                    <button onclick="enableNotifications()" class="btn btn-outline btn-sm btn-primary rounded-full gap-2">
                        <i class="fas fa-bell"></i>
                        ME AVISE QUANDO TERMINAR
                    </button>
                    <p class="text-[10px] text-base-content/30 mt-2 max-w-xs mx-auto">
                        A análise profunda pode demorar. Ative para não perder o resultado.
                    </p>
                </div>
            </div>
        </div>

        <!-- =========== VIEW: RESULT ============ -->
        <div id="resultView" class="hidden animate-fade-in transition-all duration-500">
            <!-- Header / Teaser -->
            <div class="text-center mb-16 relative">
                <div class="absolute top-0 right-0 opacity-20">
                     <div class="text-6xl font-black font-mono" id="metaIdDisplay">#000</div>
                </div>

                <!-- GLOWING ORB / GAUGE IPM DISPLAY -->
                <div class="relative w-72 h-72 mx-auto mb-12 flex items-center justify-center transform hover:scale-105 transition-transform duration-500 cursor-help group" title="Índice de Potencial Mabus">
                    <!-- Outer Glows -->
                    <div class="absolute inset-0 bg-primary/20 rounded-full blur-3xl animate-pulse group-hover:bg-primary/30 transition-colors"></div>
                    <div class="absolute inset-4 bg-black/40 rounded-full backdrop-blur-md border border-white/5 shadow-inner"></div>

                    <!-- SVG Gauge -->
                    <svg class="w-full h-full transform -rotate-90 drop-shadow-2xl relative z-10">
                        <circle cx="144" cy="144" r="120" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/5" />
                        <circle cx="144" cy="144" r="120" stroke="url(#gradientScore)" stroke-width="12" fill="transparent" stroke-dasharray="753" stroke-dashoffset="753" stroke-linecap="round" class="transition-all duration-[2000ms] ease-out" id="scoreCircle" />
                        <defs>
                            <linearGradient id="gradientScore" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#ef4444" />
                                <stop offset="40%" stop-color="#eab308" />
                                <stop offset="100%" stop-color="#22c55e" />
                            </linearGradient>
                        </defs>
                    </svg>

                    <!-- Inner Text -->
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center z-20">
                        <div class="relative">
                            <div id="ipmDisplay" class="text-7xl font-black tracking-tighter text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)] font-mono">0</div>
                            <div class="absolute -top-4 -right-6 text-xs font-bold bg-white/10 px-2 py-0.5 rounded text-white/60">V5</div>
                        </div>
                        <div class="text-sm font-bold tracking-[0.3em] text-white/40 mt-2 border-t border-white/10 pt-2 w-20">/ 100</div>
                        <div class="text-[10px] items-center gap-1 flex text-primary mt-3 font-mono uppercase tracking-widest opacity-80 animate-pulse">
                            <i class="fas fa-bolt"></i> IPM SCORE
                        </div>
                    </div>
                </div>
                
                <div id="classificacaoDisplay" class="text-5xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-white via-gray-200 to-gray-500 mb-8 uppercase drop-shadow-lg scale-y-110">---</div>
                
                <div id="tagsDisplay" class="flex flex-wrap justify-center gap-3 mb-10"></div>
                
                <div class="glass-panel p-12 rounded-[3rem] max-w-4xl mx-auto shadow-2xl relative overflow-visible mt-10 mb-16 group hover:scale-[1.01] transition-transform duration-500 mask-image-gradient">
                    <div class="absolute -top-8 -left-8 text-7xl text-primary/20 rotate-12 transition-transform group-hover:rotate-0"><i class="fas fa-quote-left"></i></div>
                    <div class="absolute -bottom-8 -right-8 text-7xl text-primary/20 rotate-12 transition-transform group-hover:rotate-0"><i class="fas fa-quote-right"></i></div>
                    
                    <h3 class="text-center text-primary font-mono text-xs tracking-[0.5em] uppercase mb-6 opacity-60">Insight Estratégico</h3>
                    <p id="resumoDisplay" class="text-2xl text-white font-light leading-relaxed text-center relative z-10 font-sans tracking-wide drop-shadow-md">...</p>
                </div>
            </div>

            <!-- MODULES GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-24" id="modulesGrid">
                <!-- Cards injected here -->
            </div>

            <!-- SNIPER ACTION -->
            <div class="text-center pb-20 border-t border-white/5 pt-12">
                <h3 class="text-3xl font-black mb-8 tracking-tight">PRONTO PARA O ATAQUE?</h3>
                <form action="/create" method="POST" id="sniperForm" class="inline-block">
                    <input type="hidden" name="name" id="sniperName">
                    <input type="hidden" name="cep" value="00000-000">
                    <input type="hidden" name="gridData" id="sniperGridData">
                    <input type="hidden" name="metadataJSON" id="sniperMetadata">
                    <input type="hidden" name="moduleName" value="gemini_meli">
                    <input type="hidden" name="existingFilePath" id="sniperExistingFilePath">

                    <button type="submit" class="btn btn-primary btn-lg rounded-full px-16 text-xl shadow-[0_0_40px_rgba(var(--p),0.4)] hover:shadow-[0_0_60px_rgba(var(--p),0.6)] hover:scale-105 transition-all font-black border-2 border-primary">
                        <i class="fas fa-crosshairs mr-3"></i> INICIAR CAPTURA (SNIPER)
                    </button>
                </form>
            </div>
        </div>

        <!-- =========== HISTORY DECK (BELOW MAIN) ============ -->
        <div class="mt-20 pt-10 border-t border-base-300">
            <h2 class="text-2xl font-black tracking-tight text-white mb-8 flex items-center gap-3">
                <i class="fas fa-history text-primary"></i> 
                TRANSMISSÕES RECENTES
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="historyGrid">
                <!-- History Cards injected via JS -->
                <div class="col-span-3 text-center py-20 opacity-30 font-mono">CARREGANDO ARQUIVOS...</div>
            </div>
        </div>

    </div>
</div>

<%- include('partials/footer') %>

<script>
    let currentOpportunityId = null;
    let currentUserCredits = <%= user.current_credits %>;
    const historyGrid = document.getElementById('historyGrid');
    const userCreditsEl = document.getElementById('userCredits');

    // --- INIT ---
    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        const initialHistory = <%- JSON.stringify(history || []) %>;
        renderHistoryDeck(initialHistory);

        const deepLinkData = <%- JSON.stringify(initialOpportunity || null) %>;
        if(deepLinkData) {
            try {
                const parsed = {
                    id: deepLinkData.id,
                    metadata: typeof deepLinkData.metadata_json === 'string' ? JSON.parse(deepLinkData.metadata_json || '{}') : deepLinkData.metadata_json,
                    locked_content: typeof deepLinkData.locked_content_json === 'string' ? JSON.parse(deepLinkData.locked_content_json || '{}') : deepLinkData.locked_content_json,
                    items: typeof deepLinkData.items_json === 'string' ? JSON.parse(deepLinkData.items_json || '[]') : deepLinkData.items_json,
                    unlocked_modules: typeof deepLinkData.unlocked_modules === 'string' ? JSON.parse(deepLinkData.unlocked_modules || '[]') : (deepLinkData.unlocked_modules || []),
                    file_path: "" 
                };
                showResult(parsed);
            } catch(e) {
                console.error("Deep link parse error", e);
            }
        }
    });

    // --- VIEW MANAGEMENT ---
    function showUpload() {
        document.getElementById('uploadView').classList.remove('hidden');
        document.getElementById('resultView').classList.add('hidden');
        currentOpportunityId = null;
        document.getElementById('uploadForm').reset();
        
        // Reset Loader UI
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('uploadContainer').style.display = 'flex';
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showResult(data) {
        document.getElementById('uploadView').classList.add('hidden');
        document.getElementById('resultView').classList.remove('hidden');
        document.getElementById('loader').classList.add('hidden');
        renderFullAnalysis(data);
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetView() {
        showUpload();
    }

    // --- HISTORY DECK ---
    function renderHistoryDeck(items) {
        historyGrid.innerHTML = '';
        if(items.length === 0) {
            historyGrid.innerHTML = '<div class="col-span-3 text-center p-10 bg-base-200/30 rounded-3xl border border-dashed border-base-300">Sem histórico recente.</div>';
            return;
        }

        items.forEach(item => {
            const meta = typeof item.metadata_json === 'string' ? JSON.parse(item.metadata_json || '{}') : item.metadata_json;
            const unlocked = typeof item.unlocked_modules === 'string' ? JSON.parse(item.unlocked_modules || '[]') : (item.unlocked_modules || []);
            const score = item.ipm_score || 0;
            const title = item.title || 'Sem Título';
            const date = new Date(item.created_at).toLocaleDateString('pt-BR', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
            
            // Unlocked Count
            const unlockedCount = unlocked.length;

            const card = document.createElement('div');
            card.className = `glass-panel p-6 rounded-2xl border border-white/5 hover:border-primary/50 cursor-pointer transition-all hover:-translate-y-2 shadow-lg group relative overflow-hidden`;
            card.innerHTML = `
                <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                
                <div class="flex justify-between items-start mb-4 relative z-10">
                    <div class="neo-badge ${score > 70 ? 'neo-badge-success' : (score > 40 ? 'neo-badge-warning' : 'neo-badge-error')}">${score}</div>
                    <div class="text-xs font-mono opacity-50 text-white">${date}</div>
                </div>
                
                <h4 class="font-bold text-lg mb-2 line-clamp-2 text-white group-hover:text-primary transition-colors leading-tight relative z-10">${title}</h4>
                <p class="text-sm text-white/60 line-clamp-2 mb-4 h-10 relative z-10">${meta.classificacao || 'Análise Mabus Protocol'}</p>

                <div class="flex justify-between items-center border-t border-white/5 pt-4 mt-auto relative z-10">
                    <div class="flex items-center gap-2 text-xs font-bold ${unlockedCount > 0 ? 'text-success' : 'text-white/30'}">
                        <i class="fas ${unlockedCount > 0 ? 'fa-lock-open' : 'fa-lock'}"></i>
                        ${unlockedCount > 0 ? `${unlockedCount} ITENS LIBERADOS` : 'BLOQUEADO'}
                    </div>
                    <i class="fas fa-arrow-right text-primary opacity-0 group-hover:opacity-100 transition-opacity transform group-hover:translate-x-1"></i>
                </div>
            `;
            card.onclick = () => loadAnalysis(item.id);
            historyGrid.appendChild(card);
        });
    }

    async function loadAnalysis(id) {
        try {
            // Show Loader Overlay? Or just smooth scroll to top and show generic loader
            document.getElementById('resultView').classList.add('hidden');
            document.getElementById('uploadView').classList.remove('hidden');
            document.getElementById('uploadContainer').style.display = 'none';
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('loaderText').innerText = "RECUPERANDO DADOS..."; 

            const res = await fetch(`/api/oracle/history/${id}`);
            if(!res.ok) throw new Error("Erro ao carregar");
            const data = await res.json();

            const parsed = {
                id: data.id,
                metadata: typeof data.metadata_json === 'string' ? JSON.parse(data.metadata_json) : data.metadata_json,
                locked_content: typeof data.locked_content_json === 'string' ? JSON.parse(data.locked_content_json) : data.locked_content_json,
                items: typeof data.items_json === 'string' ? JSON.parse(data.items_json) : data.items_json,
                unlocked_modules: typeof data.unlocked_modules === 'string' ? JSON.parse(data.unlocked_modules) : (data.unlocked_modules || []),
                file_path: "" 
            };
            
            showResult(parsed);

        } catch(e) {
            console.error(e);
            alert("Erro ao carregar análise.");
            resetView();
        }
    }


    // --- UPLOAD LOGIC ---
    const dropZone = document.getElementById('dropZoneArea');
    const fileInput = document.getElementById('pdfFiles');
    const uploadForm = document.getElementById('uploadForm');

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => { e.preventDefault(); dropZone.classList.add('border-primary', 'bg-base-200'); }, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => { e.preventDefault(); dropZone.classList.remove('border-primary', 'bg-base-200'); }, false);
    });
    dropZone.addEventListener('drop', (e) => { fileInput.files = e.dataTransfer.files; handleUpload(); });
    fileInput.addEventListener('change', handleUpload);

    async function handleUpload() {
        if (fileInput.files.length === 0) return;

        if (Notification.permission === "default") {
             document.getElementById('notifyRequest').classList.remove('hidden');
        } else {
             document.getElementById('notifyRequest').classList.add('hidden');
        }

        document.getElementById('uploadContainer').style.display = 'none';
        document.getElementById('loader').classList.remove('hidden');
        
        // Init Neural Animation
        if(window.neuralLoader) delete window.neuralLoader;
        window.neuralLoader = new NeuralLoader('neuralCanvas');
        
        const formData = new FormData(uploadForm);
        let currentData = {};

        // Status Messages
        const loadingPhrases = [
            "MAPEANDO CONCORRÊNCIA GLOBAL...",
            "ANALISANDO 15.000+ PADRÕES OCULTOS...",
            "DECODIFICANDO ESTRATÉGIAS DE PREÇO...",
            "CALCULANDO PROBABILIDADE DE ÊXITO (IPM)...",
            "IDENTIFICANDO FALHAS NO EDITAL...",
            "CRUZANDO DADOS TÁTICOS...",
            "FINALIZANDO RELATÓRIO DE INTELIGÊNCIA..."
        ];
        
        // Start text cycle
        if(window.statusInterval) clearInterval(window.statusInterval);
        window.statusInterval = setInterval(() => {
            const randomPhrase = loadingPhrases[Math.floor(Math.random() * loadingPhrases.length)];
            const el = document.getElementById('loaderText');
            if(el) el.innerText = randomPhrase;
        }, 3000);

        try {
            const response = await fetch('/api/process-tr', { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Erro: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const eventData = JSON.parse(line.substring(6));

                            // Note: raw text is no longer sent by backend for privacy
                            // We only listen for final result or status updates
                            
                            if (eventData.metadata || eventData.ipm_score) {
                                // FINAL RESULT
                                currentData = eventData;
                                if (eventData.id) {
                                    currentOpportunityId = eventData.id;
                                }
                            }
                        } catch(e) {}
                    }
                }
            }
            
            
            if(window.statusInterval) clearInterval(window.statusInterval);

            // 3. Trigger Notification
            if (Notification.permission === "granted") {
                const notif = new Notification("MABUS INTEL", {
                    body: "Análise concluída com sucesso. O relatório estratégico está pronto.",
                    icon: "/favicon.ico",
                    tag: "analysis-complete"
                });
                notif.onclick = () => {
                    window.focus();
                    if(currentOpportunityId) {
                        window.location.href = `/oracle?id=${currentOpportunityId}`;
                    }
                };
            }

            showResult({
                ...currentData,
                id: currentOpportunityId, 
                unlocked_modules: []
            });

            // Reload history to show the new card
            // loadHistory is not defined in this scope, let's just refresh the list manually or via fetch if we had an endpoint
            // or we can reload the page if essential, but keeping SPA feel is better.
            // Let's implement a simple fetch for history
            fetchHistoryDeck();

        } catch (error) {
            console.error(error);
            alert("Erro Fatal: " + error.message);
            resetView();
        }
    }

    async function fetchHistoryDeck() {
        try {
            const res = await fetch('/api/oracle/history');
            if(res.ok) {
                const items = await res.json();
                renderHistoryDeck(items);
            }
        } catch(e) {
            console.error("Failed to refresh history:", e);
        }
    }

    // --- RENDER FULL ANALYSIS ---
    function renderFullAnalysis(data) {
        currentOpportunityId = data.id; 
        const meta = data.metadata || {};
        const lockedModules = data.locked_content || {};
        const unlockedList = data.unlocked_modules || [];

        document.getElementById('metaIdDisplay').innerText = data.id ? `#${data.id}` : 'NOVO';
        // ANIMATE SCORE
        const score = meta.ipm_score || data.ipm_score || 0;
        const scoreDisplay = document.getElementById('ipmDisplay');
        const circle = document.getElementById('scoreCircle');
        
        // Reset
        scoreDisplay.innerText = "0";
        if(circle) circle.style.strokeDashoffset = 753; // Full circumference

        // Animate Text
        let start = 0;
        const duration = 2000;
        const stepTime = 20;
        const steps = duration / stepTime;
        const increment = score / steps;
        
        const timer = setInterval(() => {
            start += increment;
            if (start >= score) {
                start = score;
                clearInterval(timer);
                
                // Final Pulse
                scoreDisplay.parentElement.parentElement.classList.add('scale-110');
                setTimeout(() => scoreDisplay.parentElement.parentElement.classList.remove('scale-110'), 200);
            }
            scoreDisplay.innerText = Math.floor(start);
        }, stepTime);

        // Animate Circle
        setTimeout(() => {
            if(circle) {
                const circumference = 753;
                const offset = circumference - (score / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
        }, 100);

        document.getElementById('classificacaoDisplay').innerText = meta.classificacao || 'ANÁLISE';
        document.getElementById('resumoDisplay').innerText = meta.resumo_glitch || meta.resumo_poderoso || '...';
        
        const tagsBox = document.getElementById('tagsDisplay');
        tagsBox.innerHTML = '';
        (meta.tags_visuais || meta.tags_elite || []).forEach(tag => {
            tagsBox.innerHTML += `<span class="neo-badge neo-badge-warning uppercase tracking-widest px-4 py-2 text-xs">${tag}</span>`;
        });

        const grid = document.getElementById('modulesGrid');
        grid.innerHTML = '';

        Object.keys(lockedModules).forEach(key => {
            const moduleData = lockedModules[key];
            const isUnlocked = unlockedList.includes(key);
            renderModuleCard(key, moduleData, isUnlocked, grid);
        });

        document.getElementById('sniperName').value = meta.edital_numero || 'Oracle Mission';
        document.getElementById('sniperMetadata').value = JSON.stringify(meta);
        if (data.file_path) document.getElementById('sniperExistingFilePath').value = data.file_path;
        document.getElementById('sniperGridData').value = "ID;Descricao;valor_venda;quantidade\n";
    }

    function renderModuleCard(key, data, isUnlocked, container) {
        const cost = data.custo_watts || 100;
        const domId = `card-${key}`;

        let innerHtml = '';
        if (data.taticas) {
            innerHtml = data.taticas.map(t => `
                <div class="bg-base-300/50 border-l-4 border-accent p-3 mb-2 rounded">
                    <div class="font-bold text-accent mb-1">${t.icone || ''} ${t.titulo}</div>
                    <div class="text-sm opacity-80">${t.texto}</div>
                </div>
            `).join('');
        } else if (data.dados) {
            innerHtml = `<table class="table table-sm w-full"><tbody>` + 
                data.dados.map(d => `<tr><td class="opacity-70">${d.label}</td><td class="font-bold text-right ${d.alerta === 'ALTO RISCO' || d.alerta === 'PERIGO' ? 'text-error' : 'text-success'}">${d.valor}</td></tr>`).join('') +
                `</tbody></table>`;
        } else if (data.lista_riscos) {
            innerHtml = `<ul class="space-y-2">` + 
                data.lista_riscos.map(r => `<li class="flex items-start gap-2 text-error text-sm font-medium"><i class="fas fa-exclamation-circle mt-1"></i> <span>${r}</span></li>`).join('') +
                `</ul>`;
        } else if (data.conteudo_oculto) {
            if(Array.isArray(data.conteudo_oculto)) {
                innerHtml = `<ul class="list-disc pl-4 space-y-1">` + data.conteudo_oculto.map(i => `<li>${i}</li>`).join('') + `</ul>`;
            } else {
                 innerHtml = marked.parse(data.conteudo_oculto);
            }
        }

        const isBlur = !isUnlocked;
        
        const cardHtml = `
            <div class="glass-panel h-full flex flex-col transform transition-all hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.4)] overflow-hidden relative group rounded-3xl" id="card-${key}">
                
                <div class="px-6 py-5 border-b border-white/5 bg-white/5 flex justify-between items-center relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-primary/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <h3 class="font-black text-md font-mono uppercase tracking-widest z-10 text-white flex items-center gap-2 truncate pr-2">
                        <i class="fas fa-cube text-primary/60"></i>
                        ${data.titulo || key}
                    </h3>
                    
                    ${!isUnlocked ? 
                        `<span class="neo-badge neo-badge-warning shrink-0"><i class="fas fa-bolt mr-1"></i> ${cost}</span>` : 
                        `<span class="neo-badge neo-badge-success shrink-0"><i class="fas fa-check mr-1"></i></span>`
                    }
                </div>
                
                <div class="p-8 flex-1 relative flex flex-col min-h-[250px]">
                    <!-- CONTENT -->
                    <div class="transition-all duration-700 flex-grow ${isBlur ? 'blur-md opacity-30 select-none pointer-events-none' : 'text-white/80'}" id="content-${key}">
                        ${innerHtml}
                    </div>

                    <!-- LOCK OVERLAY -->
                    ${isBlur ? `
                    <div class="absolute inset-0 z-20 flex flex-col items-center justify-center p-6 text-center" id="overlay-${key}">
                        <!-- Glass Overlay Background -->
                        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm z-[-1]"></div>
                        
                        <div class="mb-6 relative group/lock cursor-pointer transition-transform duration-300 hover:scale-110" onclick="unlockModule('${key}', ${cost})">
                            <div class="absolute -inset-8 bg-primary/20 rounded-full blur-2xl opacity-0 group-hover/lock:opacity-100 transition-opacity duration-500"></div>
                            <div class="relative w-16 h-16 rounded-full bg-white/5 border border-white/10 flex items-center justify-center shadow-2xl">
                                <i class="fas fa-lock text-2xl text-white/80 group-hover/lock:text-primary transition-colors duration-300"></i>
                            </div>
                        </div>
                        
                        <h4 class="font-bold text-white text-lg mb-2 tracking-tight">DADOS ENCRIPTADOS</h4>
                        <p class="text-white/40 text-xs mb-8 max-w-[220px] font-mono leading-relaxed">
                            Acesso restrito à inteligência estratégica.
                        </p>

                        <button onclick="unlockModule('${key}', ${cost})" class="btn-liquid w-full max-w-[180px] py-3 flex items-center justify-center gap-3 group/btn text-sm">
                            <span>DESBLOQUEAR</span>
                            <span class="w-px h-3 bg-white/20"></span>
                            <span class="font-mono text-primary-content">${cost} W</span>
                        </button>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;

        const wrapper = document.createElement('div');
        wrapper.innerHTML = cardHtml;
        container.appendChild(wrapper.firstElementChild);
    }

    async function unlockModule(key, cost) {
        if (!currentOpportunityId) {
            alert("Erro: ID da análise não encontrado. Tente recarregar a página.");
            return;
        }

        if(!confirm(`Desbloquear "${key}" por ${cost} Watts?`)) return;

        try {
            const btn = document.querySelector(`#overlay-${key} button`);
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading loading-spinner"></span> PROCESSANDO...';
            }

            const res = await fetch('/api/oracle/unlock-module', {
                headers: { 'Content-Type': 'application/json' },
                method: 'POST',
                body: JSON.stringify({ opportunityId: currentOpportunityId, moduleKey: key, cost: cost })
            });

            const json = await res.json();
            if (!res.ok) throw new Error(json.error || "Falha no desbloqueio");

            // Success
            currentUserCredits = json.newBalance;
            userCreditsEl.innerText = currentUserCredits;
            
            const overlay = document.getElementById(`overlay-${key}`);
            const content = document.getElementById(`content-${key}`);
            const badge = document.querySelector(`#card-${key} .badge`);

            if(overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
            }
            if(content) {
                content.classList.remove('locked-blur', 'opacity-50');
            }
            if(badge) {
                badge.className = "badge badge-success font-bold shadow-[0_0_15px_rgba(34,197,94,0.4)]";
                badge.innerHTML = '<i class="fas fa-check mr-1"></i> LIBERADO';
            }

        } catch (e) {
            alert(e.message);
            const btn = document.querySelector(`#overlay-${key} button`);
            if(btn) { btn.disabled = false; btn.innerText = `DESBLOQUEAR | ${cost}`; }
        }
    }

    async function enableNotifications() {
        if ("Notification" in window) {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                document.getElementById('notifyRequest').classList.add('hidden');
                new Notification("MABUS INTEL", { body: "Notificações ativadas." });
            }
        }
    }

</script>
