<%- include('partials/head') %>
<%- include('partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/js/neural_network.js"></script>

<!-- Custom Styles for Oracle Specifics -->
<style>
    .animate-float-slow { animation: float 8s ease-in-out infinite; }
    .animate-float-reverse { animation: float 10s ease-in-out infinite reverse; }
    
    .neon-text-glow { text-shadow: 0 0 10px rgba(0, 240, 255, 0.7); }
    .neon-box-glow { box-shadow: 0 0 20px rgba(112, 0, 255, 0.3); }

    .scanner-line {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 2px;
        background: linear-gradient(to right, transparent, #00F0FF, transparent);
        animation: scan 3s linear infinite;
        opacity: 0.5;
    }
    @keyframes scan {
        0% { transform: translateY(-100%); opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { transform: translateY(500px); opacity: 0; }
    }
</style>

<div class="min-h-screen flex flex-col items-center pb-20 relative overflow-hidden bg-cosmic-void">
    
    <!-- Ambient Background -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-neon-purple/10 rounded-full blur-[150px] animate-pulse-slow"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-neon-blue/10 rounded-full blur-[150px] animate-pulse-slow" style="animation-delay: 2s"></div>
    </div>

    <!-- Container -->
    <div class="container mx-auto px-4 py-8 max-w-6xl relative z-10">

        <!-- Header Controls -->
        <div class="flex justify-between items-center mb-12">
            <button onclick="resetView()" class="btn btn-ghost hover:bg-white/5 gap-2 group text-starlight hover:text-white transition-all">
                <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                <span class="tracking-widest text-xs font-bold">RESET PROTOCOL</span>
            </button>
            <div class="text-xs font-mono text-starlight/30 tracking-[0.3em]">ORACLE_SYS_V6.1 :: <span class="text-neon-blue animate-pulse">ONLINE</span></div>
        </div>

        <!-- =========== VIEW: UPLOAD ============ -->
        <div id="uploadView" class="transition-all duration-700 ease-out">
            <div class="text-center mb-16 relative">
                 <div class="inline-block relative">
                    <h1 class="text-7xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-white/10 tracking-tighter mb-4 relative z-10">ORACLE</h1>
                    <div class="absolute -top-10 -right-10 text-neon-purple/20 text-9xl blur-sm select-none z-0"><i class="fas fa-brain"></i></div>
                 </div>
                <p class="text-xl text-starlight/60 font-light tracking-wide max-w-2xl mx-auto">
                    Upload tactical documents for <span class="text-neon-blue font-bold">Deep Neural Analysis</span> & Strategic Decryption.
                </p>
            </div>

            <div id="uploadContainer" class="flex justify-center items-center perspective-1000">
                <form id="uploadForm" class="w-full max-w-2xl relative group transform hover:rotate-x-2 transition-transform duration-500">
                    <!-- Scanner Effect -->
                    <div class="absolute inset-0 z-20 pointer-events-none overflow-hidden rounded-[2.5rem] opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                        <div class="scanner-line"></div>
                    </div>

                    <!-- Glow Backdrop -->
                    <div class="absolute -inset-1 bg-gradient-to-r from-neon-blue via-neon-purple to-neon-blue rounded-[2.5rem] blur-xl opacity-20 group-hover:opacity-50 transition duration-500 animate-gradient-xy"></div>
                    
                    <label for="pdfFiles" class="relative w-full h-96 glass-card rounded-[2.5rem] flex flex-col justify-center items-center cursor-pointer hover:border-neon-blue/50 transition-all duration-300 group-hover:shadow-[0_0_50px_rgba(0,240,255,0.2)]" id="dropZoneArea">
                        <div class="relative mb-8">
                            <div class="absolute inset-0 bg-neon-blue/20 rounded-full blur-xl animate-pulse-slow"></div>
                            <div class="w-24 h-24 rounded-full bg-black/40 border border-white/10 flex items-center justify-center relative z-10 group-hover:scale-110 transition-transform duration-300">
                                <i class="fas fa-cloud-upload-alt text-4xl text-white group-hover:text-neon-blue transition-colors"></i>
                            </div>
                        </div>
                        
                        <div class="text-3xl font-bold text-white tracking-tight group-hover:text-neon-blue transition-colors">INITIATE UPLOAD</div>
                        <div class="text-starlight/40 mt-3 font-mono text-xs tracking-widest uppercase border border-white/10 px-3 py-1 rounded-full">PDF Files Only â€¢ Secure Channel</div>
                        <input type="file" id="pdfFiles" name="pdfFiles" accept=".pdf" multiple hidden required>
                    </label>
                </form>
            </div>

            <!-- NEURAL LOADER -->
            <div id="loader" class="hidden text-center py-20 flex flex-col items-center min-h-[50vh] justify-center relative">
                <!-- Canvas Container -->
                <div class="relative w-full max-w-lg aspect-square mb-8">
                    <canvas id="neuralCanvas" class="w-full h-full opacity-80 mix-blend-screen"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                         <div class="w-32 h-32 rounded-full border border-neon-blue/30 animate-ping"></div>
                         <div class="w-48 h-48 rounded-full border border-neon-purple/20 animate-ping" style="animation-delay: 0.5s"></div>
                    </div>
                </div>

                <div class="text-4xl font-black text-white mb-2 tracking-tighter animate-pulse" id="loaderTitle">
                    PROCESSING NEURAL DATA
                </div>
                
                <div class="h-8 relative overflow-hidden w-full max-w-md bg-black/20 rounded-full border border-white/5">
                     <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-neon-blue to-neon-purple opacity-50 animate-progress"></div>
                     <div class="absolute inset-0 flex items-center justify-center text-xs font-mono font-bold text-white z-10" id="loaderText">
                        INITIALIZING...
                     </div>
                </div>

                <div id="notifyRequest" class="mt-8 hidden animate-fade-in-up">
                    <button onclick="enableNotifications()" class="btn btn-outline btn-sm border-neon-blue text-neon-blue hover:bg-neon-blue hover:text-black gap-2 transition-all shadow-[0_0_20px_rgba(0,240,255,0.3)]">
                        <i class="fas fa-bell"></i>
                        NOTIFY ON COMPLETION
                    </button>
                    <p class="text-[10px] text-starlight/30 mt-2 font-mono">Process may take several minutes.</p>
                </div>
            </div>
        </div>

        <!-- =========== VIEW: RESULT ============ -->
        <div id="resultView" class="hidden transition-opacity duration-700">
            <!-- Header Info -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-16 items-center">
                
                <!-- Left: Tags & Class -->
                <div class="text-center lg:text-left order-2 lg:order-1">
                    <div id="metaIdDisplay" class="text-xs font-mono text-starlight/30 mb-2">#ID_UNKNOWN</div>
                    <div id="classificacaoDisplay" class="text-4xl lg:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-starlight uppercase leading-none mb-6">---</div>
                    <div id="tagsDisplay" class="flex flex-wrap gap-2 justify-center lg:justify-start"></div>
                </div>

                <!-- Center: Score (The Core) -->
                <div class="relative h-64 w-64 mx-auto flex items-center justify-center order-1 lg:order-2 group">
                    <!-- Rotating Rings -->
                    <div class="absolute inset-0 border-2 border-neon-blue/30 rounded-full border-t-transparent animate-spin duration-[10s]"></div>
                    <div class="absolute inset-4 border-2 border-neon-purple/30 rounded-full border-b-transparent animate-spin duration-[15s] reverse"></div>
                    <div class="absolute inset-0 bg-neon-blue/5 rounded-full blur-xl group-hover:bg-neon-blue/10 transition-colors duration-500"></div>

                    <!-- Score Value -->
                    <div class="text-center relative z-10">
                        <div id="ipmDisplay" class="text-7xl font-black text-white drop-shadow-[0_0_20px_rgba(0,240,255,0.8)] font-sans tracking-tighter">0</div>
                         <div class="text-xs font-bold tracking-[0.4em] text-neon-blue mt-1">IPM SCORE</div>
                    </div>
                </div>

                <!-- Right: Summary -->
                <div class="glass-card p-6 rounded-2xl order-3 relative overflow-hidden group hover:border-white/20 transition-colors">
                     <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-30 transition-opacity">
                        <i class="fas fa-quote-right text-4xl text-white"></i>
                     </div>
                     <h3 class="text-xs font-bold text-neon-purple mb-3 tracking-widest uppercase">Strategic Insight</h3>
                     <p id="resumoDisplay" class="text-lg text-starlight/90 leading-relaxed font-light">...</p>
                </div>
            </div>

            <!-- MODULES GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-8 mb-24" id="modulesGrid">
                <!-- JS Injected Cards -->
            </div>

            <!-- ACTION FOOTER -->
            <div class="text-center pb-20 border-t border-white/5 pt-12">
                <h3 class="text-2xl font-bold text-white mb-8 tracking-tight">READY TO ENGAGE?</h3>
                <form action="/create" method="POST" id="sniperForm" class="inline-block relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-neon-blue to-neon-purple rounded-full blur opacity-30 group-hover:opacity-70 transition duration-300"></div>
                    
                    <input type="hidden" name="name" id="sniperName">
                    <input type="hidden" name="cep" value="00000-000">
                    <input type="hidden" name="gridData" id="sniperGridData">
                    <input type="hidden" name="metadataJSON" id="sniperMetadata">
                    <input type="hidden" name="moduleName" value="gemini_meli">
                    <input type="hidden" name="existingFilePath" id="sniperExistingFilePath">

                    <button type="submit" class="btn btn-lg h-16 px-12 rounded-full relative bg-black border border-white/20 text-white font-black text-xl tracking-widest overflow-hidden group-hover:text-neon-blue transition-colors">
                         <span class="relative z-10 flex items-center gap-3">
                            <i class="fas fa-crosshairs"></i>
                            LAUNCH SNIPER
                         </span>
                    </button>
                </form>
            </div>
        </div>

        <!-- HISTORY DECK -->
        <div class="mt-20 pt-10 border-t border-white/5">
            <h2 class="text-xl font-bold text-starlight mb-8 flex items-center gap-3 tracking-widest uppercase text-xs">
                <i class="fas fa-history text-neon-purple"></i> 
                Transmission Log
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-5" id="historyGrid">
                <div class="col-span-full text-center py-10 opacity-30 font-mono text-xs">LOADING ARCHIVES...</div>
            </div>
        </div>

    </div>
</div>

<%- include('partials/footer') %>

<script>
    // Logic remains similar but updating render functions for new classes
    let currentOpportunityId = null;
    let currentUserCredits = <%= user.current_credits %>;
    const historyGrid = document.getElementById('historyGrid');
    const userCreditsEl = document.getElementById('userCredits'); // Make sure header has this ID updated if changed

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        const initialHistory = <%- JSON.stringify(history || []) %>;
        renderHistoryDeck(initialHistory);

        const deepLinkData = <%- JSON.stringify(initialOpportunity || null) %>;
        if(deepLinkData) {
            try {
                const parsed = {
                    id: deepLinkData.id,
                    metadata: typeof deepLinkData.metadata_json === 'string' ? JSON.parse(deepLinkData.metadata_json || '{}') : deepLinkData.metadata_json,
                    locked_content: typeof deepLinkData.locked_content_json === 'string' ? JSON.parse(deepLinkData.locked_content_json || '{}') : deepLinkData.locked_content_json,
                    items: typeof deepLinkData.items_json === 'string' ? JSON.parse(deepLinkData.items_json || '[]') : deepLinkData.items_json,
                    unlocked_modules: typeof deepLinkData.unlocked_modules === 'string' ? JSON.parse(deepLinkData.unlocked_modules || '[]') : (deepLinkData.unlocked_modules || []),
                    file_path: "" 
                };
                showResult(parsed);
            } catch(e) {
                console.error("Deep link parse error", e);
            }
        }
    });

    // --- VIEW MANAGEMENT ---
    function showUpload() {
        document.getElementById('uploadView').classList.remove('hidden');
        document.getElementById('resultView').classList.add('hidden');
        currentOpportunityId = null;
        document.getElementById('uploadForm').reset();
        
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('uploadContainer').style.display = 'flex';
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showResult(data) {
        document.getElementById('uploadView').classList.add('hidden');
        document.getElementById('resultView').classList.remove('hidden');
        // ensure loader hidden
        document.getElementById('loader').classList.add('hidden'); 
        renderFullAnalysis(data);
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetView() {
        showUpload();
    }

    // --- HISTORY DECK ---
    function renderHistoryDeck(items) {
        historyGrid.innerHTML = '';
        if(items.length === 0) {
            historyGrid.innerHTML = '<div class="col-span-full text-center p-8 border border-dashed border-white/10 rounded-2xl text-starlight/30 text-xs">No recent transmissions found.</div>';
            return;
        }

        items.forEach(item => {
            const meta = typeof item.metadata_json === 'string' ? JSON.parse(item.metadata_json || '{}') : item.metadata_json;
            const unlocked = typeof item.unlocked_modules === 'string' ? JSON.parse(item.unlocked_modules || '[]') : (item.unlocked_modules || []);
            const score = item.ipm_score || 0;
            const title = item.title || 'Untitled';
            const date = new Date(item.created_at).toLocaleDateString();
            const unlockedCount = unlocked.length;

            const card = document.createElement('div');
            card.className = `glass-card p-5 rounded-xl cursor-pointer group relative hover:-translate-y-1 transition-transform duration-300`;
            card.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <div class="px-2 py-1 rounded bg-white/5 border border-white/10 text-[10px] font-bold ${score > 70 ? 'text-neon-blue' : 'text-white'}">${score} IPM</div>
                    <div class="text-[10px] opacity-40 font-mono">${date}</div>
                </div>
                
                <h4 class="font-bold text-sm text-white group-hover:text-neon-purple transition-colors line-clamp-2 mb-2">${title}</h4>
                
                <div class="flex items-center gap-2 mt-auto pt-3 border-t border-white/5 text-[10px] font-bold ${unlockedCount > 0 ? 'text-success' : 'text-starlight/30'}">
                     <i class="fas ${unlockedCount > 0 ? 'fa-lock-open' : 'fa-lock'}"></i>
                     ${unlockedCount > 0 ? `${unlockedCount} UNLOCKED` : 'LOCKED'}
                </div>
            `;
            card.onclick = () => loadAnalysis(item.id);
            historyGrid.appendChild(card);
        });
    }

    async function loadAnalysis(id) {
        try {
            document.getElementById('resultView').classList.add('hidden');
            document.getElementById('uploadView').classList.remove('hidden');
            document.getElementById('uploadContainer').style.display = 'none';
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('loaderText').innerText = "RETRIEVING ARCHIVED DATA..."; 

            const res = await fetch(`/api/oracle/history/${id}`);
            if(!res.ok) throw new Error("Load failed");
            const data = await res.json();

            const parsed = {
                id: data.id,
                metadata: typeof data.metadata_json === 'string' ? JSON.parse(data.metadata_json) : data.metadata_json,
                locked_content: typeof data.locked_content_json === 'string' ? JSON.parse(data.locked_content_json) : data.locked_content_json,
                items: typeof data.items_json === 'string' ? JSON.parse(data.items_json) : data.items_json,
                unlocked_modules: typeof data.unlocked_modules === 'string' ? JSON.parse(data.unlocked_modules) : (data.unlocked_modules || []),
                file_path: "" 
            };
            
            showResult(parsed);

        } catch(e) {
            console.error(e);
            alert("Error loading analysis.");
            resetView();
        }
    }

    // --- RENDER FULL ANALYSIS ---
    function renderFullAnalysis(data) {
        currentOpportunityId = data.id; 
        const meta = data.metadata || {};
        const lockedModules = data.locked_content || {};
        const unlockedList = data.unlocked_modules || [];

        document.getElementById('metaIdDisplay').innerText = data.id ? `#${data.id}` : 'NEW_ANALYSIS';
        
        // Animate Score
        const score = meta.ipm_score || data.ipm_score || 0;
        const scoreDisplay = document.getElementById('ipmDisplay');
        let start = 0;
        const interval = setInterval(() => {
            start += 1;
            if(start >= score) {
                start = score;
                clearInterval(interval);
            }
            scoreDisplay.innerText = start;
        }, 20);

        document.getElementById('classificacaoDisplay').innerText = meta.classificacao || 'ANALYSIS READY';
        document.getElementById('resumoDisplay').innerText = meta.resumo_glitch || meta.resumo_poderoso || 'Intelligence report generated successfully.';
        
        const tagsBox = document.getElementById('tagsDisplay');
        tagsBox.innerHTML = '';
        (meta.tags_visuais || meta.tags_elite || []).forEach(tag => {
            tagsBox.innerHTML += `<span class="px-3 py-1 rounded-md bg-white/5 border border-white/10 text-[10px] font-bold uppercase tracking-wider text-starlight hover:bg-neon-blue/20 hover:border-neon-blue/50 transition-colors">${tag}</span>`;
        });

        const grid = document.getElementById('modulesGrid');
        grid.innerHTML = '';

        Object.keys(lockedModules).forEach(key => {
            const moduleData = lockedModules[key];
            const isUnlocked = unlockedList.includes(key);
            renderModuleCard(key, moduleData, isUnlocked, grid);
        });

        // Setup Sniper Form
        document.getElementById('sniperName').value = meta.edital_numero || 'Oracle Mission';
        document.getElementById('sniperMetadata').value = JSON.stringify(meta);
        if (data.file_path) document.getElementById('sniperExistingFilePath').value = data.file_path;
        document.getElementById('sniperGridData').value = "ID;Descricao;valor_venda;quantidade\n";
    }

    function renderModuleCard(key, data, isUnlocked, container) {
        const cost = data.custo_watts || 100;
        const isBlur = !isUnlocked;
        
        let innerHtml = '';
        // Content rendering logic...
        if (data.taticas) {
            innerHtml = data.taticas.map(t => `<div class="mb-3 p-3 rounded bg-white/5 border-l-2 border-neon-blue"><div class="font-bold text-neon-blue text-sm mb-1">${t.titulo}</div><div class="text-xs opacity-70">${t.texto}</div></div>`).join('');
        } else if (data.dados) {
            innerHtml = `<table class="w-full text-sm"><tbody>` + 
                data.dados.map(d => `<tr class="border-b border-white/5"><td class="py-2 opacity-70">${d.label}</td><td class="text-right font-bold ${d.alerta === 'ALTO RISCO' ? 'text-error' : 'text-success'}">${d.valor}</td></tr>`).join('') +
                `</tbody></table>`;
        } else if (data.lista_riscos) {
            innerHtml = `<ul class="space-y-2 text-sm">` + 
                data.lista_riscos.map(r => `<li class="flex gap-2 text-error"><i class="fas fa-exclamation-triangle mt-1"></i> <span>${r}</span></li>`).join('') +
                `</ul>`;
        } else if (data.conteudo_oculto) {
            if(Array.isArray(data.conteudo_oculto)) {
                innerHtml = `<ul class="list-disc pl-4 space-y-1 text-sm opacity-80">` + data.conteudo_oculto.map(i => `<li>${i}</li>`).join('') + `</ul>`;
            } else {
                 innerHtml = marked.parse(data.conteudo_oculto);
            }
        }

        const card = document.createElement('div');
        card.className = `glass-card rounded-3xl overflow-hidden flex flex-col h-full min-h-[300px] relative group`;
        card.innerHTML = `
            <div class="px-6 py-4 bg-white/5 border-b border-white/10 flex justify-between items-center">
                <h3 class="font-bold text-white uppercase tracking-widest text-xs flex items-center gap-2">
                    <i class="fas fa-cube text-neon-purple"></i> ${data.titulo || key}
                </h3>
                ${!isUnlocked ? `<span class="text-[10px] font-bold text-warning"><i class="fas fa-bolt"></i> ${cost}</span>` : `<span class="text-success"><i class="fas fa-check"></i></span>`}
            </div>
            
            <div class="p-6 flex-1 relative">
                <div class="transition-all duration-500 h-full ${isBlur ? 'blur-md opacity-30 select-none' : 'text-starlight'}" id="content-${key}">
                    ${innerHtml}
                </div>

                ${isBlur ? `
                <div class="absolute inset-0 flex flex-col items-center justify-center z-20 text-center p-6 bg-black/40 backdrop-blur-sm transition-opacity duration-300" id="overlay-${key}">
                    <div class="w-16 h-16 rounded-full bg-white/5 border border-white/10 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform cursor-pointer" onclick="unlockModule('${key}', ${cost})">
                        <i class="fas fa-lock text-2xl text-starlight group-hover:text-neon-blue transition-colors"></i>
                    </div>
                    <h4 class="font-bold text-white mb-2">ENCRYPTED DATA</h4>
                    <button onclick="unlockModule('${key}', ${cost})" class="btn btn-sm rounded-full bg-neon-blue/20 border-neon-blue/40 text-neon-blue hover:bg-neon-blue/40 gap-2 px-6 tracking-widest text-[10px]">
                        UNLOCK <span class="opacity-50">|</span> ${cost} W
                    </button>
                </div>
                ` : ''}
            </div>
        `;
        container.appendChild(card);
    }

    async function unlockModule(key, cost) {
        if (!currentOpportunityId) return;
        if(!confirm(`Unlock module for ${cost} Watts?`)) return;

        const overlay = document.getElementById(`overlay-${key}`);
        const content = document.getElementById(`content-${key}`);
        const btn = overlay.querySelector('button');
        if(btn) { btn.innerHTML = 'DECRYPTING...'; btn.disabled = true; }

        try {
            const res = await fetch('/api/oracle/unlock-module', {
                headers: { 'Content-Type': 'application/json' },
                method: 'POST',
                body: JSON.stringify({ opportunityId: currentOpportunityId, moduleKey: key, cost: cost })
            });
            const json = await res.json();
            if (!res.ok) throw new Error(json.error || "Unlock failed");

            currentUserCredits = json.newBalance;
            if(userCreditsEl) userCreditsEl.innerText = currentUserCredits; // Update header info if present

            // Animate Unlock
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 300);
            content.classList.remove('blur-md', 'opacity-30', 'select-none');

        } catch (e) {
            alert(e.message);
            if(btn) { btn.innerHTML = `UNLOCK | ${cost} W`; btn.disabled = false; }
        }
    }

    // --- UPLOAD LOGIC ---
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('pdfFiles');
    const dropZone = document.getElementById('dropZoneArea');
    
    fileInput.addEventListener('change', handleUpload);
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => e.preventDefault());
    
    // Simple drag effects
    dropZone.addEventListener('dragenter', () => dropZone.classList.add('border-neon-blue'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-neon-blue'));
    dropZone.addEventListener('drop', (e) => {
        dropZone.classList.remove('border-neon-blue');
        fileInput.files = e.dataTransfer.files;
        handleUpload();
    });

    async function handleUpload() {
        if (fileInput.files.length === 0) return;
        
        document.getElementById('uploadContainer').style.display = 'none';
        document.getElementById('loader').classList.remove('hidden');
        
        // Init Canvas Animation
        if(window.NeuralLoader) new NeuralLoader('neuralCanvas'); // Assuming lib exists

        const formData = new FormData(uploadForm);
        let currentData = {};

        try {
            const response = await fetch('/api/process-tr', { method: 'POST', body: formData });
            if (!response.ok) throw new Error("Upload Error");

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const eventData = JSON.parse(line.substring(6));
                            if (eventData.metadata || eventData.ipm_score) {
                                currentData = eventData;
                                if(eventData.id) currentOpportunityId = eventData.id;
                            }
                            // Update Status Text
                            const loaderText = document.getElementById('loaderText');
                            if(eventData.status) loaderText.innerText = eventData.status.toUpperCase();
                        } catch(e) {}
                    }
                }
            }

            // Finish
            showResult({ ...currentData, id: currentOpportunityId, unlocked_modules: [] });
            fetchHistoryDeck();

        } catch (error) {
            console.error(error);
            alert("Process Failed: " + error.message);
            resetView();
        }
    }

    async function fetchHistoryDeck() {
        try {
            const res = await fetch('/api/oracle/history');
            if(res.ok) {
                const items = await res.json();
                renderHistoryDeck(items);
            }
        } catch(e) {}
    }

    function enableNotifications() {
        Notification.requestPermission();
    }
</script>
