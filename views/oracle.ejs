<%- include('partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* Custom Scrollbar for Sidebar */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.1); border-radius: 20px; }

    /* Module Locking Effects */
    .locked-blur { filter: blur(8px); pointer-events: none; user-select: none; }
    .lock-overlay { 
        position: absolute; inset: 0; 
        display: flex; flex-direction: column; justify-content: center; items-center;
        background: rgba(0,0,0,0.4); backdrop-filter: blur(2px);
        z-index: 10; transition: opacity 0.3s ease;
    }
</style>

<div class="flex h-[calc(100vh-80px)] overflow-hidden">
    
    <!-- SIDEBAR (History) -->
    <div class="w-80 bg-base-200 border-r border-base-300 flex flex-col h-full shrink-0">
        <div class="p-4 border-b border-base-300">
            <h2 class="text-xl font-black tracking-tight text-primary"><i class="fas fa-history mr-2"></i>HISTÓRICO</h2>
        </div>
        <div class="overflow-y-auto flex-1 scrollbar-thin p-2 space-y-2" id="historyList">
            <!-- Loaded via JS -->
            <div class="text-center py-10 opacity-50"><i class="fas fa-circle-notch fa-spin"></i></div>
        </div>
        <div class="p-4 border-t border-base-300">
            <button onclick="resetView()" class="btn btn-outline btn-block"><i class="fas fa-plus mr-2"></i>NOVA ANÁLISE</button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-1 overflow-y-auto relative scrollbar-thin" id="mainScroll">
        <div class="container mx-auto px-6 py-10 max-w-6xl">

            <!-- VIEW: UPLOAD (Default) -->
            <div id="uploadView" class="animate-fade-in-up">
                <div class="text-center mb-10">
                    <h1 class="text-6xl font-black text-base-content tracking-tighter mb-2">ORÁCULO <span class="text-primary">V5</span></h1>
                    <p class="text-xl text-base-content/60 font-light">Inteligência Estratégica & Decodificação de Editais</p>
                </div>

                <div id="uploadContainer" class="flex justify-center items-center min-h-[40vh]">
                    <form id="uploadForm" class="w-full max-w-3xl">
                        <label for="pdfFiles" class="w-full h-80 border-2 border-dashed border-base-300 rounded-3xl flex flex-col justify-center items-center cursor-pointer hover:border-primary hover:bg-base-200/50 transition-all bg-base-100 shadow-xl relative group" id="dropZoneArea">
                            <div class="p-6 rounded-full bg-base-200 group-hover:scale-110 transition-transform mb-6">
                                <i class="fas fa-brain fa-3x text-primary"></i>
                            </div>
                            <div class="text-2xl font-bold text-base-content drop-zone-text">ARRASTE O EDITAL</div>
                            <div class="text-base-content/60 mt-2">A I.A. vai encontrar o que eles esconderam.</div>
                            <input type="file" id="pdfFiles" name="pdfFiles" accept=".pdf" multiple hidden required>
                        </label>
                    </form>
                </div>

                <!-- LOADER -->
                <div id="loader" class="hidden text-center py-20 flex flex-col items-center">
                    <div class="mb-6">
                        <span class="loading loading-infinity loading-lg text-primary scale-150"></span>
                    </div>
                    <div class="text-2xl font-bold text-base-content animate-pulse mb-4" id="loaderText">Iniciando Varredura Neural...</div>
                    
                    <!-- NEURAL STREAM LOG -->
                    <div class="w-full max-w-2xl bg-base-300/50 rounded-xl p-4 text-left border border-primary/20 h-64 overflow-y-auto relative font-mono text-sm leading-relaxed" id="thoughtDisplay">
                        <!-- Stream content goes here -->
                    </div>
                </div>
            </div>

            <!-- VIEW: RESULT (Analysis) -->
            <div id="resultView" class="hidden animate-fade-in">
                <!-- Header / Teaser -->
                <div class="text-center mb-12 relative">
                    <div class="absolute top-0 right-0">
                         <div class="badge badge-lg badge-ghost gap-2 font-mono" id="metaIdDisplay">ID: #000</div>
                    </div>

                    <div id="ipmDisplay" class="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-error to-primary inline-block mb-2 transform hover:scale-105 transition-transform cursor-help" title="Índice de Potencial Mabus">0</div>
                    <div class="text-sm font-bold tracking-[0.3em] opacity-50 mb-4">IPM SCORE</div>
                    
                    <div id="classificacaoDisplay" class="text-3xl font-bold tracking-widest text-warning mb-6 glitch-effect">---</div>
                    
                    <div id="tagsDisplay" class="flex flex-wrap justify-center gap-2 mb-8"></div>
                    
                    <div class="bg-base-200/50 p-6 rounded-2xl border border-base-300 backdrop-blur-sm max-w-4xl mx-auto">
                        <i class="fas fa-quote-left text-primary/30 text-2xl absolute top-4 left-4"></i>
                        <p id="resumoDisplay" class="text-2xl text-base-content font-serif italic relative z-10 leading-relaxed">...</p>
                        <i class="fas fa-quote-right text-primary/30 text-2xl absolute bottom-4 right-4"></i>
                    </div>
                </div>

                <!-- Current Credits Display (Sticky) -->
                <div class="fixed top-24 right-6 z-50 bg-base-100 shadow-xl rounded-full px-4 py-2 border border-warning flex items-center gap-2">
                    <i class="fas fa-bolt text-warning animate-pulse"></i>
                    <span class="font-bold font-mono" id="userCredits"><%= user.current_credits %></span> Watts
                </div>

                <!-- MODULES GRID -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8 mb-20" id="modulesGrid">
                    <!-- Cards injected here -->
                </div>

                <!-- SNIPER ACTION -->
                <div class="text-center pb-20 border-t border-base-300 pt-10">
                    <h3 class="text-2xl font-bold mb-6">Pronto para o Ataque?</h3>
                    <form action="/create" method="POST" id="sniperForm" class="inline-block">
                        <input type="hidden" name="name" id="sniperName">
                        <input type="hidden" name="cep" value="00000-000">
                        <input type="hidden" name="gridData" id="sniperGridData">
                        <input type="hidden" name="metadataJSON" id="sniperMetadata">
                        <input type="hidden" name="moduleName" value="gemini_meli">
                        <input type="hidden" name="existingFilePath" id="sniperExistingFilePath">

                        <button type="submit" class="btn btn-primary btn-lg rounded-full px-12 text-xl shadow-lg hover:shadow-primary/50 hover:scale-105 transition-all">
                            <i class="fas fa-crosshairs mr-2"></i> INICIAR CAPTURA (SNIPER)
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    let currentOpportunityId = null;
    let currentUserCredits = <%= user.current_credits %>;
    const historyList = document.getElementById('historyList');
    const userCreditsEl = document.getElementById('userCredits');

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        const initialHistory = <%- JSON.stringify(history || []) %>;
        renderHistoryList(initialHistory);
    });

    // --- VIEW MANAGEMENT ---
    function showUpload() {
        document.getElementById('uploadView').classList.remove('hidden');
        document.getElementById('resultView').classList.add('hidden');
        currentOpportunityId = null;
        document.getElementById('uploadForm').reset();
        
        // Reset Loader UI
        document.getElementById('thoughtDisplay').innerHTML = '';
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('uploadContainer').style.display = 'flex';
    }

    function showResult(data) {
        document.getElementById('uploadView').classList.add('hidden');
        document.getElementById('resultView').classList.remove('hidden');
        document.getElementById('loader').classList.add('hidden');
        renderFullAnalysis(data);
    }

    function resetView() {
        showUpload();
    }

    // --- HISTORY SIDEBAR ---
    function renderHistoryList(items) {
        historyList.innerHTML = '';
        if(items.length === 0) {
            historyList.innerHTML = '<div class="text-center p-4 text-sm opacity-50">Sem histórico recente.</div>';
            return;
        }

        items.forEach(item => {
            const meta = typeof item.metadata_json === 'string' ? JSON.parse(item.metadata_json || '{}') : item.metadata_json;
            const score = item.ipm_score || '?';
            const title = item.title || 'Sem Título';
            const date = new Date(item.created_at).toLocaleDateString();

            const el = document.createElement('div');
            el.className = `p-3 rounded-xl bg-base-100 border border-transparent hover:border-primary cursor-pointer transition-all hover:bg-base-200 group`;
            el.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="font-bold text-sm line-clamp-1 group-hover:text-primary transition-colors">${title}</span>
                    <span class="badge badge-sm ${score > 70 ? 'badge-success' : 'badge-ghost'} font-mono">${score}</span>
                </div>
                <div class="flex justify-between items-center text-xs opacity-60">
                    <span>${date}</span>
                    <i class="fas fa-chevron-right text-[10px] group-hover:translate-x-1 transition-transform"></i>
                </div>
            `;
            el.onclick = () => loadAnalysis(item.id);
            historyList.appendChild(el);
        });
    }

    async function loadAnalysis(id) {
        try {
            document.getElementById('mainScroll').scrollTo(0,0);
            
            document.getElementById('resultView').classList.add('hidden');
            document.getElementById('uploadView').classList.remove('hidden');
            document.getElementById('uploadContainer').style.display = 'none';
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('loaderText').innerText = "Carregando Arquivos...";
            document.getElementById('thoughtDisplay').innerText = ""; // No thoughts for history load

            const res = await fetch(`/api/oracle/history/${id}`);
            if(!res.ok) throw new Error("Erro ao carregar");
            const data = await res.json();

            const parsed = {
                id: data.id,
                metadata: typeof data.metadata_json === 'string' ? JSON.parse(data.metadata_json) : data.metadata_json,
                locked_content: typeof data.locked_content_json === 'string' ? JSON.parse(data.locked_content_json) : data.locked_content_json,
                items: typeof data.items_json === 'string' ? JSON.parse(data.items_json) : data.items_json,
                unlocked_modules: typeof data.unlocked_modules === 'string' ? JSON.parse(data.unlocked_modules) : (data.unlocked_modules || []),
                file_path: "" 
            };
            
            showResult(parsed);

        } catch(e) {
            console.error(e);
            alert("Erro ao carregar análise.");
            resetView();
        }
    }


    // --- UPLOAD LOGIC ---
    const dropZone = document.getElementById('dropZoneArea');
    const fileInput = document.getElementById('pdfFiles');
    const uploadForm = document.getElementById('uploadForm');

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => { e.preventDefault(); dropZone.classList.add('border-primary', 'bg-base-200'); }, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => { e.preventDefault(); dropZone.classList.remove('border-primary', 'bg-base-200'); }, false);
    });
    dropZone.addEventListener('drop', (e) => { fileInput.files = e.dataTransfer.files; handleUpload(); });
    fileInput.addEventListener('change', handleUpload);

    async function handleUpload() {
        if (fileInput.files.length === 0) return;

        document.getElementById('uploadContainer').style.display = 'none';
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('loaderText').innerText = "Processando com Mabus Deep Strategy...";
        
        // Reset and prepare Thought Box
        const thoughtBox = document.getElementById('thoughtDisplay');
        thoughtBox.innerHTML = '<span class="text-primary font-mono text-xs block mb-2 opacity-50">/// NEURAL STREAM ESTABLISHED ///</span><span id="thinkingContent" class="font-mono text-sm leading-relaxed whitespace-pre-wrap"></span>';
        const thinkingContent = document.getElementById('thinkingContent');

        const formData = new FormData(uploadForm);
        let currentData = {};

        try {
            const response = await fetch('/api/process-tr', { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Erro: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const eventData = JSON.parse(line.substring(6));

                            if (eventData.message) { 
                                document.getElementById('loaderText').innerText = eventData.message;
                            }
                            
                            if (eventData.text) { 
                                // Stream Thoughts
                                thinkingContent.textContent += eventData.text;
                                thoughtBox.scrollTop = thoughtBox.scrollHeight;
                            }

                            if (eventData.metadata || eventData.ipm_score) {
                                // FINAL RESULT
                                currentData = eventData;
                                if (eventData.id) {
                                    currentOpportunityId = eventData.id;
                                    console.log("Analysis ID captured:", currentOpportunityId);
                                }
                            }
                        } catch(e) {}
                    }
                }
            }
             
            showResult({
                ...currentData,
                id: currentOpportunityId, 
                unlocked_modules: []
            });

            // Reload sidebar to see the new addition
            // We can fetch just the history endpoint if we had one that returns list,
            // but for now we might rely on page refresh OR let's try to reload history if possible.
            // Since we don't have a separated API for just list (we have /api/oracle/history/:id),
            // we will let the sidebar be stale until refresh. 
            // Better UX: User can refresh manually.

        } catch (error) {
            console.error(error);
            alert("Erro Fatal: " + error.message);
            resetView();
        }
    }


    // --- RENDER LOGIC ---
    function renderFullAnalysis(data) {
        currentOpportunityId = data.id; 
        const meta = data.metadata || {};
        const lockedModules = data.locked_content || {};
        const unlockedList = data.unlocked_modules || [];

        document.getElementById('metaIdDisplay').innerText = data.id ? `ID: #${data.id}` : 'NOVO';
        document.getElementById('ipmDisplay').innerText = meta.ipm_score || data.ipm_score || 0;
        document.getElementById('classificacaoDisplay').innerText = meta.classificacao || 'ANÁLISE';
        document.getElementById('resumoDisplay').innerText = meta.resumo_glitch || meta.resumo_poderoso || '...';
        
        const tagsBox = document.getElementById('tagsDisplay');
        tagsBox.innerHTML = '';
        (meta.tags_visuais || meta.tags_elite || []).forEach(tag => {
            tagsBox.innerHTML += `<span class="badge badge-lg badge-outline border-2 font-bold p-4">${tag}</span>`;
        });

        const grid = document.getElementById('modulesGrid');
        grid.innerHTML = '';

        Object.keys(lockedModules).forEach(key => {
            const moduleData = lockedModules[key];
            const isUnlocked = unlockedList.includes(key);
            renderModuleCard(key, moduleData, isUnlocked, grid);
        });

        document.getElementById('sniperName').value = meta.edital_numero || 'Oracle Mission';
        document.getElementById('sniperMetadata').value = JSON.stringify(meta);
        if (data.file_path) document.getElementById('sniperExistingFilePath').value = data.file_path;
        document.getElementById('sniperGridData').value = "ID;Descricao;valor_venda;quantidade\n";
    }

    function renderModuleCard(key, data, isUnlocked, container) {
        const cost = data.custo_watts || 100;
        const domId = `card-${key}`;

        let innerHtml = '';
        if (data.taticas) {
            innerHtml = data.taticas.map(t => `
                <div class="bg-base-300/50 border-l-4 border-accent p-3 mb-2 rounded">
                    <div class="font-bold text-accent mb-1">${t.icone || ''} ${t.titulo}</div>
                    <div class="text-sm opacity-80">${t.texto}</div>
                </div>
            `).join('');
        } else if (data.dados) {
            innerHtml = `<table class="table table-sm w-full"><tbody>` + 
                data.dados.map(d => `<tr><td class="opacity-70">${d.label}</td><td class="font-bold text-right ${d.alerta === 'ALTO RISCO' ? 'text-error' : ''}">${d.valor}</td></tr>`).join('') +
                `</tbody></table>`;
        } else if (data.lista_riscos) {
            innerHtml = `<ul class="space-y-2">` + 
                data.lista_riscos.map(r => `<li class="flex items-start gap-2 text-error text-sm font-medium"><i class="fas fa-exclamation-circle mt-1"></i> <span>${r}</span></li>`).join('') +
                `</ul>`;
        } else if (data.conteudo_oculto) {
            if(Array.isArray(data.conteudo_oculto)) {
                innerHtml = `<ul class="list-disc pl-4 space-y-1">` + data.conteudo_oculto.map(i => `<li>${i}</li>`).join('') + `</ul>`;
            } else {
                 innerHtml = marked.parse(data.conteudo_oculto);
            }
        }

        const isBlur = !isUnlocked;
        
        const cardHtml = `
            <div class="card bg-base-100 shadow-xl border border-base-300 h-full flex flex-col transform transition-all hover:shadow-2xl hover:border-primary/50 overflow-hidden relative">
                <div class="p-4 border-b border-base-200 bg-base-200/30 flex justify-between items-center">
                    <h3 class="font-bold text-lg font-title">${data.titulo || key}</h3>
                    ${!isUnlocked ? `<div class="badge badge-warning font-mono"><i class="fas fa-bolt mr-1"></i> ${cost}</div>` : '<div class="badge badge-success"><i class="fas fa-check"></i></div>'}
                </div>
                
                <div class="p-6 flex-1 relative">
                    <!-- CONTENT -->
                    <div class="transition-all duration-700 ${isBlur ? 'locked-blur' : ''}" id="content-${key}">
                        ${innerHtml}
                    </div>

                    <!-- LOCK OVERLAY -->
                    ${isBlur ? `
                    <div class="lock-overlay" id="overlay-${key}">
                        <div class="text-center p-6">
                            <i class="fas fa-lock fa-2x text-warning mb-4 animate-bounce"></i>
                            <h4 class="font-bold text-white text-lg mb-2">Informação Privilegiada</h4>
                            <p class="text-white/70 text-sm mb-6 max-w-[200px]">Desbloqueie para acessar esta estratégia oculta.</p>
                            <button onclick="unlockModule('${key}', ${cost})" class="btn btn-warning rounded-full px-8 shadow-[0_0_20px_rgba(250,189,0,0.4)] border-none hover:scale-105 transition-transform text-white font-bold">
                                PAGAR ${cost} WATTS
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;

        const wrapper = document.createElement('div');
        wrapper.innerHTML = cardHtml;
        container.appendChild(wrapper.firstElementChild);
    }

    async function unlockModule(key, cost) {
        if (!currentOpportunityId) {
            alert("Erro: ID da análise não encontrado. Salvo no banco? Tente recarregar a página.");
            console.error("Missing Opportunity ID. Current ID:", currentOpportunityId);
            return;
        }

        if(!confirm(`Desbloquear "${key}" por ${cost} Watts?`)) return;

        try {
            const btn = document.querySelector(`#overlay-${key} button`);
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading loading-spinner"></span> Processando...';
            }

            const res = await fetch('/api/oracle/unlock-module', {
                headers: { 'Content-Type': 'application/json' },
                method: 'POST',
                body: JSON.stringify({ opportunityId: currentOpportunityId, moduleKey: key, cost: cost })
            });

            const json = await res.json();
            if (!res.ok) throw new Error(json.error || "Falha no desbloqueio");

            // Success
            currentUserCredits = json.newBalance;
            userCreditsEl.innerText = currentUserCredits;
            
            const overlay = document.getElementById(`overlay-${key}`);
            const content = document.getElementById(`content-${key}`);
            
            if(overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
            }
            if(content) content.classList.remove('locked-blur');

        } catch (e) {
            alert(e.message);
            const btn = document.querySelector(`#overlay-${key} button`);
            if(btn) { btn.disabled = false; btn.innerText = `PAGAR ${cost} WATTS`; }
        }
    }

</script>
