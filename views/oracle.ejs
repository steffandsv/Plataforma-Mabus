<%- include('partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* Custom Scrollbar */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.1); border-radius: 20px; }

    /* Module Locking Effects */
    .locked-blur { filter: blur(8px); pointer-events: none; user-select: none; }
    .lock-overlay { 
        position: absolute; inset: 0; 
        display: flex; flex-direction: column; justify-content: center; items-center;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        z-index: 10; transition: opacity 0.3s ease;
    }

    /* Neural Stream Typer */
    .cursor-blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }
</style>

<div class="min-h-screen bg-base-100 flex flex-col items-center pb-20">

    <!-- TOP NAV / STATS (Floating) -->
    <div class="fixed top-24 right-6 z-50 bg-base-100/90 backdrop-blur shadow-xl rounded-full px-6 py-3 border border-warning flex items-center gap-3 animate-fade-in-down">
        <i class="fas fa-bolt text-warning animate-pulse text-xl"></i>
        <span class="font-black text-xl font-mono" id="userCredits"><%= user.current_credits %></span>
        <span class="text-xs uppercase tracking-widest opacity-60">Watts</span>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl">

        <!-- HEADER BUTTONS -->
        <div class="flex justify-between items-center mb-8">
            <button onclick="resetView()" class="btn btn-ghost hover:bg-base-200 gap-2 group">
                <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                VOLTAR AO INÍCIO
            </button>
            <div class="text-xs font-mono opacity-30">MABUS ORACLE PROTOCOL V6.0</div>
        </div>

        <!-- =========== VIEW: UPLOAD ============ -->
        <div id="uploadView" class="animate-fade-in-up transition-all duration-500">
            <div class="text-center mb-12">
                <h1 class="text-7xl font-black text-base-content tracking-tighter mb-4">ORÁCULO <span class="text-primary">V5</span></h1>
                <p class="text-xl text-base-content/60 font-light tracking-wide">Inteligência Estratégica & Decodificação </p>
            </div>

            <div id="uploadContainer" class="flex justify-center items-center">
                <form id="uploadForm" class="w-full max-w-2xl relative group">
                    <!-- Glow Effect -->
                    <div class="absolute -inset-1 bg-gradient-to-r from-primary to-accent rounded-3xl blur opacity-20 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
                    
                    <label for="pdfFiles" class="relative w-full h-80 border-2 border-dashed border-base-300 bg-base-100 rounded-3xl flex flex-col justify-center items-center cursor-pointer hover:border-primary transition-all shadow-2xl" id="dropZoneArea">
                        <div class="p-6 rounded-full bg-base-200 group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300 mb-6">
                            <i class="fas fa-microchip fa-4x text-primary"></i>
                        </div>
                        <div class="text-3xl font-bold text-base-content drop-zone-text">SOLTAR EDITAL</div>
                        <div class="text-base-content/50 mt-2 font-mono text-sm">PDF APENAS • MÁX 50MB</div>
                        <input type="file" id="pdfFiles" name="pdfFiles" accept=".pdf" multiple hidden required>
                    </label>
                </form>
            </div>

            <!-- LOADER & NEURAL STREAM -->
            <div id="loader" class="hidden text-center py-10 flex flex-col items-center">
                <div class="mb-8">
                    <span class="loading loading-bars loading-lg text-primary scale-150"></span>
                </div>
                <div class="text-2xl font-bold text-base-content animate-pulse mb-6 tracking-widest uppercase" id="loaderText">INICIANDO UPLINK...</div>
                
                <!-- NEURAL STREAM BOX -->
                <div class="mockup-code w-full max-w-3xl text-left bg-black border border-primary/30 shadow-[0_0_30px_rgba(0,0,0,0.5)]">
                    <pre class="px-6 py-4 h-64 overflow-y-auto scrollbar-thin text-xs md:text-sm font-mono leading-relaxed text-green-400" id="thoughtDisplay">
<span class="opacity-50">/// ESTABLISHING SECURE CONNECTION TO CORE...</span>
<span class="opacity-50">/// PING: 12ms | PACKET LOSS: 0%</span>
<span class="opacity-50">/// LOADING PROTOCOL 6.0 (DEEP STRATEGY)...</span>
<span id="thinkingContent"></span><span class="cursor-blink">█</span></pre>
                </div>
            </div>
        </div>

        <!-- =========== VIEW: RESULT ============ -->
        <div id="resultView" class="hidden animate-fade-in transition-all duration-500">
            <!-- Header / Teaser -->
            <div class="text-center mb-16 relative">
                <div class="absolute top-0 right-0 opacity-20">
                     <div class="text-6xl font-black font-mono" id="metaIdDisplay">#000</div>
                </div>

                <div id="ipmDisplay" class="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-br from-error via-warning to-primary inline-block mb-2 transform hover:scale-105 transition-transform cursor-help drop-shadow-lg" title="Índice de Potencial Mabus">0</div>
                <div class="text-sm font-bold tracking-[0.5em] opacity-50 mb-6">IPM SCORE</div>
                
                <div id="classificacaoDisplay" class="text-4xl font-black tracking-wider text-warning mb-8 glitch-effect uppercase">---</div>
                
                <div id="tagsDisplay" class="flex flex-wrap justify-center gap-3 mb-10"></div>
                
                <div class="bg-base-200/50 p-8 rounded-3xl border border-white/5 backdrop-blur-md max-w-4xl mx-auto shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-primary/50 to-transparent"></div>
                    <i class="fas fa-quote-left text-primary/20 text-4xl absolute top-6 left-6"></i>
                    <p id="resumoDisplay" class="text-2xl text-base-content font-serif italic relative z-10 leading-relaxed py-4">...</p>
                    <i class="fas fa-quote-right text-primary/20 text-4xl absolute bottom-6 right-6"></i>
                </div>
            </div>

            <!-- MODULES GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-24" id="modulesGrid">
                <!-- Cards injected here -->
            </div>

            <!-- SNIPER ACTION -->
            <div class="text-center pb-20 border-t border-white/5 pt-12">
                <h3 class="text-3xl font-black mb-8 tracking-tight">PRONTO PARA O ATAQUE?</h3>
                <form action="/create" method="POST" id="sniperForm" class="inline-block">
                    <input type="hidden" name="name" id="sniperName">
                    <input type="hidden" name="cep" value="00000-000">
                    <input type="hidden" name="gridData" id="sniperGridData">
                    <input type="hidden" name="metadataJSON" id="sniperMetadata">
                    <input type="hidden" name="moduleName" value="gemini_meli">
                    <input type="hidden" name="existingFilePath" id="sniperExistingFilePath">

                    <button type="submit" class="btn btn-primary btn-lg rounded-full px-16 text-xl shadow-[0_0_40px_rgba(var(--p),0.4)] hover:shadow-[0_0_60px_rgba(var(--p),0.6)] hover:scale-105 transition-all font-black border-2 border-primary">
                        <i class="fas fa-crosshairs mr-3"></i> INICIAR CAPTURA (SNIPER)
                    </button>
                </form>
            </div>
        </div>

        <!-- =========== HISTORY DECK (BELOW MAIN) ============ -->
        <div class="mt-20 pt-10 border-t border-base-300">
            <h2 class="text-2xl font-black tracking-tight text-white mb-8 flex items-center gap-3">
                <i class="fas fa-history text-primary"></i> 
                TRANSMISSÕES RECENTES
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="historyGrid">
                <!-- History Cards injected via JS -->
                <div class="col-span-3 text-center py-20 opacity-30 font-mono">CARREGANDO ARQUIVOS...</div>
            </div>
        </div>

    </div>
</div>

<%- include('partials/footer') %>

<script>
    let currentOpportunityId = null;
    let currentUserCredits = <%= user.current_credits %>;
    const historyGrid = document.getElementById('historyGrid');
    const userCreditsEl = document.getElementById('userCredits');

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        const initialHistory = <%- JSON.stringify(history || []) %>;
        renderHistoryDeck(initialHistory);
    });

    // --- VIEW MANAGEMENT ---
    function showUpload() {
        document.getElementById('uploadView').classList.remove('hidden');
        document.getElementById('resultView').classList.add('hidden');
        currentOpportunityId = null;
        document.getElementById('uploadForm').reset();
        
        // Reset Loader UI
        document.getElementById('thinkingContent').innerHTML = '';
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('uploadContainer').style.display = 'flex';
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showResult(data) {
        document.getElementById('uploadView').classList.add('hidden');
        document.getElementById('resultView').classList.remove('hidden');
        document.getElementById('loader').classList.add('hidden');
        renderFullAnalysis(data);
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetView() {
        showUpload();
    }

    // --- HISTORY DECK ---
    function renderHistoryDeck(items) {
        historyGrid.innerHTML = '';
        if(items.length === 0) {
            historyGrid.innerHTML = '<div class="col-span-3 text-center p-10 bg-base-200/30 rounded-3xl border border-dashed border-base-300">Sem histórico recente.</div>';
            return;
        }

        items.forEach(item => {
            const meta = typeof item.metadata_json === 'string' ? JSON.parse(item.metadata_json || '{}') : item.metadata_json;
            const unlocked = typeof item.unlocked_modules === 'string' ? JSON.parse(item.unlocked_modules || '[]') : (item.unlocked_modules || []);
            const score = item.ipm_score || 0;
            const title = item.title || 'Sem Título';
            const date = new Date(item.created_at).toLocaleDateString('pt-BR', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
            
            // Unlocked Count
            const unlockedCount = unlocked.length;

            const card = document.createElement('div');
            card.className = `p-6 rounded-2xl bg-base-200 border border-transparent hover:border-primary cursor-pointer transition-all hover:bg-base-300 hover:-translate-y-1 shadow-lg group relative overflow-hidden`;
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="badge badge-lg ${score > 70 ? 'badge-success' : (score > 40 ? 'badge-warning' : 'badge-error')} font-black font-mono">${score}</div>
                    <div class="text-xs font-mono opacity-50">${date}</div>
                </div>
                
                <h4 class="font-bold text-lg mb-2 line-clamp-2 group-hover:text-primary transition-colors leading-tight">${title}</h4>
                <p class="text-sm opacity-60 line-clamp-2 mb-4 h-10">${meta.classificacao || 'Análise Mabus Protocol'}</p>

                <div class="flex justify-between items-center border-t border-white/5 pt-4 mt-auto">
                    <div class="flex items-center gap-2 text-xs font-bold ${unlockedCount > 0 ? 'text-success' : 'text-base-content/30'}">
                        <i class="fas ${unlockedCount > 0 ? 'fa-lock-open' : 'fa-lock'}"></i>
                        ${unlockedCount > 0 ? `${unlockedCount} ITENS LIBERADOS` : 'BLOQUEADO'}
                    </div>
                    <i class="fas fa-arrow-right text-primary opacity-0 group-hover:opacity-100 transition-opacity transform group-hover:translate-x-1"></i>
                </div>
            `;
            card.onclick = () => loadAnalysis(item.id);
            historyGrid.appendChild(card);
        });
    }

    async function loadAnalysis(id) {
        try {
            // Show Loader Overlay? Or just smooth scroll to top and show generic loader
            document.getElementById('resultView').classList.add('hidden');
            document.getElementById('uploadView').classList.remove('hidden');
            document.getElementById('uploadContainer').style.display = 'none';
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('loaderText').innerText = "RECUPERANDO DADOS...";
            document.getElementById('thinkingContent').innerText = ""; 

            const res = await fetch(`/api/oracle/history/${id}`);
            if(!res.ok) throw new Error("Erro ao carregar");
            const data = await res.json();

            const parsed = {
                id: data.id,
                metadata: typeof data.metadata_json === 'string' ? JSON.parse(data.metadata_json) : data.metadata_json,
                locked_content: typeof data.locked_content_json === 'string' ? JSON.parse(data.locked_content_json) : data.locked_content_json,
                items: typeof data.items_json === 'string' ? JSON.parse(data.items_json) : data.items_json,
                unlocked_modules: typeof data.unlocked_modules === 'string' ? JSON.parse(data.unlocked_modules) : (data.unlocked_modules || []),
                file_path: "" 
            };
            
            showResult(parsed);

        } catch(e) {
            console.error(e);
            alert("Erro ao carregar análise.");
            resetView();
        }
    }


    // --- UPLOAD LOGIC ---
    const dropZone = document.getElementById('dropZoneArea');
    const fileInput = document.getElementById('pdfFiles');
    const uploadForm = document.getElementById('uploadForm');

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => { e.preventDefault(); dropZone.classList.add('border-primary', 'bg-base-200'); }, false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => { e.preventDefault(); dropZone.classList.remove('border-primary', 'bg-base-200'); }, false);
    });
    dropZone.addEventListener('drop', (e) => { fileInput.files = e.dataTransfer.files; handleUpload(); });
    fileInput.addEventListener('change', handleUpload);

    async function handleUpload() {
        if (fileInput.files.length === 0) return;

        document.getElementById('uploadContainer').style.display = 'none';
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('loaderText').innerText = "INICIANDO VARREDURA NEURAL...";
        
        // Reset and prepare Thought Box
        const thoughtBox = document.getElementById('thoughtDisplay');
        const thinkingContent = document.getElementById('thinkingContent');
        thinkingContent.textContent = ''; 

        const formData = new FormData(uploadForm);
        let currentData = {};

        try {
            const response = await fetch('/api/process-tr', { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Erro: ${response.status}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const eventData = JSON.parse(line.substring(6));

                            if (eventData.message) { 
                                document.getElementById('loaderText').innerText = eventData.message.toUpperCase();
                            }
                            
                            if (eventData.text) { 
                                // Stream Thoughts
                                thinkingContent.textContent += eventData.text;
                                thoughtBox.scrollTop = thoughtBox.scrollHeight;
                            }

                            if (eventData.metadata || eventData.ipm_score) {
                                // FINAL RESULT
                                currentData = eventData;
                                if (eventData.id) {
                                    currentOpportunityId = eventData.id;
                                    console.log("Analysis ID captured:", currentOpportunityId);
                                }
                            }
                        } catch(e) {}
                    }
                }
            }
             
            showResult({
                ...currentData,
                id: currentOpportunityId, 
                unlocked_modules: []
            });

            // Ideally initiate a refresh of History Grid silently here so if user scrolls down it's there?
            // Since we don't have a separated "get all history" endpoint easy to call without reloading page data,
            // we will let it update on next refresh.

        } catch (error) {
            console.error(error);
            alert("Erro Fatal: " + error.message);
            resetView();
        }
    }


    // --- RENDER FULL ANALYSIS ---
    function renderFullAnalysis(data) {
        currentOpportunityId = data.id; 
        const meta = data.metadata || {};
        const lockedModules = data.locked_content || {};
        const unlockedList = data.unlocked_modules || [];

        document.getElementById('metaIdDisplay').innerText = data.id ? `#${data.id}` : 'NOVO';
        document.getElementById('ipmDisplay').innerText = meta.ipm_score || data.ipm_score || 0;
        document.getElementById('classificacaoDisplay').innerText = meta.classificacao || 'ANÁLISE';
        document.getElementById('resumoDisplay').innerText = meta.resumo_glitch || meta.resumo_poderoso || '...';
        
        const tagsBox = document.getElementById('tagsDisplay');
        tagsBox.innerHTML = '';
        (meta.tags_visuais || meta.tags_elite || []).forEach(tag => {
            tagsBox.innerHTML += `<span class="badge badge-lg badge-outline border-2 font-bold p-4 uppercase tracking-widest">${tag}</span>`;
        });

        const grid = document.getElementById('modulesGrid');
        grid.innerHTML = '';

        Object.keys(lockedModules).forEach(key => {
            const moduleData = lockedModules[key];
            const isUnlocked = unlockedList.includes(key);
            renderModuleCard(key, moduleData, isUnlocked, grid);
        });

        document.getElementById('sniperName').value = meta.edital_numero || 'Oracle Mission';
        document.getElementById('sniperMetadata').value = JSON.stringify(meta);
        if (data.file_path) document.getElementById('sniperExistingFilePath').value = data.file_path;
        document.getElementById('sniperGridData').value = "ID;Descricao;valor_venda;quantidade\n";
    }

    function renderModuleCard(key, data, isUnlocked, container) {
        const cost = data.custo_watts || 100;
        const domId = `card-${key}`;

        let innerHtml = '';
        if (data.taticas) {
            innerHtml = data.taticas.map(t => `
                <div class="bg-base-300/50 border-l-4 border-accent p-3 mb-2 rounded">
                    <div class="font-bold text-accent mb-1">${t.icone || ''} ${t.titulo}</div>
                    <div class="text-sm opacity-80">${t.texto}</div>
                </div>
            `).join('');
        } else if (data.dados) {
            innerHtml = `<table class="table table-sm w-full"><tbody>` + 
                data.dados.map(d => `<tr><td class="opacity-70">${d.label}</td><td class="font-bold text-right ${d.alerta === 'ALTO RISCO' || d.alerta === 'PERIGO' ? 'text-error' : 'text-success'}">${d.valor}</td></tr>`).join('') +
                `</tbody></table>`;
        } else if (data.lista_riscos) {
            innerHtml = `<ul class="space-y-2">` + 
                data.lista_riscos.map(r => `<li class="flex items-start gap-2 text-error text-sm font-medium"><i class="fas fa-exclamation-circle mt-1"></i> <span>${r}</span></li>`).join('') +
                `</ul>`;
        } else if (data.conteudo_oculto) {
            if(Array.isArray(data.conteudo_oculto)) {
                innerHtml = `<ul class="list-disc pl-4 space-y-1">` + data.conteudo_oculto.map(i => `<li>${i}</li>`).join('') + `</ul>`;
            } else {
                 innerHtml = marked.parse(data.conteudo_oculto);
            }
        }

        const isBlur = !isUnlocked;
        
        const cardHtml = `
            <div class="card bg-base-100 shadow-xl border border-white/5 h-full flex flex-col transform transition-all hover:shadow-[0_0_30px_rgba(0,0,0,0.3)] hover:border-primary/50 overflow-hidden relative group" id="card-${key}">
                
                <div class="p-6 border-b border-white/5 bg-base-200/50 flex justify-between items-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 h-full w-1 bg-gradient-to-b from-transparent via-primary to-transparent opacity-50"></div>
                    <h3 class="font-black text-lg font-mono uppercase tracking-wide z-10">${data.titulo || key}</h3>
                    
                    ${!isUnlocked ? 
                        `<div class="badge badge-warning font-mono font-bold shadow-[0_0_15px_rgba(250,189,0,0.4)]"><i class="fas fa-bolt mr-1"></i> ${cost}</div>` : 
                        `<div class="badge badge-success font-bold shadow-[0_0_15px_rgba(34,197,94,0.4)]"><i class="fas fa-check mr-1"></i> LIBERADO</div>`
                    }
                </div>
                
                <div class="p-6 flex-1 relative bg-base-100/50">
                    <!-- CONTENT -->
                    <div class="transition-all duration-700 ${isBlur ? 'locked-blur opacity-50' : ''}" id="content-${key}">
                        ${innerHtml}
                    </div>

                    <!-- LOCK OVERLAY -->
                    ${isBlur ? `
                    <div class="lock-overlay" id="overlay-${key}">
                        <div class="text-center p-6 transform transition-transform group-hover:scale-105">
                            <div class="mb-4 relative inline-block">
                                <div class="absolute -inset-4 bg-warning/20 rounded-full blur-xl animate-pulse"></div>
                                <i class="fas fa-lock fa-3x text-warning relative z-10"></i>
                            </div>
                            
                            <h4 class="font-black text-white text-xl mb-2 tracking-tight">DADOS CRIPTO-GOGRAFADOS</h4>
                            
                            <p class="text-white/60 text-xs mb-6 max-w-[200px] font-mono mx-auto">
                                Esta seção contém inteligência estratégica de alto nível.
                            </p>

                            <button onclick="unlockModule('${key}', ${cost})" class="btn btn-warning btn-md rounded-full px-8 shadow-[0_0_30px_rgba(250,189,0,0.3)] border-none hover:scale-105 transition-all text-black font-black tracking-widest">
                                DESBLOQUEAR <span class="opacity-50 mx-1">|</span> ${cost}
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;

        const wrapper = document.createElement('div');
        wrapper.innerHTML = cardHtml;
        container.appendChild(wrapper.firstElementChild);
    }

    async function unlockModule(key, cost) {
        if (!currentOpportunityId) {
            alert("Erro: ID da análise não encontrado. Tente recarregar a página.");
            return;
        }

        if(!confirm(`Desbloquear "${key}" por ${cost} Watts?`)) return;

        try {
            const btn = document.querySelector(`#overlay-${key} button`);
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading loading-spinner"></span> PROCESSANDO...';
            }

            const res = await fetch('/api/oracle/unlock-module', {
                headers: { 'Content-Type': 'application/json' },
                method: 'POST',
                body: JSON.stringify({ opportunityId: currentOpportunityId, moduleKey: key, cost: cost })
            });

            const json = await res.json();
            if (!res.ok) throw new Error(json.error || "Falha no desbloqueio");

            // Success
            currentUserCredits = json.newBalance;
            userCreditsEl.innerText = currentUserCredits;
            
            const overlay = document.getElementById(`overlay-${key}`);
            const content = document.getElementById(`content-${key}`);
            const badge = document.querySelector(`#card-${key} .badge`);

            if(overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
            }
            if(content) {
                content.classList.remove('locked-blur', 'opacity-50');
            }
            if(badge) {
                badge.className = "badge badge-success font-bold shadow-[0_0_15px_rgba(34,197,94,0.4)]";
                badge.innerHTML = '<i class="fas fa-check mr-1"></i> LIBERADO';
            }

        } catch (e) {
            alert(e.message);
            const btn = document.querySelector(`#overlay-${key} button`);
            if(btn) { btn.disabled = false; btn.innerText = `DESBLOQUEAR | ${cost}`; }
        }
    }

</script>
