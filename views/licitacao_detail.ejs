<%- include('partials/head') %>
    <!-- –õ–µ Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <%- include('partials/header') %>


        <div class="container mx-auto px-4 py-8">
            <!-- Header com T√≠tulo e A√ß√µes -->
            <div class="mb-6">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold mb-2">
                            <i class="fas fa-gavel text-primary"></i>
                            <%= licitacao.razao_social_orgao || '√ìrg√£o n√£o informado' %>
                        </h1>
                        <div class="flex gap-2 flex-wrap mb-3">
                            <span class="badge badge-lg badge-primary">
                                <%= licitacao.modalidade_licitacao || 'N/D' %>
                            </span>
                            <% if (licitacao.situacao_compra) { %>
                                <span class="badge badge-lg badge-outline">
                                    <%= licitacao.situacao_compra %>
                                </span>
                                <% } %>
                                    <% if (licitacao.srp) { %>
                                        <span class="badge badge-lg badge-success">
                                            <i class="fas fa-box-open"></i> SRP
                                        </span>
                                        <% } %>
                                            <% if (licitacao.uf_sigla) { %>
                                                <span class="badge badge-lg badge-ghost">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                    <%= licitacao.uf_sigla %> - <%= licitacao.municipio_nome || 'N/D' %>
                                                </span>
                                                <% } %>
                        </div>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="flex gap-2 flex-wrap">
                        <!-- Interest Controls -->
                        <button class="btn <%= isSaved ? 'btn-success' : 'btn-outline btn-success' %> gap-2"
                            onclick="toggleSave()" id="saveBtn">
                            <i class="fas fa-heart" id="saveIcon"></i>
                            <span id="saveText">
                                <%= isSaved ? 'Salvo' : 'Salvar' %>
                            </span>
                        </button>

                        <button class="btn <%= isDisliked ? 'btn-error' : 'btn-outline btn-error' %> gap-2"
                            onclick="toggleDislike()" id="dislikeBtn">
                            <i class="fas fa-thumbs-down" id="dislikeIcon"></i>
                            <span id="dislikeText">
                                <%= isDisliked ? 'Sem Interesse' : 'N√£o Tenho Interesse' %>
                            </span>
                        </button>

                        <!-- Arquivos -->
                        <% if (arquivos && arquivos.length> 0) { %>
                            <% if (arquivos.length===1) { %>
                                <!-- Single file: Direct download -->
                                <a href="<%= arquivos[0].url %>" target="_blank" rel="noopener noreferrer"
                                    class="btn btn-primary gap-2"
                                    title="<%= arquivos[0].tipo_documento_descricao || arquivos[0].tipo_documento_nome %>">
                                    <i class="fas fa-download"></i>
                                    Baixar Arquivo
                                </a>
                                <% } else { %>
                                    <!-- Multiple files: Dropdown -->
                                    <div class="dropdown dropdown-hover">
                                        <div tabindex="0" role="button" class="btn btn-primary gap-2">
                                            <i class="fas fa-download"></i>
                                            Baixar Arquivos
                                            <span class="badge badge-sm">
                                                <%= arquivos.length %>
                                            </span>
                                        </div>
                                        <ul tabindex="0"
                                            class="dropdown-content z-[999] menu p-2 shadow-2xl bg-base-200 rounded-box w-80 max-h-96 overflow-y-auto flex-nowrap border border-base-300">
                                            <li class="menu-title">
                                                <span class="text-xs opacity-60">Documentos Dispon√≠veis</span>
                                            </li>
                                            <% arquivos.forEach((arquivo, idx)=> { %>
                                                <li>
                                                    <a href="<%= arquivo.url %>" target="_blank"
                                                        rel="noopener noreferrer"
                                                        class="flex items-start gap-2 hover:bg-primary/20 py-2"
                                                        title="<%= arquivo.tipo_documento_descricao || 'Clique para baixar' %>">
                                                        <% if (arquivo.tipo_documento_nome &&
                                                            arquivo.tipo_documento_nome.toLowerCase().includes('edital'))
                                                            { %>
                                                            <i class="fas fa-file-pdf text-error mt-1"></i>
                                                            <% } else if (arquivo.tipo_documento_nome &&
                                                                arquivo.tipo_documento_nome.toLowerCase().includes('termo'))
                                                                { %>
                                                                <i class="fas fa-file-contract text-info mt-1"></i>
                                                                <% } else { %>
                                                                    <i
                                                                        class="fas fa-file-alt text-base-content/60 mt-1"></i>
                                                                    <% } %>
                                                                        <div class="flex-1 min-w-0">
                                                                            <div class="font-medium text-sm truncate">
                                                                                <%= arquivo.titulo ||
                                                                                    arquivo.tipo_documento_nome ||
                                                                                    `Documento ${idx + 1}` %>
                                                                            </div>
                                                                            <% if (arquivo.tipo_documento_descricao &&
                                                                                arquivo.tipo_documento_descricao
                                                                                !==arquivo.titulo) { %>
                                                                                <div
                                                                                    class="text-xs opacity-60 truncate">
                                                                                    <%= arquivo.tipo_documento_descricao.substring(0,
                                                                                        60) %>
                                                                                        <%=
                                                                                            arquivo.tipo_documento_descricao.length>
                                                                                            60 ? '...' : '' %>
                                                                                </div>
                                                                                <% } %>
                                                                        </div>
                                                                        <i
                                                                            class="fas fa-external-link-alt text-xs opacity-40 mt-1"></i>
                                                    </a>
                                                </li>
                                                <% }) %>
                                        </ul>
                                    </div>
                                    <% } %>
                                        <% } else { %>
                                            <% if (licitacao.link_sistema_origem) { %>
                                                <a href="<%= licitacao.link_sistema_origem %>" target="_blank"
                                                    rel="noopener noreferrer" class="btn btn-secondary gap-2">
                                                    <i class="fas fa-external-link-alt"></i>
                                                    Ver no Portal
                                                </a>
                                                <% } %>
                                                    <% } %>

                                                        <% if (licitacao.link_processo_eletronico) { %>
                                                            <a href="<%= licitacao.link_processo_eletronico %>"
                                                                target="_blank" rel="noopener noreferrer"
                                                                class="btn btn-secondary gap-2">
                                                                <i class="fas fa-folder-open"></i>
                                                                Processo Eletr√¥nico
                                                            </a>
                                                            <% } %>

                                                                <a href="/licitacoes" class="btn btn-ghost gap-2">
                                                                    <i class="fas fa-arrow-left"></i>
                                                                    Voltar
                                                                </a>
                    </div>
                </div>

                <!-- Info R√°pida - REORGANIZED (3 cards) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="stat bg-base-200 rounded-lg shadow">
                        <div class="stat-title">Valor Estimado</div>
                        <div class="stat-value text-success text-2xl">
                            <% if (licitacao.valor_estimado_total && licitacao.valor_estimado_total> 0) { %>
                                R$ <%= parseFloat(licitacao.valor_estimado_total).toLocaleString('pt-BR',
                                    {minimumFractionDigits: 2}) %>
                                    <% } else { %>
                                        N√£o informado
                                        <% } %>
                        </div>
                    </div>

                    <!-- NEW: Envio da Proposta (combines Publication + Abertura) -->
                    <div class="stat bg-base-200 rounded-lg shadow">
                        <div class="stat-title">üì® Envio da Proposta</div>
                        <div class="text-sm space-y-1">
                            <div>
                                <strong class="text-info">Abertura:</strong>
                                <% if (licitacao.data_abertura_proposta) { %>
                                    <div class="text-lg font-semibold">
                                        <%= new Date(licitacao.data_abertura_proposta).toLocaleDateString('pt-BR') %>
                                    </div>
                                    <div class="text-xs opacity-70">
                                        <%= new Date(licitacao.data_abertura_proposta).toLocaleTimeString('pt-BR',
                                            {hour: '2-digit' , minute: '2-digit' }) %>
                                    </div>
                                    <% } else { %>
                                        <div class="text-sm">N/D</div>
                                        <% } %>
                            </div>
                            <div class="divider my-1"></div>
                            <div>
                                <strong class="text-warning">Enviar at√©:</strong>
                                <% if (licitacao.data_encerramento_proposta) { %>
                                    <div class="text-lg font-semibold">
                                        <%= new Date(licitacao.data_encerramento_proposta).toLocaleDateString('pt-BR')
                                            %>
                                    </div>
                                    <div class="text-xs opacity-70">
                                        <%= new Date(licitacao.data_encerramento_proposta).toLocaleTimeString('pt-BR',
                                            {hour: '2-digit' , minute: '2-digit' }) %>
                                    </div>
                                    <% } else { %>
                                        <div class="text-sm">N/D</div>
                                        <% } %>
                            </div>
                        </div>
                    </div>

                    <div class="stat bg-base-200 rounded-lg shadow">
                        <div class="stat-title">N¬∫ Processo</div>
                        <div class="stat-value text-sm">
                            <%= licitacao.processo || licitacao.numero_compra || 'N/D' %>
                        </div>
                        <div class="stat-desc text-xs">
                            Ano: <%= licitacao.ano_compra || 'N/D' %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs de Detalhes -->
            <div role="tablist" class="tabs tabs-bordered">
                <input type="radio" name="tabs" role="tab" class="tab" aria-label="Informa√ß√µes" checked />
                <div role="tabpanel" class="tab-content p-6 bg-base-100 rounded-b-lg">

                    <!-- Objeto da Compra -->
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                            <i class="fas fa-file-alt text-primary"></i>
                            Objeto da Compra
                        </h3>
                        <div class="bg-base-200 p-4 rounded-lg">
                            <p class="whitespace-pre-wrap">
                                <%= licitacao.objeto_compra || 'N√£o informado' %>
                            </p>
                        </div>
                    </div>

                    <% if (licitacao.informacao_complementar) { %>
                        <div class="mb-6">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                                <i class="fas fa-info-circle text-info"></i>
                                Informa√ß√µes Complementares
                            </h3>
                            <div class="bg-base-200 p-4 rounded-lg">
                                <p class="whitespace-pre-wrap">
                                    <%= licitacao.informacao_complementar %>
                                </p>
                            </div>
                        </div>
                        <% } %>

                            <!-- REORGANIZED LAYOUT -->

                            <!-- Row 1: √ìrg√£o + Detalhes Contratuais (side by side) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <!-- √ìrg√£o Contratante -->
                                <div class="card bg-base-200">
                                    <div class="card-body">
                                        <h3 class="card-title text-md">üè¢ √ìrg√£o Contratante</h3>
                                        <div class="space-y-2 text-sm">
                                            <div><strong>CNPJ:</strong>
                                                <%= formatCNPJ(licitacao.cnpj_orgao) %>
                                            </div>
                                            <div><strong>Poder:</strong>
                                                <%= convertPoder(licitacao.poder) %>
                                            </div>
                                            <div><strong>Esfera:</strong>
                                                <%= convertEsfera(licitacao.esfera) %>
                                            </div>
                                            <% if (licitacao.nome_unidade) { %>
                                                <div><strong>Unidade:</strong>
                                                    <%= licitacao.nome_unidade %>
                                                </div>
                                                <% } %>
                                        </div>
                                    </div>
                                </div>

                                <!-- Detalhes Contratuais (moved here) -->
                                <div class="card bg-base-200">
                                    <div class="card-body">
                                        <h3 class="card-title text-md">‚öôÔ∏è Detalhes Contratuais</h3>
                                        <div class="space-y-2 text-sm">
                                            <% if (licitacao.modo_disputa_nome) { %>
                                                <div><strong>Modo de Disputa:</strong>
                                                    <%= licitacao.modo_disputa_nome %>
                                                </div>
                                                <% } %>
                                                    <% if (licitacao.tipo_instrumento_nome) { %>
                                                        <div><strong>Instrumento:</strong>
                                                            <%= licitacao.tipo_instrumento_nome %>
                                                        </div>
                                                        <% } %>
                                                            <% if (licitacao.usuario_nome) { %>
                                                                <div><strong>Publicado por:</strong>
                                                                    <%= licitacao.usuario_nome %>
                                                                </div>
                                                                <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 2: Localiza√ß√£o (FULL WIDTH with Interactive Map) -->
                            <div class="mb-6">
                                <div class="card bg-base-200">
                                    <div class="card-body">
                                        <h3 class="card-title text-md">üìç Localiza√ß√£o</h3>

                                        <!-- Map Container with Search Overlay -->
                                        <div class="relative">
                                            <div id="map" class="h-96 rounded-lg mb-4 bg-base-300"></div>

                                            <!-- Floating Search Form -->
                                            <div class="absolute top-4 right-4 z-[1000] w-80">
                                                <div class="card bg-base-100 shadow-2xl border border-base-300">
                                                    <div class="card-body p-4">
                                                        <h4 class="font-bold text-sm mb-2">üîç Buscar na Regi√£o</h4>
                                                        <div class="form-control">
                                                            <input type="text" id="searchQuery"
                                                                placeholder="Ex: Lojas de armarinho"
                                                                class="input input-sm input-bordered w-full mb-2" />
                                                            <div class="flex gap-2">
                                                                <button class="btn btn-primary btn-sm flex-1"
                                                                    onclick="performSearch()">
                                                                    <i class="fas fa-search"></i>
                                                                    Buscar
                                                                </button>
                                                                <button class="btn btn-ghost btn-sm"
                                                                    onclick="clearSearchResults()"
                                                                    title="Limpar resultados">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                            <div id="searchStatus" class="text-xs mt-2 opacity-70">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Location Info -->
                                        <div class="space-y-2 text-sm mb-4">
                                            <% if (licitacao.nome_unidade) { %>
                                                <div><strong>Unidade:</strong>
                                                    <%= licitacao.nome_unidade %>
                                                </div>
                                                <% } %>
                                                    <div><strong>Munic√≠pio:</strong>
                                                        <%= licitacao.municipio_nome || 'N/D' %>
                                                    </div>
                                                    <div><strong>UF:</strong>
                                                        <%= licitacao.uf_nome || 'N/D' %> (<%= licitacao.uf_sigla
                                                                || 'N/D' %>)
                                                    </div>
                                                    <% if (licitacao.codigo_ibge) { %>
                                                        <div class="text-xs"><strong>C√≥digo IBGE:</strong>
                                                            <%= licitacao.codigo_ibge %>
                                                        </div>
                                                        <% } %>
                                        </div>

                                        <!-- Search Radius Control -->
                                        <div class="flex gap-2 items-center">
                                            <label class="label">
                                                <span class="label-text text-xs font-semibold">Raio de busca:</span>
                                            </label>
                                            <input type="range" min="1" max="50" value="5" step="1"
                                                class="range range-xs range-primary flex-1" id="searchRadius">
                                            <span id="radiusValue" class="badge badge-primary">5 km</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 3: Remaining Cards (2 columns) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                                <!-- Amparo Legal -->
                                <% if (licitacao.amparo_legal_nome) { %>
                                    <div class="card bg-base-200">
                                        <div class="card-body">
                                            <h3 class="card-title text-md">‚öñÔ∏è Amparo Legal</h3>
                                            <div class="space-y-2 text-sm">
                                                <div><strong>
                                                        <%= licitacao.amparo_legal_nome %>
                                                    </strong></div>
                                                <% if (licitacao.amparo_legal_descricao) { %>
                                                    <div class="text-xs opacity-70">
                                                        <%= licitacao.amparo_legal_descricao %>
                                                    </div>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>

                                        <!-- Cronograma Completo -->
                                        <div class="card bg-base-200">
                                            <div class="card-body">
                                                <h3 class="card-title text-md">üìÖ Cronograma Completo</h3>
                                                <div class="space-y-2 text-sm">
                                                    <% if (licitacao.data_inclusao) { %>
                                                        <div><strong>Inclus√£o:</strong>
                                                            <%= new
                                                                Date(licitacao.data_inclusao).toLocaleString('pt-BR') %>
                                                        </div>
                                                        <% } %>
                                                            <% if (licitacao.data_abertura_proposta) { %>
                                                                <div><strong>Abertura:</strong>
                                                                    <%= new
                                                                        Date(licitacao.data_abertura_proposta).toLocaleString('pt-BR')
                                                                        %>
                                                                </div>
                                                                <% } %>
                                                                    <% if (licitacao.data_encerramento_proposta) { %>
                                                                        <div><strong>Encerramento:</strong>
                                                                            <%= new
                                                                                Date(licitacao.data_encerramento_proposta).toLocaleString('pt-BR')
                                                                                %>
                                                                        </div>
                                                                        <% } %>
                                                                            <% if (licitacao.data_atualizacao) { %>
                                                                                <div class="text-xs opacity-70">
                                                                                    <strong>√öltima
                                                                                        atualiza√ß√£o:</strong>
                                                                                    <%= new
                                                                                        Date(licitacao.data_atualizacao).toLocaleString('pt-BR')
                                                                                        %>
                                                                                </div>
                                                                                <% } %>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Identificadores -->
                                        <div class="card bg-base-200">
                                            <div class="card-body">
                                                <h3 class="card-title text-md">üî¢ Identificadores</h3>
                                                <div class="space-y-2 text-sm">
                                                    <div class="font-mono text-xs"><strong>PNCP:</strong>
                                                        <%= licitacao.numero_sequencial_pncp %>
                                                    </div>
                                                    <% if (licitacao.numero_compra) { %>
                                                        <div><strong>N√∫mero:</strong>
                                                            <%= licitacao.numero_compra %>
                                                        </div>
                                                        <% } %>
                                                            <% if (licitacao.processo) { %>
                                                                <div><strong>Processo:</strong>
                                                                    <%= licitacao.processo %>
                                                                </div>
                                                                <% } %>
                                                                    <% if (licitacao.sequencial_compra) { %>
                                                                        <div><strong>Sequencial:</strong>
                                                                            <%= licitacao.sequencial_compra %>
                                                                        </div>
                                                                        <% } %>
                                                </div>
                                            </div>
                                        </div>
                            </div>
                </div>

                <input type="radio" name="tabs" role="tab" class="tab" aria-label="Itens (<%= itens.length %>)" />
                <div role="tabpanel" class="tab-content p-6 bg-base-100 rounded-b-lg">
                    <% if (itens.length===0) { %>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>N√£o h√° itens detalhados dispon√≠veis para esta licita√ß√£o.</span>
                        </div>
                        <% } else { %>
                            <div class="overflow-x-auto">
                                <table class="table table-zebra">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Descri√ß√£o</th>
                                            <th>Tipo</th>
                                            <th>Qtd</th>
                                            <th>Unidade</th>
                                            <th>Valor Unit.</th>
                                            <th>Valor Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% itens.forEach(item=> { %>
                                            <tr>
                                                <td>
                                                    <%= item.numero_item %>
                                                </td>
                                                <td>
                                                    <%= item.descricao_item %>
                                                </td>
                                                <td>
                                                    <% if (item.material_ou_servico_nome) { %>
                                                        <span class="badge badge-sm">
                                                            <%= item.material_ou_servico_nome %>
                                                        </span>
                                                        <% } %>
                                                </td>
                                                <td>
                                                    <%= item.quantidade %>
                                                </td>
                                                <td>
                                                    <%= item.unidade_medida || '-' %>
                                                </td>
                                                <td>
                                                    <% if (item.valor_unitario_estimado) { %>
                                                        R$ <%=
                                                            parseFloat(item.valor_unitario_estimado).toLocaleString('pt-BR',
                                                            {minimumFractionDigits: 2}) %>
                                                            <% } else { %>
                                                                -
                                                                <% } %>
                                                </td>
                                                <td>
                                                    <% if (item.valor_total_estimado) { %>
                                                        R$ <%=
                                                            parseFloat(item.valor_total_estimado).toLocaleString('pt-BR',
                                                            {minimumFractionDigits: 2}) %>
                                                            <% } else { %>
                                                                -
                                                                <% } %>
                                                </td>
                                            </tr>
                                            <% }) %>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="7" class="text-right">
                                                Total de <%= itens.length %> item(ns)
                                            </th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <% } %>
                </div>
            </div>
        </div>

        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

        <!-- JavaScript for Interest Controls & Map -->
        <script>
            const licitacaoId = '<%= licitacao.id %>';
            let isSaved = <%= isSaved ? 'true' : 'false' %>;
            let isDisliked = <%= isDisliked ? 'true' : 'false' %>;

            // Toggle Save
            async function toggleSave() {
                try {
                    const method = isSaved ? 'DELETE' : 'POST';
                    const response = await fetch(`/api/licitacoes/${licitacaoId}/save`, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();

                    if (data.success || data.success === false) {
                        isSaved = !isSaved;
                        updateSaveButton();
                        if (typeof showToast === 'function') {
                            showToast(data.message, 'success');
                        }
                    }
                } catch (e) {
                    console.error('Error toggling save:', e);
                    if (typeof showToast === 'function') {
                        showToast('Erro ao salvar', 'error');
                    }
                }
            }

            // Toggle Dislike
            async function toggleDislike() {
                try {
                    const method = isDisliked ? 'DELETE' : 'POST';
                    const response = await fetch(`/api/licitacoes/${licitacaoId}/dislike`, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();

                    if (data.success || data.success === false) {
                        isDisliked = !isDisliked;
                        updateDislikeButton();
                        if (typeof showToast === 'function') {
                            showToast(data.message, isDisliked ? 'warning' : 'success');
                        }
                    }
                } catch (e) {
                    console.error('Error toggling dislike:', e);
                    if (typeof showToast === 'function') {
                        showToast('Erro ao processar', 'error');
                    }
                }
            }

            // Update button states
            function updateSaveButton() {
                const btn = document.getElementById('saveBtn');
                const text = document.getElementById('saveText');
                if (isSaved) {
                    btn.classList.add('btn-success');
                    btn.classList.remove('btn-outline');
                    text.textContent = 'Salvo';
                } else {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline');
                    text.textContent = 'Salvar';
                }
            }

            function updateDislikeButton() {
                const btn = document.getElementById('dislikeBtn');
                const text = document.getElementById('dislikeText');
                if (isDisliked) {
                    btn.classList.add('btn-error');
                    btn.classList.remove('btn-outline');
                    text.textContent = 'Sem Interesse';
                } else {
                    btn.classList.remove('btn-error');
                    btn.classList.add('btn-outline');
                    text.textContent = 'N√£o Tenho Interesse';
                }
            }

            // Map Functionality
            let map, marker, circle;
            let searchMarkers = [];
            const licitacaoCity = "<%= licitacao.municipio_nome || '' %>";
            const licitacaoState = "<%= licitacao.uf_sigla || '' %>";
            const licitacaoAddress = `${licitacaoCity}, ${licitacaoState}, Brasil`;

            // Initialize Map
            async function initMap() {
                try {
                    // Geocode ONLY city and state for better accuracy
                    const geocodeQuery = `${licitacaoCity}, ${licitacaoState}, Brasil`;
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(geocodeQuery)}&countrycodes=br&limit=1`);
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);

                        // Initialize map
                        map = L.map('map').setView([lat, lon], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors',
                            maxZoom: 19
                        }).addTo(map);

                        // Add marker for the city center
                        marker = L.marker([lat, lon]).addTo(map)
                            .bindPopup(`<strong>${licitacaoCity}, ${licitacaoState}</strong>`).openPopup();

                        // Add radius circle
                        updateRadius();
                    } else {
                        // Fallback to Brazil center if geocoding fails
                        map = L.map('map').setView([-14.235, -51.925], 4);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors'
                        }).addTo(map);

                        document.getElementById('map').innerHTML += '<div class="absolute inset-0 flex items-center justify-center bg-base-300/80 pointer-events-none"><span class="text-sm opacity-60">üìç Localiza√ß√£o n√£o encontrada</span></div>';
                    }
                } catch (e) {
                    console.error('Map initialization error:', e);
                }
            }

            // Update radius circle
            function updateRadius() {
                if (!marker || !map) return;

                const radiusKm = document.getElementById('searchRadius').value;
                document.getElementById('radiusValue').textContent = radiusKm + ' km';

                if (circle) map.removeLayer(circle);

                const center = marker.getLatLng();
                circle = L.circle(center, {
                    radius: radiusKm * 1000, // Convert to meters
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.15,
                    weight: 2
                }).addTo(map);

                // Fit map to circle bounds
                map.fitBounds(circle.getBounds());
            }

            // Clear search results
            function clearSearchResults() {
                // Remove all search markers
                searchMarkers.forEach(m => map.removeLayer(m));
                searchMarkers = [];

                // Clear search input and status
                document.getElementById('searchQuery').value = '';
                document.getElementById('searchStatus').textContent = '';

                // Re-center map on the city
                if (marker) {
                    map.setView(marker.getLatLng(), 13);
                    updateRadius();
                }
            }

            // Perform search using Overpass API
            async function performSearch() {
                const query = document.getElementById('searchQuery').value.trim();
                if (!query) {
                    document.getElementById('searchStatus').textContent = '‚ö†Ô∏è Digite algo para buscar';
                    return;
                }

                if (!marker || !map) {
                    document.getElementById('searchStatus').textContent = '‚ö†Ô∏è Mapa n√£o inicializado';
                    return;
                }

                // Show loading state
                document.getElementById('searchStatus').textContent = 'üîç Buscando...';

                // Clear previous results
                searchMarkers.forEach(m => map.removeLayer(m));
                searchMarkers = [];

                try {
                    const center = marker.getLatLng();
                    const radiusMeters = document.getElementById('searchRadius').value * 1000;

                    // Overpass API query - Search ONLY for matching businesses
                    const overpassQuery = `[out:json][timeout:25];
(
  node["name"~"${query}",i](around:${radiusMeters},${center.lat},${center.lng});
  way["name"~"${query}",i](around:${radiusMeters},${center.lat},${center.lng});
  node["shop"~"${query}",i](around:${radiusMeters},${center.lat},${center.lng});
  way["shop"~"${query}",i](around:${radiusMeters},${center.lat},${center.lng});
  node["amenity"~"${query}",i](around:${radiusMeters},${center.lat},${center.lng});
  way["amenity"~"${query}",i](around:${radiusMeters},${center.lat},${center.lng});
);
out center 50;`;

                    const overpassUrl = 'https://overpass-api.de/api/interpreter';
                    const response = await fetch(overpassUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: 'data=' + encodeURIComponent(overpassQuery)
                    });

                    if (!response.ok) {
                        throw new Error(`API retornou status ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.elements || data.elements.length === 0) {
                        document.getElementById('searchStatus').textContent = `‚ùå Nenhum resultado para "${query}"`;
                        return;
                    }

                    // Filter and process results
                    let processedCount = 0;
                    const maxResults = 50;

                    data.elements.forEach((element, idx) => {
                        if (processedCount >= maxResults) return;

                        let lat, lon, name, type;

                        // Get coordinates
                        if (element.lat && element.lon) {
                            lat = element.lat;
                            lon = element.lon;
                        } else if (element.center) {
                            lat = element.center.lat;
                            lon = element.center.lon;
                        } else {
                            return; // Skip if no coordinates
                        }

                        // Get name and type
                        name = element.tags?.name || element.tags?.shop || element.tags?.amenity || 'Local';
                        type = element.tags?.shop || element.tags?.amenity || element.type;

                        // Create custom icon
                        const icon = L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        });

                        // Create marker
                        const searchMarker = L.marker([lat, lon], { icon: icon }).addTo(map);

                        // Create popup content
                        const popupContent = `
                            <div class="text-sm">
                                <strong>${name}</strong><br/>
                                ${type ? `<span class="badge badge-sm badge-ghost">${type}</span><br/>` : ''}
                                ${element.tags?.['addr:street'] ? `üìç ${element.tags['addr:street']}${element.tags['addr:housenumber'] ? ', ' + element.tags['addr:housenumber'] : ''}<br/>` : ''}
                                ${element.tags?.phone ? `üìû ${element.tags.phone}<br/>` : ''}
                                ${element.tags?.website ? `<a href="${element.tags.website}" target="_blank" class="link link-primary">Website</a>` : ''}
                            </div>
                        `;

                        searchMarker.bindPopup(popupContent);
                        searchMarkers.push(searchMarker);
                        processedCount++;
                    });

                    if (processedCount === 0) {
                        document.getElementById('searchStatus').textContent = `‚ùå Nenhum resultado para "${query}"`;
                    } else {
                        document.getElementById('searchStatus').textContent = `‚úÖ ${processedCount} resultado(s) encontrado(s)`;

                        // Fit map to show all markers
                        const group = L.featureGroup([marker, ...searchMarkers]);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }

                } catch (e) {
                    console.error('Search error:', e);
                    document.getElementById('searchStatus').textContent = '‚ùå Erro: ' + e.message;
                }
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', () => {
                initMap();
                document.getElementById('searchRadius').addEventListener('input', updateRadius);

                // Enable Enter key to trigger search
                document.getElementById('searchQuery').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performSearch();
                    }
                });
            });
        </script>

        <%- include('partials/footer') %>